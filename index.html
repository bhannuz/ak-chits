<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AK Chit Funds - Admin Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --bg-dark:#0a0e1a; --card-bg:#141b2d; --input-bg:#1c253b; --accent-gold:linear-gradient(90deg,#ff9800,#f57c00); --text-main:#ffffff; --text-dim:#8e9aaf; --border:#252f48; }
        body { background-color:var(--bg-dark); color:var(--text-main); font-family:'Segoe UI',sans-serif; padding-bottom:120px; }
        .app-header { display:flex; justify-content:space-between; align-items:center; padding:20px; border-bottom:1px solid var(--border); }
        .brand { color:#f39c12; font-weight:bold; font-size:1.4rem; }
        .stat-card { background:var(--card-bg); border:1px solid var(--border); border-radius:15px; padding:15px; text-align:center; }
        .stat-num { font-size:1.4rem; font-weight:bold; display:block; }
        .stat-label { font-size:0.7rem; color:var(--text-dim); text-transform:uppercase; }
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; padding:20px; overflow-y:auto; }
        .modal-content-custom { background:var(--card-bg); border-radius:25px; padding:25px; max-width:450px; margin:20px auto; border:1px solid var(--border); }
        .form-input { background:var(--input-bg); border:1px solid var(--border); color:white; padding:12px; border-radius:12px; width:100%; margin-bottom:12px; }
        .form-input option { background:#1c253b; }
        .btn-save { background:var(--accent-gold); color:black; border:none; width:100%; padding:15px; border-radius:15px; font-weight:bold; margin-bottom:10px; cursor:pointer; }
        .btn-cancel { background:var(--input-bg); color:white; border:none; width:100%; padding:12px; border-radius:15px; cursor:pointer; }
        .nav-bar { position:fixed; bottom:0; width:100%; background:#070b14; display:flex; justify-content:space-around; padding:15px; border-top:1px solid var(--border); z-index:1000; }
        .nav-item { cursor:pointer; text-align:center; font-size:0.65rem; color:var(--text-dim); }
        .nav-item.active { color:#f39c12; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .table-custom { color:white; font-size:0.72rem; width:100%; border-collapse:collapse; }
        .table-custom th { color:var(--text-dim); border-bottom:1px solid var(--border); padding:8px 5px; font-size:0.65rem; text-transform:uppercase; }
        .table-custom td { padding:9px 5px; border-bottom:1px solid rgba(255,255,255,0.05); vertical-align:middle; }
        .table-custom tr.chit-picked { background:rgba(16,185,129,0.08); }
        .table-custom tr.chit-picked td:first-child { border-left:3px solid #10b981; }
        .chit-yes-badge { display:inline-block; background:rgba(16,185,129,0.2); color:#34d399; border:1px solid rgba(16,185,129,0.4); border-radius:5px; padding:2px 7px; font-size:0.6rem; font-weight:800; }
        .chit-no { color:var(--text-dim); font-size:0.65rem; }
        .suggestions-list { position:absolute; top:100%; left:0; right:0; background:var(--input-bg); border:1px solid var(--border); border-radius:0 0 12px 12px; z-index:3000; max-height:200px; overflow-y:auto; display:none; margin-top:-12px; }
        .suggestion-item { padding:12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.9rem; }
        .suggestion-item:hover { background:#252f48; color:#f39c12; }
        .list-group-header { background:#1c253b; padding:12px 15px; border-radius:10px; margin-top:15px; font-weight:bold; color:#f39c12; border-left:4px solid #f39c12; display:flex; justify-content:space-between; align-items:center; }
        .group-checkbox-area { max-height:150px; overflow-y:auto; background:var(--input-bg); padding:10px; border-radius:12px; border:1px solid var(--border); margin-bottom:15px; }
        .months-badge { display:inline-flex; align-items:center; gap:5px; background:rgba(99,102,241,.15); border:1px solid rgba(99,102,241,.3); border-radius:8px; padding:4px 10px; font-size:0.75rem; font-weight:700; color:#a5b4fc; margin-top:6px; }
        .btn-pdf { background:linear-gradient(135deg,#e74c3c,#c0392b); color:white; border:none; border-radius:10px; padding:8px 14px; font-size:0.78rem; font-weight:700; cursor:pointer; }
        .summary-stat-row { display:flex; justify-content:space-between; padding:9px 0; border-bottom:1px solid var(--border); font-size:0.85rem; }
        .summary-stat-row:last-child { border-bottom:none; }
        .sk { color:var(--text-dim); }
        .sv { font-weight:700; }

        /* ‚ïê‚ïê PDF STYLES ‚ïê‚ïê */
        #pdf-template { display:none; }
        .pdf-page { background:white; color:#111; padding:36px 40px; font-family:'Segoe UI',Arial,sans-serif; width:750px; }
        .pdf-header { display:flex; justify-content:space-between; align-items:flex-start; border-bottom:4px solid #f39c12; padding-bottom:14px; margin-bottom:20px; }
        .pdf-brand { font-size:26px; font-weight:900; color:#f39c12; }
        .pdf-brand-sub { font-size:11px; color:#888; margin-top:2px; }
        .pdf-right-title { font-size:16px; font-weight:800; text-align:right; }
        .pdf-right-sub { font-size:11px; color:#888; text-align:right; margin-top:3px; }
        .pdf-member-box { background:#fffbf0; border:2px solid #f39c12; border-radius:12px; padding:16px 20px; margin-bottom:20px; }
        .pdf-member-name { font-size:20px; font-weight:800; }
        .pdf-member-sub { font-size:12px; color:#555; margin-top:4px; }
        .pdf-stats-row { display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
        .pdf-stat-box { flex:1; min-width:100px; border:1px solid #ddd; border-radius:8px; padding:10px; text-align:center; background:white; }
        .pdf-stat-val { font-size:15px; font-weight:800; }
        .pdf-stat-lbl { font-size:9px; color:#888; text-transform:uppercase; letter-spacing:.4px; margin-top:2px; }
        .pdf-section-title { font-size:11px; font-weight:800; color:#888; text-transform:uppercase; letter-spacing:1px; margin:20px 0 8px; border-bottom:1px solid #eee; padding-bottom:6px; }
        .pdf-group-title { font-size:13px; font-weight:800; margin-bottom:6px; color:#111; }
        .pdf-progress-outer { background:#eee; border-radius:5px; height:8px; margin-bottom:4px; overflow:hidden; }
        .pdf-progress-inner { height:100%; background:linear-gradient(90deg,#f39c12,#f57c00); border-radius:5px; }
        .pdf-progress-label { font-size:10px; color:#888; text-align:right; margin-bottom:12px; }
        .pdf-table { width:100%; border-collapse:collapse; font-size:11px; margin-bottom:20px; }
        .pdf-table th { background:#f5f5f5; border:1px solid #ccc; padding:7px 9px; font-size:9px; text-transform:uppercase; color:#555; text-align:left; }
        .pdf-table td { border:1px solid #ddd; padding:7px 9px; }
        .pdf-table tr:nth-child(even) td { background:#fafafa; }
        .pdf-table tr.pdf-chit-row td { background:#f0fff8 !important; }
        .pdf-table tr.pdf-chit-row td:first-child { border-left:3px solid #10b981; }
        .pdf-chit-badge { background:#d1fae5; color:#065f46; border-radius:4px; padding:2px 6px; font-size:9px; font-weight:800; }
        .pdf-total-row td { background:#fff8e1 !important; font-weight:800; border-top:2px solid #f39c12; }
        .pdf-footer { margin-top:24px; border-top:1px solid #ddd; padding-top:12px; display:flex; justify-content:space-between; font-size:10px; color:#aaa; }
    </style>
</head>
<body>

<div class="container py-2">
    <div class="app-header">
        <div class="brand">üèÜ AK Chit Funds <small style="font-size:0.5em;color:#2ecc71;">‚òÅ CLOUD</small></div>
        <span class="badge text-warning border border-warning px-2">ADMIN</span>
    </div>

    <!-- HOME TAB -->
    <div id="homeTab" class="tab-content active">
        <div class="row g-2 mt-4 text-center">
            <div class="col-4"><div class="stat-card"><span class="stat-num" id="memberCount">-</span><span class="stat-label">Members</span></div></div>
            <div class="col-4"><div class="stat-card"><span class="stat-num" id="groupCount">-</span><span class="stat-label">Groups</span></div></div>
            <div class="col-4"><div class="stat-card"><span class="stat-num text-success" id="todayColl">‚Çπ0</span><span class="stat-label">Today</span></div></div>
        </div>
        <button class="btn btn-warning w-100 py-3 mt-4 fw-bold shadow" onclick="openModal('paymentModal')" style="border-radius:20px;">üí≥ Record Payment</button>
        <div class="p-3 my-4" style="background:var(--card-bg);border-radius:20px;border:1px solid var(--border);">
            <div style="position:relative;">
                <input type="text" id="summarySearch" class="form-input" placeholder="üîç Search Member for Summary / PDF..." oninput="filterSearch('summarySearch','summaryList','summaryView')">
                <input type="hidden" id="summaryView">
                <div id="summaryList" class="suggestions-list"></div>
            </div>
            <div id="ledgerData"></div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary w-100 py-3" onclick="openAddMember()">‚ûï Member</button>
            <button class="btn btn-outline-secondary w-100 py-3" onclick="openAddGroup()">üè¶ Group</button>
        </div>
    </div>

    <!-- GROUPS TAB -->
    <div id="groupsTab" class="tab-content"><div id="groupListArea" class="mt-3"></div></div>

    <!-- LIST TAB -->
    <div id="listTab" class="tab-content"><div id="simpleListArea"></div></div>

    <!-- BACKUP TAB -->
    <div id="backupTab" class="tab-content">
        <h5 class="mt-4 mb-3 text-warning text-center">Data Management</h5>
        <div class="stat-card p-4">
            <button class="btn btn-warning w-100 py-3 mb-4 fw-bold" onclick="exportFullBackup()">üíæ Download JSON Backup</button>
            <hr style="border-color:var(--border);">
            <div class="small mb-2" style="color:var(--text-dim);">Upload Backup to Restore:</div>
            <input type="file" id="restoreFile" class="form-control mb-2 bg-dark text-white border-secondary" accept=".json">
            <button class="btn btn-outline-info w-100 py-3" onclick="restoreFromJSON()">üîÑ Restore from File</button>
        </div>
    </div>
</div>

<!-- PDF TEMPLATE (hidden) -->
<div id="pdf-template">
    <div class="pdf-page" id="pdfContent"></div>
</div>

<!-- MEMBER MODAL -->
<div id="memberModal" class="modal-overlay">
    <div class="modal-content-custom">
        <div class="fw-bold mb-3" id="memberModalTitle">Member Settings</div>
        <input type="hidden" id="editMemberId">
        <input type="text" id="mName" class="form-input" placeholder="Full Name">
        <input type="text" id="mPhone" class="form-input" placeholder="Phone No">
        <div class="small mb-2" style="color:var(--text-dim);">Assign to Groups:</div>
        <div id="groupCheckboxes" class="group-checkbox-area"></div>
        <div id="deleteMemberArea" style="display:none;">
            <button class="btn btn-danger w-100 mb-3 py-2 fw-bold" onclick="deleteMemberFromModal()">üóë Delete Member</button>
        </div>
        <button class="btn-save" onclick="saveMember()">Save Member</button>
        <button class="btn-cancel" onclick="closeModal('memberModal')">Cancel</button>
    </div>
</div>

<!-- GROUP MODAL -->
<div id="groupModal" class="modal-overlay">
    <div class="modal-content-custom">
        <div class="fw-bold mb-3">Group Details</div>
        <input type="hidden" id="editGroupId">
        <input type="text" id="gName" class="form-input" placeholder="Group Name">
        <input type="number" id="gDuration" class="form-input" placeholder="Duration (Months)">
        <input type="date" id="gStart" class="form-input">
        <button class="btn-save" onclick="saveGroup()">Save Group</button>
        <button class="btn-cancel" onclick="closeModal('groupModal')">Cancel</button>
    </div>
</div>

<!-- PAYMENT MODAL -->
<div id="paymentModal" class="modal-overlay">
    <div class="modal-content-custom">
        <div class="fw-bold mb-3">üí≥ Record Payment</div>
        <input type="date" id="pDate" class="form-input">
        <div style="position:relative;">
            <input type="text" id="pMemberSearch" class="form-input" placeholder="üîç Search Member..." oninput="filterSearch('pMemberSearch','pMemberList','pMember')">
            <input type="hidden" id="pMember">
            <div id="pMemberList" class="suggestions-list"></div>
        </div>
        <select id="pGroup" class="form-input"><option value="">-- Select Member First --</option></select>
        <div class="row g-2">
            <div class="col-6"><input type="number" id="pChit" class="form-input" placeholder="Chit Amt" oninput="calcBalance()"></div>
            <div class="col-6"><input type="number" id="pPaid" class="form-input" placeholder="Paid Amt" oninput="calcBalance()"></div>
        </div>
        <input type="number" id="pBal" class="form-input" placeholder="Balance" readonly>
        <select id="pPaidBy" class="form-input">
            <option value="">-- Paid By --</option>
            <option>UPI</option><option>GPay</option><option>PhonePe</option>
            <option>PPay</option><option>Bank Transfer</option><option>Cash</option><option>Cheque</option>
        </select>
        <select id="pChitPicked" class="form-input" onchange="toggleChitPickedName()">
            <option value="No">Chit Picked: No</option>
            <option value="Yes">Chit Picked: Yes ‚úÖ</option>
        </select>
        <div id="chitPickedNameDiv" style="display:none;">
            <input type="text" id="pChitPickedBy" class="form-input" placeholder="Picked by (member name)">
        </div>
        <button class="btn-save" onclick="savePayment()">‚úì Sync Payment</button>
        <button class="btn-cancel" onclick="closeModal('paymentModal')">Cancel</button>
    </div>
</div>

<!-- BOTTOM NAV -->
<div class="nav-bar">
    <div class="nav-item active" id="navHome" onclick="switchTab('home')">üè†<br>Home</div>
    <div class="nav-item" id="navGroups" onclick="switchTab('groups')">üìÅ<br>Groups</div>
    <div class="nav-item" id="navList" onclick="switchTab('list')">üìú<br>List</div>
    <div class="nav-item" id="navBackup" onclick="switchTab('backup')">üíæ<br>Backup</div>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyB9_sBL83skvIaOVAE8msHwIWq8QQwhxFU",authDomain:"ak-chit-funds.firebaseapp.com",projectId:"ak-chit-funds",storageBucket:"ak-chit-funds.firebasestorage.app",messagingSenderId:"297195194526",appId:"1:297195194526:web:b71c7c09dcf8610211938f"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
let ALL_MEMBERS=[];

async function getCollection(col){const s=await db.collection(col).get();return s.docs.map(d=>({id:d.id,...d.data()}));}
function fmtDate(d){if(!d)return"‚Äî";const[y,m,day]=d.split("-");return`${day}/${m}/${y}`;}
function fmtAmt(v){return'‚Çπ'+(parseFloat(v)||0).toLocaleString('en-IN');}
function ini(n){return(n||'?').split(' ').map(x=>x[0]||'').join('').toUpperCase().slice(0,2)||'??';}
function openModal(id){document.getElementById(id).style.display='block';}
function closeModal(id){document.getElementById(id).style.display='none';}
function calcBalance(){document.getElementById('pBal').value=(parseFloat(document.getElementById('pChit').value)||0)-(parseFloat(document.getElementById('pPaid').value)||0);}
function toggleChitPickedName(){document.getElementById('chitPickedNameDiv').style.display=document.getElementById('pChitPicked').value==='Yes'?'block':'none';}
function showToast(msg,ok=true){const t=document.createElement('div');t.style.cssText=`position:fixed;top:20px;left:50%;transform:translateX(-50%);background:${ok?'#10b981':'#ef4444'};color:white;padding:12px 24px;border-radius:12px;font-weight:700;font-size:13px;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,.4);`;t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3000);}

function switchTab(t){
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
    document.getElementById(t+'Tab').classList.add('active');
    document.getElementById('nav'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');
    updateUI();
}

async function migrateData(){
    const ms=await getCollection('members');
    for(let m of ms){if(m.groupId&&!m.groupIds){await db.collection('members').doc(m.id).update({groupIds:[m.groupId],groupId:firebase.firestore.FieldValue.delete()});}}
    updateUI();
}

async function updateUI(){
    const m=await getCollection('members');const g=await getCollection('groups');const p=await getCollection('payments');
    ALL_MEMBERS=m;
    document.getElementById('memberCount').innerText=m.length;
    document.getElementById('groupCount').innerText=g.length;
    const today=new Date().toISOString().split('T')[0];
    document.getElementById('todayColl').innerText=fmtAmt(p.filter(x=>x.date===today).reduce((s,x)=>s+(parseFloat(x.paid)||0),0));
    if(document.getElementById('groupsTab').classList.contains('active'))renderGroupsTab();
    if(document.getElementById('listTab').classList.contains('active'))renderListTab();
}

function filterSearch(inputId,listId,hiddenId){
    const query=document.getElementById(inputId).value.toLowerCase();
    const list=document.getElementById(listId);
    list.innerHTML='';if(!query){list.style.display='none';return;}
    const filtered=ALL_MEMBERS.filter(m=>m.name.toLowerCase().includes(query));
    if(filtered.length>0){
        list.style.display='block';
        filtered.forEach(m=>{const div=document.createElement('div');div.className='suggestion-item';div.innerText=m.name;
            div.onclick=()=>{document.getElementById(inputId).value=m.name;document.getElementById(hiddenId).value=m.id;list.style.display='none';
                if(hiddenId==='summaryView')loadMemberLedger();if(hiddenId==='pMember')linkGroupForPayment();};
            list.appendChild(div);});
    }else{list.style.display='none';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEMBER LEDGER ‚Äî FULL SUMMARY ON HOME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadMemberLedger(){
    const mid=document.getElementById('summaryView').value;if(!mid)return;
    const ms=await getCollection('members');const gs=await getCollection('groups');const ps=await getCollection('payments');
    const m=ms.find(x=>x.id===mid);if(!m)return;
    const mPays=ps.filter(p=>p.memberId===mid);
    const totalPaid=mPays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
    const totalBal=mPays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
    const chitsPicked=mPays.filter(p=>p.chitPicked==='Yes').length;
    const memberGroups=gs.filter(g=>m.groupIds&&m.groupIds.includes(g.id));
    const lastPay=[...mPays].sort((a,b)=>(b.date||'').localeCompare(a.date||''))[0];

    // months left
    const monthsHtml=memberGroups.map(g=>{
        if(!g.startDate&&!g.gStart)return'';
        const totalMonths=parseInt(g.duration||g.gDuration)||21;
        const elapsed=Math.max(0,Math.min(totalMonths,Math.floor((new Date()-new Date(g.startDate||g.gStart))/(1000*60*60*24*30.44))));
        const left=Math.max(0,totalMonths-elapsed);
        const pct=Math.min(100,Math.round(elapsed/totalMonths*100));
        return`<div style="margin-top:10px;">
            <div style="font-size:0.72rem;color:var(--text-dim);margin-bottom:4px;">${g.name}</div>
            <div style="background:#252f48;border-radius:5px;height:6px;overflow:hidden;margin-bottom:4px;">
              <div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#f39c12,#f57c00);border-radius:5px;"></div>
            </div>
            <span class="months-badge">‚è≥ ${left} months left ¬∑ Month ${elapsed}/${totalMonths}</span>
        </div>`;
    }).join('');

    // payment tables grouped by group
    const grouped={};
    mPays.forEach(p=>{const gid=p.groupId||'unknown';if(!grouped[gid])grouped[gid]=[];grouped[gid].push(p);});
    const payTablesHtml=Object.entries(grouped).map(([gid,pays])=>{
        const grp=gs.find(g=>g.id===gid);
        pays.sort((a,b)=>(a.date||'').localeCompare(b.date||''));
        const rows=pays.map((p,i)=>{
            const cp=p.chitPicked==='Yes';
            return`<tr class="${cp?'chit-picked':''}">
                <td style="color:var(--text-dim);">${i+1}</td>
                <td>${fmtDate(p.date)}</td>
                <td style="color:#a5b4fc;">${fmtAmt(p.chit)}</td>
                <td style="color:#34d399;font-weight:700;">${fmtAmt(p.paid)}</td>
                <td style="color:#f59e0b;">${fmtAmt(p.balance)}</td>
                <td style="color:var(--text-dim);font-size:0.6rem;">${p.paidBy||'‚Äî'}</td>
                <td>${cp?'<span class="chit-yes-badge">‚úÖ Yes</span>':'<span class="chit-no">No</span>'}</td>
            </tr>`;}).join('');
        const tPaid=pays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
        const tBal=pays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
        return`<div style="margin-bottom:14px;">
            <div style="font-size:0.7rem;font-weight:700;color:#f39c12;text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;">üìÇ ${grp?grp.name:'Unknown Group'}</div>
            <div style="overflow-x:auto;"><table class="table-custom">
                <thead><tr><th>#</th><th>Date</th><th>Chit Val</th><th>Paid</th><th>Balance</th><th>Paid By</th><th>Chit?</th></tr></thead>
                <tbody>${rows}
                <tr style="font-weight:800;background:rgba(255,255,255,.04);">
                    <td colspan="3" style="color:var(--text-dim);">Total</td>
                    <td style="color:#34d399;">${fmtAmt(tPaid)}</td>
                    <td style="color:#f59e0b;">${fmtAmt(tBal)}</td>
                    <td colspan="2"></td>
                </tr></tbody>
            </table></div>
        </div>`;
    }).join('');

    document.getElementById('ledgerData').innerHTML=`
        <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px;">
            <div style="width:50px;height:50px;border-radius:14px;background:rgba(243,156,18,.15);border:2px solid rgba(243,156,18,.4);color:#f39c12;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;flex-shrink:0;">${ini(m.name)}</div>
            <div style="flex:1;">
                <div style="font-size:1rem;font-weight:800;">${m.name}</div>
                <div style="font-size:0.75rem;color:var(--text-dim);">${m.phone||'No phone'} ¬∑ ${mPays.length} payments</div>
                <div style="font-size:0.7rem;color:var(--text-dim);margin-top:2px;">${memberGroups.map(g=>g.name).join(', ')||'No group'}</div>
            </div>
            <button class="btn-pdf" onclick="generateMemberPDF('${mid}')">üìÑ PDF</button>
        </div>
        <div class="row g-2 mb-3">
            <div class="col-6"><div style="background:#1c253b;border-radius:12px;padding:12px;border-top:2px solid #34d399;">
                <div style="font-size:0.6rem;color:var(--text-dim);text-transform:uppercase;">Total Paid</div>
                <div style="font-size:1.1rem;font-weight:800;color:#34d399;">${fmtAmt(totalPaid)}</div>
            </div></div>
            <div class="col-6"><div style="background:#1c253b;border-radius:12px;padding:12px;border-top:2px solid #f59e0b;">
                <div style="font-size:0.6rem;color:var(--text-dim);text-transform:uppercase;">Total Balance</div>
                <div style="font-size:1.1rem;font-weight:800;color:#f59e0b;">${fmtAmt(totalBal)}</div>
            </div></div>
        </div>
        ${monthsHtml?`<div style="background:#1c253b;border-radius:12px;padding:14px;margin-bottom:14px;">${monthsHtml}</div>`:''}
        ${payTablesHtml||'<div style="text-align:center;color:var(--text-dim);padding:20px;">No payments yet</div>'}
    `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF GENERATION ‚Äî MEMBER STATEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateMemberPDF(mid){
    showToast('‚è≥ Generating PDF‚Ä¶',true);
    const ms=await getCollection('members');const gs=await getCollection('groups');const ps=await getCollection('payments');
    const m=ms.find(x=>x.id===mid);if(!m)return;
    const mPays=ps.filter(p=>p.memberId===mid);
    const totalPaid=mPays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
    const totalBal=mPays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
    const chitsPicked=mPays.filter(p=>p.chitPicked==='Yes').length;
    const memberGroups=gs.filter(g=>m.groupIds&&m.groupIds.includes(g.id));
    const today=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});

    // build grouped payment sections
    const grouped={};
    mPays.forEach(p=>{const gid=p.groupId||'unk';if(!grouped[gid])grouped[gid]=[];grouped[gid].push(p);});

    const groupSections=memberGroups.map(g=>{
        const pays=(grouped[g.id]||[]).sort((a,b)=>(a.date||'').localeCompare(b.date||''));
        const totalMonths=parseInt(g.duration||g.gDuration)||21;
        let elapsed=0;
        if(g.startDate||g.gStart){elapsed=Math.max(0,Math.min(totalMonths,Math.floor((new Date()-new Date(g.startDate||g.gStart))/(1000*60*60*24*30.44))));}
        const left=Math.max(0,totalMonths-elapsed);
        const pct=Math.min(100,Math.round(elapsed/totalMonths*100));
        const gPaid=pays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
        const gBal=pays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
        const gPicked=pays.filter(p=>p.chitPicked==='Yes').length;
        const rows=pays.map((p,i)=>{
            const cp=p.chitPicked==='Yes';
            return`<tr class="${cp?'pdf-chit-row':''}">
                <td>${i+1}</td>
                <td>${fmtDate(p.date)}</td>
                <td>‚Çπ${(parseFloat(p.chit)||0).toLocaleString('en-IN')}</td>
                <td style="color:#065f46;font-weight:700;">‚Çπ${(parseFloat(p.paid)||0).toLocaleString('en-IN')}</td>
                <td style="color:#92400e;font-weight:700;">‚Çπ${(parseFloat(p.balance)||0).toLocaleString('en-IN')}</td>
                <td>${p.paidBy||'‚Äî'}</td>
                <td>${cp?`<span class="pdf-chit-badge">‚úÖ PICKED${p.chitPickedBy?' by '+p.chitPickedBy:''}</span>`:'‚Äî'}</td>
            </tr>`;}).join('');
        const totalRow=`<tr class="pdf-total-row"><td colspan="3"><strong>TOTAL</strong></td><td><strong>‚Çπ${gPaid.toLocaleString('en-IN')}</strong></td><td><strong>‚Çπ${gBal.toLocaleString('en-IN')}</strong></td><td colspan="2">${gPicked>0?gPicked+' chit(s) picked':'‚Äî'}</td></tr>`;
        return`<div style="margin-bottom:22px;">
            <div class="pdf-group-title">üìÇ ${g.name}</div>
            <div style="display:flex;justify-content:space-between;font-size:10px;color:#888;margin-bottom:4px;">
                <span>Month ${elapsed} of ${totalMonths} ¬∑ ${left} months remaining</span><span>${pct}% complete</span>
            </div>
            <div class="pdf-progress-outer"><div class="pdf-progress-inner" style="width:${pct}%"></div></div>
            <div style="font-size:10px;color:#888;text-align:right;margin-bottom:10px;">Collected: ‚Çπ${gPaid.toLocaleString('en-IN')} ¬∑ Balance: ‚Çπ${gBal.toLocaleString('en-IN')}</div>
            ${pays.length?`<table class="pdf-table">
                <thead><tr><th>#</th><th>Date</th><th>Chit Value</th><th>Amount Paid</th><th>Balance</th><th>Paid By</th><th>Chit Picked</th></tr></thead>
                <tbody>${rows}${totalRow}</tbody>
            </table>`:'<p style="color:#888;font-size:11px;">No payments for this group.</p>'}
        </div>`;
    }).join('');

    // ungrouped payments (no matching group)
    const unknownPays=(grouped['unk']||[]);
    const unknownSection=unknownPays.length?`<div style="margin-bottom:22px;">
        <div class="pdf-group-title">üìÇ Other Payments</div>
        <table class="pdf-table"><thead><tr><th>#</th><th>Date</th><th>Chit Val</th><th>Paid</th><th>Balance</th><th>Paid By</th><th>Chit?</th></tr></thead>
        <tbody>${unknownPays.map((p,i)=>`<tr><td>${i+1}</td><td>${fmtDate(p.date)}</td><td>‚Çπ${(parseFloat(p.chit)||0).toLocaleString('en-IN')}</td><td>‚Çπ${(parseFloat(p.paid)||0).toLocaleString('en-IN')}</td><td>‚Çπ${(parseFloat(p.balance)||0).toLocaleString('en-IN')}</td><td>${p.paidBy||'‚Äî'}</td><td>‚Äî</td></tr>`).join('')}</tbody>
        </table></div>`:'';

    document.getElementById('pdfContent').innerHTML=`
        <div class="pdf-header">
            <div>
                <div class="pdf-brand">üèÜ AK CHIT FUNDS</div>
                <div class="pdf-brand-sub">Chit Fund Management ¬∑ Admin Report</div>
            </div>
            <div>
                <div class="pdf-right-title">MEMBER STATEMENT</div>
                <div class="pdf-right-sub">Generated: ${today}</div>
            </div>
        </div>

        <div class="pdf-member-box">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
                <div>
                    <div class="pdf-member-name">${m.name}</div>
                    <div class="pdf-member-sub">üìû ${m.phone||'No phone'}</div>
                    <div class="pdf-member-sub">üìÇ Groups: ${memberGroups.map(g=>g.name).join(', ')||'‚Äî'}</div>
                </div>
                <div class="pdf-stats-row">
                    <div class="pdf-stat-box"><div class="pdf-stat-val" style="color:#065f46;">‚Çπ${totalPaid.toLocaleString('en-IN')}</div><div class="pdf-stat-lbl">Total Paid</div></div>
                    <div class="pdf-stat-box"><div class="pdf-stat-val" style="color:#92400e;">‚Çπ${totalBal.toLocaleString('en-IN')}</div><div class="pdf-stat-lbl">Balance</div></div>
                    <div class="pdf-stat-box"><div class="pdf-stat-val">${mPays.length}</div><div class="pdf-stat-lbl">Payments</div></div>
                    <div class="pdf-stat-box"><div class="pdf-stat-val" style="color:#065f46;">${chitsPicked}</div><div class="pdf-stat-lbl">Chits Picked</div></div>
                </div>
            </div>
        </div>

        <div class="pdf-section-title">Payment History ‚Äî Group Wise</div>
        ${groupSections||''}
        ${unknownSection}

        <div class="pdf-footer">
            <span>AK Chit Funds ¬∑ Admin Portal</span>
            <span>Member: ${m.name} ¬∑ ${today}</span>
            <span>CONFIDENTIAL</span>
        </div>
    `;

    const el=document.getElementById('pdf-template');
    el.style.display='block';
    const opt={margin:[8,8],filename:`AKChitFunds_${m.name.replace(/\s+/g,'_')}_Statement.pdf`,image:{type:'jpeg',quality:0.98},html2canvas:{scale:2,useCORS:true},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
    setTimeout(()=>{
        html2pdf().set(opt).from(document.getElementById('pdfContent')).save().then(()=>{
            el.style.display='none';showToast('‚úÖ PDF Downloaded!',true);
        });
    },400);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEMBER CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openAddMember(){
    document.getElementById('editMemberId').value='';document.getElementById('mName').value='';document.getElementById('mPhone').value='';
    document.getElementById('memberModalTitle').textContent='‚ûï New Member';document.getElementById('deleteMemberArea').style.display='none';
    const gs=await getCollection('groups');
    document.getElementById('groupCheckboxes').innerHTML=gs.map(g=>`<div class="d-flex gap-2 align-items-center p-1"><input type="checkbox" class="group-cb" value="${g.id}" style="accent-color:#f39c12;"> <span>${g.name}</span></div>`).join('');
    openModal('memberModal');
}
async function saveMember(){
    const n=document.getElementById('mName').value.trim();const p=document.getElementById('mPhone').value.trim();
    const eid=document.getElementById('editMemberId').value;
    const gids=Array.from(document.querySelectorAll('.group-cb:checked')).map(cb=>cb.value);
    if(!n||gids.length===0)return showToast('‚ùå Enter Name and select a Group!',false);
    if(eid)await db.collection('members').doc(eid).update({name:n,phone:p,groupIds:gids});
    else await db.collection('members').add({name:n,phone:p,groupIds:gids});
    closeModal('memberModal');showToast(`‚úÖ "${n}" saved!`);updateUI();
}
async function deleteMemberFromModal(){
    const eid=document.getElementById('editMemberId').value;if(!eid)return;
    if(!confirm('Delete this member?'))return;
    await db.collection('members').doc(eid).delete();closeModal('memberModal');showToast('üóë Member deleted');updateUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GROUP CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddGroup(){document.getElementById('editGroupId').value='';document.getElementById('gName').value='';document.getElementById('gDuration').value='';document.getElementById('gStart').value='';openModal('groupModal');}
async function saveGroup(){
    const name=document.getElementById('gName').value.trim();const duration=document.getElementById('gDuration').value;const startDate=document.getElementById('gStart').value;const eid=document.getElementById('editGroupId').value;
    if(!name)return showToast('‚ùå Enter group name',false);
    if(eid)await db.collection('groups').doc(eid).update({name,duration,startDate});
    else await db.collection('groups').add({name,duration,startDate});
    closeModal('groupModal');showToast(`‚úÖ Group "${name}" saved!`);updateUI();
}
async function openEditGroup(gid){
    const gs=await getCollection('groups');const g=gs.find(x=>x.id===gid);if(!g)return;
    document.getElementById('editGroupId').value=g.id;document.getElementById('gName').value=g.name||'';
    document.getElementById('gDuration').value=g.duration||g.gDuration||'';document.getElementById('gStart').value=g.startDate||g.gStart||'';
    openModal('groupModal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAYMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function linkGroupForPayment(){
    const mid=document.getElementById('pMember').value;
    const ms=await getCollection('members');const m=ms.find(x=>x.id===mid);if(!m)return;
    const gs=await getCollection('groups');
    document.getElementById('pGroup').innerHTML=gs.filter(g=>m.groupIds&&m.groupIds.includes(g.id)).map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
}
async function savePayment(){
    const mid=document.getElementById('pMember').value;const gid=document.getElementById('pGroup').value;
    const date=document.getElementById('pDate').value;const chit=parseFloat(document.getElementById('pChit').value)||0;
    const paid=parseFloat(document.getElementById('pPaid').value)||0;const balance=parseFloat(document.getElementById('pBal').value)||0;
    const paidBy=document.getElementById('pPaidBy').value;const chitPicked=document.getElementById('pChitPicked').value;
    const chitPickedBy=document.getElementById('pChitPickedBy').value.trim();
    if(!mid||!gid||!date||!paid)return showToast('‚ùå Fill all required fields',false);
    await db.collection('payments').add({memberId:mid,groupId:gid,date,chit,paid,balance,paidBy,chitPicked,chitPickedBy});
    closeModal('paymentModal');showToast('‚úÖ Payment saved!');updateUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GROUPS TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderGroupsTab(){
    const gs=await getCollection('groups');const ms=await getCollection('members');const ps=await getCollection('payments');
    document.getElementById('groupListArea').innerHTML=gs.map(g=>{
        const gMs=ms.filter(m=>m.groupIds&&m.groupIds.includes(g.id));
        const gPays=ps.filter(p=>p.groupId===g.id);
        const tPaid=gPays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
        const tBal=gPays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
        const picked=gPays.filter(p=>p.chitPicked==='Yes').length;
        const totalMonths=parseInt(g.duration||g.gDuration)||21;
        let elapsed=0;if(g.startDate||g.gStart){elapsed=Math.max(0,Math.min(totalMonths,Math.floor((new Date()-new Date(g.startDate||g.gStart))/(1000*60*60*24*30.44))));}
        const left=Math.max(0,totalMonths-elapsed);const pct=Math.min(100,Math.round(elapsed/totalMonths*100));
        const memberRows=gMs.map((m,i)=>{
            const mp=ps.filter(p=>p.memberId===m.id&&p.groupId===g.id);
            const paid=mp.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);const bal=mp.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
            const mpicked=mp.filter(p=>p.chitPicked==='Yes').length;
            return`<tr><td>${i+1}</td><td><strong>${m.name}</strong><br><span style="font-size:0.6rem;color:var(--text-dim);">${m.phone||''}</span></td>
                <td style="color:#34d399;">${fmtAmt(paid)}</td><td style="color:#f59e0b;">${fmtAmt(bal)}</td>
                <td>${mpicked>0?`<span class="chit-yes-badge">‚úÖ ${mpicked}x</span>`:'<span class="chit-no">‚Äî</span>'}</td>
            </tr>`;}).join('');
        return`<div style="background:var(--card-bg);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div><div style="font-size:1rem;font-weight:800;color:#f39c12;">üìÇ ${g.name}</div>
                <div style="font-size:0.7rem;color:var(--text-dim);">${gMs.length} members ¬∑ ${gPays.length} payments</div></div>
                <div style="display:flex;gap:8px;">
                    <button onclick="generateGroupPDF('${g.id}')" style="background:linear-gradient(135deg,#e74c3c,#c0392b);color:white;border:none;border-radius:8px;padding:6px 12px;font-size:0.72rem;font-weight:700;cursor:pointer;">üìÑ Group PDF</button>
                    <button onclick="openEditGroup('${g.id}')" style="background:rgba(243,156,18,.12);border:1px solid rgba(243,156,18,.3);border-radius:8px;padding:5px 10px;font-size:0.7rem;color:#f39c12;font-weight:700;cursor:pointer;">‚úèÔ∏è Edit</button>
                </div>
            </div>
            <div class="row g-2 mb-2">
                <div class="col-3 text-center" style="background:#1c253b;border-radius:8px;padding:8px;"><div style="font-size:0.85rem;font-weight:800;color:#34d399;">${fmtAmt(tPaid)}</div><div style="font-size:0.6rem;color:var(--text-dim);">Collected</div></div>
                <div class="col-3 text-center" style="background:#1c253b;border-radius:8px;padding:8px;"><div style="font-size:0.85rem;font-weight:800;color:#f59e0b;">${fmtAmt(tBal)}</div><div style="font-size:0.6rem;color:var(--text-dim);">Pending</div></div>
                <div class="col-3 text-center" style="background:#1c253b;border-radius:8px;padding:8px;"><div style="font-size:0.85rem;font-weight:800;color:#a5b4fc;">${left}</div><div style="font-size:0.6rem;color:var(--text-dim);">Mths Left</div></div>
                <div class="col-3 text-center" style="background:#1c253b;border-radius:8px;padding:8px;"><div style="font-size:0.85rem;font-weight:800;color:#34d399;">${picked}</div><div style="font-size:0.6rem;color:var(--text-dim);">Picked</div></div>
            </div>
            <div style="background:#1c253b;border-radius:5px;height:6px;overflow:hidden;margin-bottom:4px;"><div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#f39c12,#f57c00);border-radius:5px;"></div></div>
            <div style="font-size:0.6rem;color:var(--text-dim);text-align:right;margin-bottom:10px;">Month ${elapsed}/${totalMonths} ¬∑ ${pct}% complete</div>
            ${gMs.length?`<div style="overflow-x:auto;"><table class="table-custom">
                <thead><tr><th>#</th><th>Member</th><th>Paid</th><th>Balance</th><th>Chit?</th></tr></thead>
                <tbody>${memberRows}</tbody></table></div>`:'<div style="text-align:center;color:var(--text-dim);font-size:0.8rem;padding:10px;">No members yet</div>'}
        </div>`;
    }).join('')||'<div style="text-align:center;color:var(--text-dim);padding:40px;">No groups yet.</div>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GROUP PDF ‚Äî one PDF for the whole group
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateGroupPDF(gid){
    showToast('‚è≥ Generating Group PDF‚Ä¶',true);
    const gs=await getCollection('groups');
    const ms=await getCollection('members');
    const ps=await getCollection('payments');
    const g=gs.find(x=>x.id===gid);if(!g)return;
    const gMs=ms.filter(m=>m.groupIds&&m.groupIds.includes(g.id));
    const gPays=ps.filter(p=>p.groupId===gid);
    const today=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});

    // group-level totals
    const totalPaid=gPays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
    const totalBal=gPays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
    const totalChit=gPays.reduce((s,p)=>s+(parseFloat(p.chit)||0),0);
    const totalPicked=gPays.filter(p=>p.chitPicked==='Yes').length;
    const totalMonths=parseInt(g.duration||g.gDuration)||21;
    let elapsed=0;
    if(g.startDate||g.gStart){elapsed=Math.max(0,Math.min(totalMonths,Math.floor((new Date()-new Date(g.startDate||g.gStart))/(1000*60*60*24*30.44))));}
    const left=Math.max(0,totalMonths-elapsed);
    const pct=Math.min(100,Math.round(elapsed/totalMonths*100));

    // ‚îÄ‚îÄ SUMMARY TABLE: one row per member ‚îÄ‚îÄ
    const summaryRows=gMs.map((m,i)=>{
        const mp=gPays.filter(p=>p.memberId===m.id);
        const mPaid=mp.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
        const mBal=mp.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
        const mPicked=mp.filter(p=>p.chitPicked==='Yes').length;
        const lastPay=[...mp].sort((a,b)=>(b.date||'').localeCompare(a.date||''))[0];
        const balColor=mBal>0?'color:#92400e;':'color:#065f46;';
        return`<tr>
            <td>${i+1}</td>
            <td><strong>${m.name}</strong>${m.phone?`<br><span style="font-size:9px;color:#888;">${m.phone}</span>`:''}</td>
            <td style="color:#065f46;font-weight:700;">‚Çπ${mPaid.toLocaleString('en-IN')}</td>
            <td style="${balColor}font-weight:700;">‚Çπ${mBal.toLocaleString('en-IN')}</td>
            <td>${mp.length}</td>
            <td>${lastPay?fmtDate(lastPay.date):'‚Äî'}</td>
            <td>${mPicked>0?`<span class="pdf-chit-badge">‚úÖ ${mPicked}x</span>`:'‚Äî'}</td>
        </tr>`;
    }).join('');

    const summaryTotalRow=`<tr class="pdf-total-row">
        <td colspan="2"><strong>TOTAL (${gMs.length} members)</strong></td>
        <td><strong>‚Çπ${totalPaid.toLocaleString('en-IN')}</strong></td>
        <td><strong>‚Çπ${totalBal.toLocaleString('en-IN')}</strong></td>
        <td><strong>${gPays.length}</strong></td>
        <td colspan="2">${totalPicked} chit(s) picked</td>
    </tr>`;

    // ‚îÄ‚îÄ DETAILED SECTION: per member full payment history ‚îÄ‚îÄ
    const detailSections=gMs.map((m,mi)=>{
        const mp=gPays.filter(p=>p.memberId===m.id).sort((a,b)=>(a.date||'').localeCompare(b.date||''));
        if(!mp.length) return`<div style="margin-bottom:18px;"><div style="font-size:12px;font-weight:800;margin-bottom:4px;">${mi+1}. ${m.name}</div><p style="font-size:10px;color:#888;margin:0;">No payments recorded.</p></div>`;
        const mPaid=mp.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
        const mBal=mp.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
        const rows=mp.map((p,i)=>{
            const cp=p.chitPicked==='Yes';
            return`<tr class="${cp?'pdf-chit-row':''}">
                <td>${i+1}</td>
                <td>${fmtDate(p.date)}</td>
                <td>‚Çπ${(parseFloat(p.chit)||0).toLocaleString('en-IN')}</td>
                <td style="color:#065f46;font-weight:700;">‚Çπ${(parseFloat(p.paid)||0).toLocaleString('en-IN')}</td>
                <td style="color:#92400e;font-weight:700;">‚Çπ${(parseFloat(p.balance)||0).toLocaleString('en-IN')}</td>
                <td>${p.paidBy||'‚Äî'}</td>
                <td>${cp?`<span class="pdf-chit-badge">‚úÖ PICKED${p.chitPickedBy?' by '+p.chitPickedBy:''}</span>`:'‚Äî'}</td>
            </tr>`;
        }).join('');
        return`<div style="margin-bottom:22px;page-break-inside:avoid;">
            <table style="width:100%;margin-bottom:6px;"><tr>
                <td><div style="font-size:12px;font-weight:800;">${mi+1}. ${m.name}${m.phone?' <span style="font-size:10px;color:#888;">¬∑ '+m.phone+'</span>':''}</div></td>
                <td style="text-align:right;font-size:10px;color:#888;">Paid: ‚Çπ${mPaid.toLocaleString('en-IN')} ¬∑ Bal: ‚Çπ${mBal.toLocaleString('en-IN')}</td>
            </tr></table>
            <table class="pdf-table">
                <thead><tr><th>#</th><th>Date</th><th>Chit Value</th><th>Amount Paid</th><th>Balance</th><th>Paid By</th><th>Chit Picked</th></tr></thead>
                <tbody>${rows}
                <tr class="pdf-total-row">
                    <td colspan="3"><strong>Total</strong></td>
                    <td><strong>‚Çπ${mPaid.toLocaleString('en-IN')}</strong></td>
                    <td><strong>‚Çπ${mBal.toLocaleString('en-IN')}</strong></td>
                    <td colspan="2"></td>
                </tr></tbody>
            </table>
        </div>`;
    }).join('');

    document.getElementById('pdfContent').innerHTML=`
        <div class="pdf-header">
            <div>
                <div class="pdf-brand">üèÜ AK CHIT FUNDS</div>
                <div class="pdf-brand-sub">Chit Fund Management ¬∑ Admin Report</div>
            </div>
            <div>
                <div class="pdf-right-title">GROUP STATEMENT</div>
                <div class="pdf-right-sub">Generated: ${today}</div>
            </div>
        </div>

        <!-- GROUP INFO BOX -->
        <div class="pdf-member-box">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:14px;">
                <div>
                    <div class="pdf-member-name">üìÇ ${g.name}</div>
                    <div class="pdf-member-sub">Duration: ${totalMonths} months ¬∑ Started: ${fmtDate(g.startDate||g.gStart||'')}</div>
                    <div class="pdf-member-sub" style="margin-top:4px;">Month ${elapsed} of ${totalMonths} ¬∑ <strong>${left} months remaining</strong></div>
                    <div style="margin-top:8px;">
                        <div class="pdf-progress-outer"><div class="pdf-progress-inner" style="width:${pct}%"></div></div>
                        <div style="font-size:9px;color:#888;text-align:right;margin-top:2px;">${pct}% complete</div>
                    </div>
                </div>
                <div class="pdf-stats-row">
                    <div class="pdf-stat-box"><div class="pdf-stat-val" style="color:#065f46;">‚Çπ${totalPaid.toLocaleString('en-IN')}</div><div class="pdf-stat-lbl">Collected</div></div>
                    <div class="pdf-stat-box"><div class="pdf-stat-val" style="color:#92400e;">‚Çπ${totalBal.toLocaleString('en-IN')}</div><div class="pdf-stat-lbl">Balance</div></div>
                    <div class="pdf-stat-box"><div class="pdf-stat-val">${gMs.length}</div><div class="pdf-stat-lbl">Members</div></div>
                    <div class="pdf-stat-box"><div class="pdf-stat-val" style="color:#065f46;">${totalPicked}</div><div class="pdf-stat-lbl">Chits Picked</div></div>
                </div>
            </div>
        </div>

        <!-- MEMBER SUMMARY TABLE -->
        <div class="pdf-section-title">Member Summary</div>
        <table class="pdf-table" style="margin-bottom:24px;">
            <thead><tr><th>#</th><th>Member Name</th><th>Total Paid</th><th>Balance</th><th>Payments</th><th>Last Payment</th><th>Chit Picked</th></tr></thead>
            <tbody>${summaryRows}${summaryTotalRow}</tbody>
        </table>

        <!-- DETAILED PAYMENT HISTORY PER MEMBER -->
        <div class="pdf-section-title">Detailed Payment History ‚Äî Member Wise</div>
        ${detailSections}

        <div class="pdf-footer">
            <span>AK Chit Funds ¬∑ Admin Portal</span>
            <span>Group: ${g.name} ¬∑ ${today}</span>
            <span>CONFIDENTIAL</span>
        </div>
    `;

    const el=document.getElementById('pdf-template');
    el.style.display='block';
    const opt={
        margin:[8,8],
        filename:`AKChitFunds_Group_${g.name.replace(/\s+/g,'_')}_Report.pdf`,
        image:{type:'jpeg',quality:0.98},
        html2canvas:{scale:2,useCORS:true},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
    };
    setTimeout(()=>{
        html2pdf().set(opt).from(document.getElementById('pdfContent')).save().then(()=>{
            el.style.display='none';showToast('‚úÖ Group PDF Downloaded!',true);
        });
    },400);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIST TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderListTab(){
    const gs=await getCollection('groups');const ms=await getCollection('members');
    document.getElementById('simpleListArea').innerHTML=gs.map((g,gi)=>{
        const gMs=ms.filter(m=>m.groupIds&&m.groupIds.includes(g.id));
        const listId=`listGroup_${gi}`;
        return`<div class="list-group-header" onclick="toggleListGroup('${listId}',this)">
            <span>${g.name}</span>
            <span style="display:flex;align-items:center;gap:8px;">
                <span style="font-size:0.75rem;color:var(--text-dim);">${gMs.length} members</span>
                <span class="list-chevron" style="font-size:0.8rem;color:var(--text-dim);transition:transform .25s;">‚ñº</span>
            </span>
        </div>
        <div id="${listId}" style="display:block;">
            ${gMs.map((m,i)=>`<div style="padding:10px 20px;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;align-items:center;gap:10px;">
                <span style="width:28px;color:var(--text-dim);font-size:0.75rem;">${i+1}.</span>
                <span style="flex:1;">${m.name}</span>
                <span style="font-size:0.75rem;color:var(--text-dim);">${m.phone||''}</span>
            </div>`).join('')}
        </div>`;
    }).join('');
}

function toggleListGroup(id, header){
    const el=document.getElementById(id);
    const chevron=header.querySelector('.list-chevron');
    const isOpen=el.style.display!=='none';
    el.style.display=isOpen?'none':'block';
    chevron.style.transform=isOpen?'rotate(-90deg)':'rotate(0deg)';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACKUP / RESTORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function exportFullBackup(){
    const d={m:await getCollection('members'),g:await getCollection('groups'),p:await getCollection('payments')};
    const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json'}));
    a.download=`AK_Chit_Backup_${new Date().toISOString().split('T')[0]}.json`;a.click();showToast('‚úÖ Backup downloaded!');
}
async function restoreFromJSON(){
    const file=document.getElementById('restoreFile').files[0];if(!file)return showToast('‚ùå Select a file first',false);
    const reader=new FileReader();
    reader.onload=async(e)=>{const data=JSON.parse(e.target.result);
        if(data.m)for(let x of data.m)await db.collection('members').doc(x.id).set(x);
        if(data.g)for(let x of data.g)await db.collection('groups').doc(x.id).set(x);
        if(data.p)for(let x of data.p)await db.collection('payments').doc(x.id).set(x);
        showToast('‚úÖ Restored!');updateUI();};
    reader.readAsText(file);
}

// init
document.getElementById('pDate').value=new Date().toISOString().split('T')[0];
setTimeout(migrateData,1000);
</script>
</body>
</html>
