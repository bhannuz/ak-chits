<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AK Chit Funds - Admin Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --bg-dark:#0a0e1a; --card-bg:#141b2d; --input-bg:#1c253b; --accent-gold:linear-gradient(90deg,#ff9800,#f57c00); --text-main:#ffffff; --text-dim:#8e9aaf; --border:#252f48; }
        * { box-sizing:border-box; }
        body { background-color:var(--bg-dark); color:var(--text-main); font-family:'Segoe UI',sans-serif; padding-bottom:120px; }
        .app-header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid var(--border); }
        .brand { color:#f39c12; font-weight:bold; font-size:1.3rem; }
        .stat-card { background:var(--card-bg); border:1px solid var(--border); border-radius:15px; padding:15px; text-align:center; }
        .stat-num { font-size:1.3rem; font-weight:bold; display:block; }
        .stat-label { font-size:0.65rem; color:var(--text-dim); text-transform:uppercase; }

        /* MODALS */
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.92); z-index:2000; padding:20px; overflow-y:auto; }
        .modal-content-custom { background:var(--card-bg); border-radius:25px; padding:25px; max-width:450px; margin:20px auto; border:1px solid var(--border); }
        .form-input { background:var(--input-bg); border:1px solid var(--border); color:white; padding:12px; border-radius:12px; width:100%; margin-bottom:12px; font-size:0.9rem; }
        .form-input option { background:#1c253b; }
        .form-label-small { font-size:0.72rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:.5px; margin-bottom:5px; display:block; }
        .btn-save { background:var(--accent-gold); color:black; border:none; width:100%; padding:14px; border-radius:14px; font-weight:bold; margin-bottom:10px; cursor:pointer; font-size:0.95rem; }
        .btn-cancel { background:var(--input-bg); color:white; border:none; width:100%; padding:12px; border-radius:14px; cursor:pointer; }
        .btn-danger-full { background:linear-gradient(135deg,#ef4444,#dc2626); color:white; border:none; width:100%; padding:12px; border-radius:14px; font-weight:700; cursor:pointer; margin-bottom:10px; }
        .modal-title { font-size:1.1rem; font-weight:800; margin-bottom:16px; }

        /* NAV */
        .nav-bar { position:fixed; bottom:0; width:100%; background:#070b14; display:flex; justify-content:space-around; padding:12px 0 calc(12px + env(safe-area-inset-bottom)); border-top:1px solid var(--border); z-index:1000; }
        .nav-item { cursor:pointer; text-align:center; font-size:0.62rem; color:var(--text-dim); padding:4px 10px; }
        .nav-item.active { color:#f39c12; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }

        /* TABLES */
        .table-custom { color:white; font-size:0.7rem; width:100%; border-collapse:collapse; }
        .table-custom th { color:var(--text-dim); border-bottom:1px solid var(--border); padding:8px 5px; font-size:0.6rem; text-transform:uppercase; white-space:nowrap; }
        .table-custom td { padding:9px 5px; border-bottom:1px solid rgba(255,255,255,0.05); vertical-align:middle; white-space:nowrap; }
        .table-custom tr.chit-picked { background:rgba(16,185,129,0.08); }
        .table-custom tr.chit-picked td:first-child { border-left:3px solid #10b981; }
        .table-custom tr.due-row { background:rgba(239,68,68,0.07); }
        .table-custom tr.due-row td { color:#f87171; font-style:italic; }
        .table-custom tr.partial-row { background:rgba(245,158,11,0.07); }
        /* Multi-month highlight */
        .table-custom tr.multi-month-row { background:rgba(99,102,241,0.09); }
        .table-custom tr.multi-month-row td:first-child { border-left:3px solid #818cf8; }
        .due-badge { display:inline-block; background:rgba(239,68,68,0.15); color:#f87171; border:1px solid rgba(239,68,68,0.3); border-radius:4px; padding:1px 6px; font-size:0.6rem; font-weight:700; }
        .partial-badge { display:inline-block; background:rgba(245,158,11,0.2); color:#fbbf24; border:1px solid rgba(245,158,11,0.4); border-radius:4px; padding:1px 6px; font-size:0.6rem; font-weight:700; }
        .chit-yes-badge { display:inline-block; background:rgba(16,185,129,0.2); color:#34d399; border:1px solid rgba(16,185,129,0.4); border-radius:5px; padding:2px 7px; font-size:0.6rem; font-weight:800; }
        .chit-no { color:var(--text-dim); font-size:0.65rem; }
        /* Multi-month badge */
        .multi-month-badge { display:inline-flex; align-items:center; gap:3px; background:rgba(99,102,241,0.18); color:#a5b4fc; border:1px solid rgba(99,102,241,0.4); border-radius:5px; padding:2px 7px; font-size:0.6rem; font-weight:800; }

        /* AUTOCOMPLETE */
        .suggestions-list { position:absolute; top:100%; left:0; right:0; background:var(--input-bg); border:1px solid var(--border); border-radius:0 0 12px 12px; z-index:3000; max-height:200px; overflow-y:auto; display:none; margin-top:-12px; }
        .suggestion-item { padding:12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.9rem; }
        .suggestion-item:hover { background:#252f48; color:#f39c12; }

        /* GROUP CHECKBOX */
        .group-checkbox-area { max-height:150px; overflow-y:auto; background:var(--input-bg); padding:10px; border-radius:12px; border:1px solid var(--border); margin-bottom:15px; }

        /* STAT BOXES */
        .mini-stat { background:var(--input-bg); border-radius:10px; padding:10px 8px; text-align:center; }
        .mini-stat-val { font-size:0.9rem; font-weight:800; }
        .mini-stat-lbl { font-size:0.6rem; color:var(--text-dim); text-transform:uppercase; margin-top:2px; }

        /* PROGRESS BAR */
        .prog-bar-outer { background:#252f48; border-radius:5px; height:7px; overflow:hidden; margin:6px 0 3px; }
        .prog-bar-inner { height:100%; border-radius:5px; background:linear-gradient(90deg,#f39c12,#f57c00); }
        .prog-label { font-size:0.65rem; color:var(--text-dim); display:flex; justify-content:space-between; }

        /* LIST TAB */
        .list-group-header { background:#1c253b; padding:12px 15px; border-radius:10px; margin-top:12px; font-weight:bold; color:#f39c12; border-left:4px solid #f39c12; display:flex; justify-content:space-between; align-items:center; cursor:pointer; user-select:none; }

        /* MONTHS BADGE */
        .months-badge { display:inline-flex; align-items:center; gap:5px; background:rgba(99,102,241,.15); border:1px solid rgba(99,102,241,.3); border-radius:8px; padding:4px 10px; font-size:0.72rem; font-weight:700; color:#a5b4fc; }

        /* PDF BUTTON */
        .btn-pdf { background:linear-gradient(135deg,#e74c3c,#c0392b); color:white; border:none; border-radius:8px; padding:7px 13px; font-size:0.75rem; font-weight:700; cursor:pointer; }

        /* EDIT/DELETE SMALL BUTTONS */
        .btn-edit-sm { background:rgba(243,156,18,.12); border:1px solid rgba(243,156,18,.35); color:#f39c12; border-radius:7px; padding:4px 10px; font-size:0.68rem; font-weight:700; cursor:pointer; }
        .btn-del-sm { background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35); color:#f87171; border-radius:7px; padding:4px 10px; font-size:0.68rem; font-weight:700; cursor:pointer; }

        /* GROUPS TAB COLLAPSIBLE */
        .group-card { background:var(--card-bg); border:1px solid var(--border); border-radius:16px; padding:16px; margin-bottom:14px; overflow:hidden; }
        .group-card-header { cursor:pointer; user-select:none; }
        .group-body { transition:max-height 0.3s ease, opacity 0.3s ease; overflow:hidden; }
        .group-body.collapsed { max-height:0 !important; opacity:0; }
        .chevron-icon { transition:transform 0.25s ease; display:inline-block; font-size:0.8rem; color:var(--text-dim); }
        .chevron-icon.open { transform: rotate(0deg); }
        .chevron-icon.closed { transform: rotate(-90deg); }

        /* Multi-month preview box */
        .multi-month-preview { background:rgba(99,102,241,0.08); border:1px solid rgba(99,102,241,0.25); border-radius:12px; padding:12px 14px; margin-bottom:12px; display:none; }
        .multi-month-preview-title { font-size:0.68rem; color:#a5b4fc; font-weight:700; text-transform:uppercase; letter-spacing:.5px; margin-bottom:8px; }
        .multi-month-chip { display:inline-flex; align-items:center; background:rgba(99,102,241,0.2); border:1px solid rgba(99,102,241,0.35); border-radius:6px; padding:3px 9px; font-size:0.68rem; color:#c7d2fe; margin:2px; font-weight:600; }
        /* Month selector checkboxes */
        .month-selector-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; max-height:220px; overflow-y:auto; }
        .month-cb-item { display:flex; align-items:center; gap:6px; background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:8px; padding:6px 8px; cursor:pointer; transition:all .15s; font-size:0.68rem; }
        .month-cb-item:hover { background:rgba(99,102,241,0.12); border-color:rgba(99,102,241,0.4); }
        .month-cb-item.selected { background:rgba(99,102,241,0.2); border-color:rgba(99,102,241,0.6); color:#a5b4fc; font-weight:700; }
        .month-cb-item.already-paid { background:rgba(16,185,129,0.07); border-color:rgba(16,185,129,0.3); color:#34d399; opacity:0.6; cursor:not-allowed; }
        .month-cb-item input[type=checkbox] { accent-color:#818cf8; width:13px; height:13px; flex-shrink:0; }
        .selected-summary { font-size:0.68rem; color:#a5b4fc; margin-top:8px; font-weight:700; padding:6px 10px; background:rgba(99,102,241,0.12); border-radius:8px; }

        /* ‚ïê‚ïê AUTH / LOGIN ‚ïê‚ïê */
        #loginScreen { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-dark); z-index:9000; display:flex; align-items:center; justify-content:center; padding:20px; }
        .login-card { background:var(--card-bg); border:1px solid var(--border); border-radius:28px; padding:32px 28px; width:100%; max-width:400px; }
        .login-brand { text-align:center; margin-bottom:28px; }
        .login-brand-title { font-size:1.6rem; font-weight:900; color:#f39c12; }
        .login-brand-sub { font-size:0.75rem; color:var(--text-dim); margin-top:4px; }
        .login-step { display:none; }
        .login-step.active { display:block; }
        .login-phone-input { display:flex; gap:8px; }
        .phone-prefix { background:var(--input-bg); border:1px solid var(--border); color:var(--text-dim); padding:12px 14px; border-radius:12px; font-size:0.9rem; flex-shrink:0; }
        .login-info-box { background:rgba(243,156,18,.08); border:1px solid rgba(243,156,18,.25); border-radius:12px; padding:12px 14px; font-size:0.78rem; color:#f39c12; margin-bottom:14px; }
        .pending-box { background:rgba(245,158,11,.08); border:1px solid rgba(245,158,11,.3); border-radius:16px; padding:20px; text-align:center; }
        .denied-box { background:rgba(239,68,68,.08); border:1px solid rgba(239,68,68,.3); border-radius:16px; padding:20px; text-align:center; }
        /* Access Requests panel (admin) */
        .req-card { background:var(--input-bg); border:1px solid var(--border); border-radius:12px; padding:12px 14px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; gap:8px; }
        .req-name { font-weight:700; font-size:0.85rem; }
        .req-phone { font-size:0.7rem; color:var(--text-dim); }
        .btn-approve { background:linear-gradient(135deg,#10b981,#059669); color:white; border:none; border-radius:8px; padding:6px 14px; font-size:0.72rem; font-weight:700; cursor:pointer; }
        .btn-deny { background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.4); color:#f87171; border-radius:8px; padding:6px 14px; font-size:0.72rem; font-weight:700; cursor:pointer; }
        .badge-pending { background:rgba(245,158,11,.2); color:#fbbf24; border:1px solid rgba(245,158,11,.4); border-radius:5px; padding:2px 8px; font-size:0.62rem; font-weight:700; }
        .badge-approved { background:rgba(16,185,129,.2); color:#34d399; border:1px solid rgba(16,185,129,.4); border-radius:5px; padding:2px 8px; font-size:0.62rem; font-weight:700; }
        .badge-denied { background:rgba(239,68,68,.15); color:#f87171; border:1px solid rgba(239,68,68,.3); border-radius:5px; padding:2px 8px; font-size:0.62rem; font-weight:700; }
        /* Member-only view tweaks */
        body.member-mode .nav-bar { display:none !important; }
        #pdf-template { position:absolute; left:-9999px; top:0; width:794px; visibility:hidden; pointer-events:none; background:white; }
        #pdf-template.rendering { visibility:visible; }
        .pdf-page { background:white; color:#111; padding:20px 30px; font-family:'Segoe UI',Arial,sans-serif; width:750px; }
        .pdf-header { display:flex; justify-content:space-between; align-items:flex-start; border-bottom:4px solid #f39c12; padding-bottom:14px; margin-bottom:20px; }
        .pdf-brand { font-size:26px; font-weight:900; color:#f39c12; }
        .pdf-brand-sub { font-size:11px; color:#888; margin-top:2px; }
        .pdf-right-title { font-size:16px; font-weight:800; text-align:right; }
        .pdf-right-sub { font-size:11px; color:#888; text-align:right; margin-top:3px; }
        .pdf-member-box { background:#fffbf0; border:2px solid #f39c12; border-radius:12px; padding:16px 20px; margin-bottom:20px; }
        .pdf-member-name { font-size:20px; font-weight:800; }
        .pdf-member-sub { font-size:12px; color:#555; margin-top:4px; }
        .pdf-stats-row { display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
        .pdf-stat-box { flex:1; min-width:100px; border:1px solid #ddd; border-radius:8px; padding:10px; text-align:center; background:white; }
        .pdf-stat-val { font-size:15px; font-weight:800; }
        .pdf-stat-lbl { font-size:9px; color:#888; text-transform:uppercase; letter-spacing:.4px; margin-top:2px; }
        .pdf-section-title { font-size:11px; font-weight:800; color:#888; text-transform:uppercase; letter-spacing:1px; margin:20px 0 8px; border-bottom:1px solid #eee; padding-bottom:6px; }
        .pdf-group-title { font-size:13px; font-weight:800; margin-bottom:6px; color:#111; }
        .pdf-progress-outer { background:#eee; border-radius:5px; height:8px; margin-bottom:4px; overflow:hidden; }
        .pdf-progress-inner { height:100%; background:linear-gradient(90deg,#f39c12,#f57c00); border-radius:5px; }
        .pdf-table { width:100%; border-collapse:collapse; font-size:11px; margin-bottom:20px; }
        .pdf-table th { background:#f5f5f5; border:1px solid #ccc; padding:7px 9px; font-size:9px; text-transform:uppercase; color:#555; text-align:left; }
        .pdf-table td { border:1px solid #ddd; padding:7px 9px; }
        .pdf-table tr:nth-child(even) td { background:#fafafa; }
        .pdf-table tr.pdf-chit-row td { background:#f0fff8 !important; }
        .pdf-table tr.pdf-chit-row td:first-child { border-left:3px solid #10b981; }
        .pdf-table tr.pdf-due-row td { background:#fff5f5 !important; color:#c0392b; font-style:italic; }
        .pdf-table tr.pdf-partial-row td { background:#fffbeb !important; }
        .pdf-table tr.pdf-multi-row td { background:#eef2ff !important; }
        .pdf-table tr.pdf-multi-row td:first-child { border-left:3px solid #818cf8; }
        .pdf-chit-badge { background:#d1fae5; color:#065f46; border-radius:4px; padding:2px 6px; font-size:9px; font-weight:800; }
        .pdf-due-badge { background:#fee2e2; color:#b91c1c; border-radius:4px; padding:2px 6px; font-size:9px; font-weight:800; }
        .pdf-partial-badge { background:#fef3c7; color:#92400e; border-radius:4px; padding:2px 6px; font-size:9px; font-weight:800; }
        .pdf-multi-badge { background:#e0e7ff; color:#3730a3; border-radius:4px; padding:2px 6px; font-size:9px; font-weight:800; }
        .pdf-total-row td { background:#fff8e1 !important; font-weight:800; border-top:2px solid #f39c12; }
        .pdf-footer { margin-top:24px; border-top:1px solid #ddd; padding-top:12px; display:flex; justify-content:space-between; font-size:10px; color:#aaa; }
    </style>
</head>
<body>

<div class="container py-2">
    <!-- ADMIN HEADER (default) -->
    <div id="adminHeader" class="app-header">
        <div class="brand">üèÜ AK Chit Funds <small style="font-size:0.5em;color:#2ecc71;">‚òÅ CLOUD</small></div>
        <div style="display:flex;align-items:center;gap:8px;">
            <span id="headerRoleBadge" class="badge text-warning border border-warning px-2">ADMIN</span>
            <button id="accessReqBtn" onclick="openAccessRequests()" title="Access Requests" style="display:none;background:rgba(243,156,18,.12);border:1px solid rgba(243,156,18,.3);color:#f39c12;border-radius:10px;padding:5px 10px;font-size:0.75rem;font-weight:700;cursor:pointer;position:relative;">
                üîê Requests <span id="pendingCount" style="display:none;background:#ef4444;color:white;border-radius:50%;width:16px;height:16px;font-size:0.55rem;font-weight:900;position:absolute;top:-5px;right:-5px;display:flex;align-items:center;justify-content:center;"></span>
            </button>
            <button id="logoutBtn" onclick="handleLogout()" style="display:none;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);color:#f87171;border-radius:10px;padding:5px 10px;font-size:0.75rem;font-weight:700;cursor:pointer;">‚èª Logout</button>
        </div>
    </div>

    <!-- MEMBER PROFILE HEADER (shown in member mode) -->
    <div id="memberHeader" style="display:none;padding:16px 4px 0;">
        <div style="background:linear-gradient(135deg,rgba(243,156,18,.18),rgba(243,156,18,.04));border:1px solid rgba(243,156,18,.3);border-radius:22px;padding:18px 18px 14px;">
            <div style="display:flex;align-items:center;gap:14px;margin-bottom:12px;">
                <div id="memberHeaderAvatar" style="width:52px;height:52px;border-radius:16px;background:linear-gradient(135deg,#f39c12,#f57c00);color:black;display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:900;flex-shrink:0;box-shadow:0 4px 14px rgba(243,156,18,.35);"></div>
                <div style="flex:1;min-width:0;">
                    <div style="font-size:0.65rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.6px;margin-bottom:2px;">Welcome back üëã</div>
                    <div id="memberHeaderName" style="font-size:1.15rem;font-weight:900;color:#f39c12;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
                    <div id="memberHeaderPhone" style="font-size:0.72rem;color:var(--text-dim);margin-top:1px;"></div>
                </div>
                <button onclick="handleLogout()" style="background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);color:#f87171;border-radius:10px;padding:6px 11px;font-size:0.72rem;font-weight:700;cursor:pointer;flex-shrink:0;">‚èª</button>
            </div>
            <!-- Member stats row -->
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
                <div style="background:rgba(0,0,0,.2);border-radius:12px;padding:10px 8px;text-align:center;">
                    <div id="mhGroups" style="font-size:1rem;font-weight:800;color:#a5b4fc;">‚Äî</div>
                    <div style="font-size:0.58rem;color:var(--text-dim);text-transform:uppercase;margin-top:2px;">My Groups</div>
                </div>
                <div style="background:rgba(0,0,0,.2);border-radius:12px;padding:10px 8px;text-align:center;">
                    <div id="mhTotalPaid" style="font-size:0.85rem;font-weight:800;color:#34d399;">‚Äî</div>
                    <div style="font-size:0.58rem;color:var(--text-dim);text-transform:uppercase;margin-top:2px;">Total Paid</div>
                </div>
                <div style="background:rgba(0,0,0,.2);border-radius:12px;padding:10px 8px;text-align:center;">
                    <div id="mhBalance" style="font-size:0.85rem;font-weight:800;color:#f59e0b;">‚Äî</div>
                    <div style="font-size:0.58rem;color:var(--text-dim);text-transform:uppercase;margin-top:2px;">Balance</div>
                </div>
            </div>
        </div>
    </div>

    <!-- HOME TAB -->
    <div id="homeTab" class="tab-content active">
        <!-- Admin-only stat cards -->
        <div id="adminStatCards" class="row g-2 mt-3 text-center">
            <div class="col-4"><div class="stat-card"><span class="stat-num" id="memberCount">-</span><span class="stat-label">Members</span></div></div>
            <div class="col-4"><div class="stat-card"><span class="stat-num" id="groupCount">-</span><span class="stat-label">Groups</span></div></div>
            <div class="col-4"><div class="stat-card"><span class="stat-num text-success" id="todayColl">‚Çπ0</span><span class="stat-label">Today</span></div></div>
        </div>
        <!-- Admin-only action buttons -->
        <div id="adminActionBtns" style="display:flex;gap:8px;margin-top:12px;">
            <button class="btn btn-warning w-100 py-3 fw-bold shadow" onclick="openPaymentModal()" style="border-radius:20px;">üí≥ Record Payment</button>
            <button onclick="resetPaymentForm();openModal('paymentModal');" title="Refresh Form" style="background:var(--card-bg);border:1px solid var(--border);color:#f39c12;border-radius:20px;padding:0 18px;font-size:1.2rem;cursor:pointer;flex-shrink:0;">üîÑ</button>
        </div>

        <!-- MEMBER SEARCH (admin only) -->
        <div id="adminMemberSearch" class="p-3 my-3" style="background:var(--card-bg);border-radius:20px;border:1px solid var(--border);">
            <div style="display:flex;gap:8px;align-items:flex-start;">
                <div style="position:relative;flex:1;">
                    <input type="text" id="summarySearch" class="form-input" style="margin-bottom:0;" placeholder="üîç Search Member for Summary / PDF..." oninput="filterSearch('summarySearch','summaryList','summaryView')">
                    <input type="hidden" id="summaryView">
                    <div id="summaryList" class="suggestions-list"></div>
                </div>
                <button onclick="clearMemberSearch()" title="Clear / Refresh" style="background:var(--input-bg);border:1px solid var(--border);color:#f39c12;border-radius:12px;padding:12px 14px;font-size:1rem;cursor:pointer;flex-shrink:0;line-height:1;">üîÑ</button>
            </div>
            <div id="ledgerData"></div>
        </div>

        <!-- MEMBER-ONLY ledger (shown instead of search when member logs in) -->
        <div id="memberLedgerArea" style="display:none;margin-top:12px;">
            <div id="memberLedgerData"></div>
        </div>

        <!-- QUICK ACTION BUTTONS (admin only) -->
        <div id="adminQuickBtns" class="d-flex gap-2">
            <button class="btn btn-outline-warning w-100 py-3 fw-bold" onclick="openAddMember()">üë§ Create Member</button>
            <button class="btn btn-outline-success w-100 py-3 fw-bold" onclick="openAddGroup()">üè¶ New Group</button>
        </div>
    </div>

    <!-- GROUPS TAB -->
    <div id="groupsTab" class="tab-content"><div id="groupListArea" class="mt-2"></div></div>

    <!-- LIST TAB -->
    <div id="listTab" class="tab-content"><div id="simpleListArea" class="mt-2"></div></div>

    <!-- BACKUP TAB -->
    <div id="backupTab" class="tab-content">
        <h5 class="mt-4 mb-3 text-warning text-center">üíæ Data Management</h5>
        <div class="stat-card p-4">
            <button class="btn btn-warning w-100 py-3 mb-2 fw-bold" onclick="exportFullBackup()">üíæ Download JSON Backup</button>
            <button class="btn btn-success w-100 py-3 mb-3 fw-bold" onclick="exportToExcel()">üìä Export to Excel (.xlsx)</button>
            <hr style="border-color:var(--border);">
            <p class="small mb-2" style="color:var(--text-dim);">Restore all data from backup file:</p>
            <input type="file" id="restoreFile" class="form-control mb-2 bg-dark text-white border-secondary" accept=".json">
            <button class="btn btn-outline-info w-100 py-3 fw-bold" onclick="confirmRestore()">üîÑ Restore All Data</button>
            <p class="small mt-2 text-center" style="color:#ef4444;">‚ö†Ô∏è This will overwrite existing data</p>
        </div>
    </div>
</div>

<!-- PDF TEMPLATE - off screen container -->
<div id="pdf-template"><div id="pdfContent" style="background:white;font-family:'Segoe UI',Arial,sans-serif;width:794px;color:#111;"></div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- MEMBER MODAL -->
<div id="memberModal" class="modal-overlay">
    <div class="modal-content-custom">
        <div class="modal-title" id="memberModalTitle">üë§ Create Member</div>
        <input type="hidden" id="editMemberId">
        <label class="form-label-small">Full Name</label>
        <input type="text" id="mName" class="form-input" placeholder="e.g. Rama Krishna">
        <label class="form-label-small">Phone Number</label>
        <input type="text" id="mPhone" class="form-input" placeholder="e.g. 9876543210">
        <label class="form-label-small">Assign to Groups</label>
        <div id="groupCheckboxes" class="group-checkbox-area"></div>
        <button class="btn-save" onclick="saveMember()">‚úì Save Member</button>
        <div id="deleteMemberArea" style="display:none;">
            <button class="btn-danger-full" onclick="deleteMemberFromModal()">üóë Delete Member</button>
        </div>
        <button class="btn-cancel" onclick="closeModal('memberModal')">Cancel</button>
    </div>
</div>

<!-- GROUP MODAL -->
<div id="groupModal" class="modal-overlay">
    <div class="modal-content-custom">
        <div class="modal-title" id="groupModalTitle">üè¶ New Group</div>
        <input type="hidden" id="editGroupId">
        <label class="form-label-small">Group Name</label>
        <input type="text" id="gName" class="form-input" placeholder="e.g. Group A">
        <label class="form-label-small">Duration (Months)</label>
        <input type="number" id="gDuration" class="form-input" placeholder="e.g. 21">
        <label class="form-label-small">Monthly Due Day (1‚Äì31)</label>
        <input type="number" id="gDueDay" class="form-input" placeholder="e.g. 5 means 5th of every month" min="1" max="31">
        <label class="form-label-small">Start Date</label>
        <input type="date" id="gStart" class="form-input">
        <button class="btn-save" onclick="saveGroup()">‚úì Save Group</button>
        <div id="deleteGroupArea" style="display:none;">
            <button class="btn-danger-full" onclick="deleteGroupFromModal()">üóë Delete Group</button>
        </div>
        <button class="btn-cancel" onclick="closeModal('groupModal')">Cancel</button>
    </div>
</div>

<!-- PAYMENT MODAL ‚Äî with multi-month support -->
<div id="paymentModal" class="modal-overlay">
    <div class="modal-content-custom">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div class="modal-title" style="margin-bottom:0;">üí≥ Record Payment</div>
            <button onclick="resetPaymentForm()" title="Clear all fields" style="background:rgba(243,156,18,.12);border:1px solid rgba(243,156,18,.3);color:#f39c12;border-radius:10px;padding:6px 12px;font-size:0.75rem;font-weight:700;cursor:pointer;">üîÑ Refresh</button>
        </div>
        <label class="form-label-small">Payment Date</label>
        <input type="date" id="pDate" class="form-input">
        <label class="form-label-small">Member</label>
        <div style="position:relative;">
            <input type="text" id="pMemberSearch" class="form-input" placeholder="üîç Search Member..." oninput="filterSearch('pMemberSearch','pMemberList','pMember')">
            <input type="hidden" id="pMember">
            <div id="pMemberList" class="suggestions-list"></div>
        </div>
        <label class="form-label-small">Group</label>
        <select id="pGroup" class="form-input" onchange="onGroupChange()"><option value="">-- Select Member First --</option></select>

        <div class="row g-2">
            <div class="col-6">
                <label class="form-label-small">Chit Amount</label>
                <input type="number" id="pChit" class="form-input" placeholder="‚Çπ per month" oninput="calcBalance()">
            </div>
            <div class="col-6">
                <label class="form-label-small">Total Amount Paid</label>
                <input type="number" id="pPaid" class="form-input" placeholder="‚Çπ total" oninput="calcBalance()">
            </div>
        </div>
        <label class="form-label-small">Paid By</label>
        <select id="pPaidBy" class="form-input">
            <option value="">-- Select Mode --</option>
            <option>UPI</option><option>GPay</option><option>PhonePe</option>
            <option>PPay</option><option>Bank Transfer</option><option>Cash</option><option>Cheque</option>
        </select>
        <label class="form-label-small">Chit Picked?</label>
        <select id="pChitPicked" class="form-input" onchange="toggleChitPickedName()">
            <option value="No">No</option>
            <option value="Yes">Yes ‚úÖ</option>
        </select>
        <div id="chitPickedNameDiv" style="display:none;">
            <label class="form-label-small">Chit Picked Value</label>
            <input type="text" id="pChitPickedBy" class="form-input" placeholder="Enter chit picked value">
        </div>
        <button class="btn-save" onclick="savePayment()">‚úì Sync Payment</button>
        <button class="btn-cancel" onclick="closeModal('paymentModal')">Cancel</button>
    </div>
</div>

<!-- EDIT PAYMENT MODAL -->
<div id="editPaymentModal" class="modal-overlay">
    <div class="modal-content-custom">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div class="modal-title" style="margin-bottom:0;">‚úèÔ∏è Edit Payment</div>
            <button onclick="closeModal('editPaymentModal')" style="background:none;border:none;color:var(--text-dim);font-size:1.3rem;cursor:pointer;">‚úï</button>
        </div>
        <input type="hidden" id="epId">
        <!-- Multi-month info display (read-only) -->
        <div id="epMultiMonthInfo" style="display:none;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.3);border-radius:10px;padding:10px 14px;margin-bottom:12px;">
            <div style="font-size:0.68rem;color:#a5b4fc;font-weight:700;margin-bottom:4px;">üìÖ MULTI-MONTH PAYMENT</div>
            <div id="epMultiMonthDetail" style="font-size:0.75rem;color:#c7d2fe;"></div>
            <div style="font-size:0.62rem;color:var(--text-dim);margin-top:4px;">This is part of a grouped payment. Editing updates this month's record only.</div>
        </div>
        <label class="form-label-small">Payment Date</label>
        <input type="date" id="epDate" class="form-input">
        <div class="row g-2">
            <div class="col-6"><label class="form-label-small">Chit Amount</label><input type="number" id="epChit" class="form-input" placeholder="‚Çπ" oninput="epCalcBalance()"></div>
            <div class="col-6"><label class="form-label-small">Amount Paid</label><input type="number" id="epPaid" class="form-input" placeholder="‚Çπ" oninput="epCalcBalance()"></div>
        </div>
        <label class="form-label-small">Balance (auto)</label>
        <input type="number" id="epBal" class="form-input" placeholder="Balance" readonly style="opacity:.7;">
        <label class="form-label-small">Paid By</label>
        <select id="epPaidBy" class="form-input">
            <option value="">-- Select Mode --</option>
            <option>UPI</option><option>GPay</option><option>PhonePe</option>
            <option>PPay</option><option>Bank Transfer</option><option>Cash</option><option>Cheque</option>
        </select>
        <label class="form-label-small">Chit Picked?</label>
        <select id="epChitPicked" class="form-input" onchange="epTogglePickedName()">
            <option value="No">No</option>
            <option value="Yes">Yes ‚úÖ</option>
        </select>
        <div id="epChitPickedNameDiv" style="display:none;">
            <label class="form-label-small">Chit Picked Value</label>
            <input type="text" id="epChitPickedBy" class="form-input" placeholder="Enter chit picked value">
        </div>
        <button class="btn-save" onclick="saveEditPayment()">‚úì Update Payment</button>
        <button class="btn-danger-full" onclick="deletePayment()">üóë Delete Payment</button>
        <button class="btn-cancel" onclick="closeModal('editPaymentModal')">Cancel</button>
    </div>
</div>

<!-- CONFIRM MODAL -->
<div id="confirmModal" class="modal-overlay">
    <div class="modal-content-custom" style="max-width:360px;">
        <div style="font-size:2rem;text-align:center;margin-bottom:10px;" id="confirmIcon">‚ö†Ô∏è</div>
        <div class="modal-title text-center" id="confirmTitle">Are you sure?</div>
        <p style="font-size:0.85rem;color:var(--text-dim);text-align:center;margin-bottom:20px;" id="confirmMsg"></p>
        <button class="btn-danger-full" id="confirmOkBtn">Confirm</button>
        <button class="btn-cancel" onclick="closeModal('confirmModal')">Cancel</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginScreen">
    <div class="login-card">
        <div class="login-brand">
            <div style="font-size:2.5rem;margin-bottom:8px;">üèÜ</div>
            <div class="login-brand-title">AK Chit Funds</div>
            <div class="login-brand-sub">Enter your mobile number to continue</div>
        </div>

        <!-- STEP 1: Enter phone -->
        <div id="loginStep1" class="login-step active">
            <label class="form-label-small">Mobile Number</label>
            <div class="login-phone-input">
                <span class="phone-prefix">+91</span>
                <input type="tel" id="loginPhone" class="form-input" style="margin-bottom:0;" placeholder="10-digit mobile number" maxlength="10" oninput="this.value=this.value.replace(/\D/g,'')">
            </div>
            <div style="height:12px;"></div>
            <button class="btn-save" onclick="handleLoginSubmit()">üîê Continue</button>
        </div>

        <!-- STEP 2: Pending approval -->
        <div id="loginStep2" class="login-step">
            <div class="pending-box">
                <div style="font-size:2rem;margin-bottom:10px;">‚è≥</div>
                <div style="font-weight:800;font-size:1rem;margin-bottom:6px;">Access Requested</div>
                <div style="font-size:0.8rem;color:var(--text-dim);margin-bottom:16px;">Your request has been sent to the admin. Please wait for approval.</div>
                <div id="pendingPhone" style="font-size:0.85rem;color:#f39c12;font-weight:700;margin-bottom:16px;"></div>
                <button class="btn-cancel" onclick="checkAccessStatus()" style="margin-bottom:8px;">üîÑ Check Status</button>
                <button class="btn-cancel" onclick="goBackToLogin()">‚Üê Back</button>
            </div>
        </div>

        <!-- STEP 3: Denied -->
        <div id="loginStep3" class="login-step">
            <div class="denied-box">
                <div style="font-size:2rem;margin-bottom:10px;">üö´</div>
                <div style="font-weight:800;color:#f87171;margin-bottom:6px;">Access Denied</div>
                <div style="font-size:0.8rem;color:var(--text-dim);margin-bottom:16px;">Your access request was denied. Contact the admin for assistance.</div>
                <button class="btn-cancel" onclick="goBackToLogin()">‚Üê Try Another Number</button>
            </div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACCESS REQUESTS MODAL (admin) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="accessModal" class="modal-overlay">
    <div class="modal-content-custom" style="max-width:500px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div class="modal-title" style="margin-bottom:0;">üîê Access Requests</div>
            <button onclick="closeModal('accessModal')" style="background:none;border:none;color:var(--text-dim);font-size:1.2rem;cursor:pointer;">‚úï</button>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:14px;">
            <button onclick="filterRequests('pending')" id="reqTabPending" class="btn-save" style="flex:1;padding:8px;font-size:0.75rem;margin-bottom:0;">‚è≥ Pending</button>
            <button onclick="filterRequests('approved')" id="reqTabApproved" class="btn-cancel" style="flex:1;padding:8px;font-size:0.75rem;">‚úÖ Approved</button>
            <button onclick="filterRequests('all')" id="reqTabAll" class="btn-cancel" style="flex:1;padding:8px;font-size:0.75rem;">üìã All</button>
        </div>
        <div id="accessRequestsList" style="max-height:400px;overflow-y:auto;"></div>
        <button class="btn-cancel" onclick="closeModal('accessModal')" style="margin-top:10px;">Close</button>
    </div>
</div>

<!-- BOTTOM NAV -->
<div class="nav-bar">
    <div class="nav-item active" id="navHome" onclick="switchTab('home')">üè†<br>Home</div>
    <div class="nav-item" id="navGroups" onclick="switchTab('groups')">üìÅ<br>Groups</div>
    <div class="nav-item" id="navList" onclick="switchTab('list')">üìú<br>List</div>
    <div class="nav-item" id="navBackup" onclick="switchTab('backup')">üíæ<br>Backup</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const firebaseConfig={apiKey:"AIzaSyB9_sBL83skvIaOVAE8msHwIWq8QQwhxFU",authDomain:"ak-chit-funds.firebaseapp.com",projectId:"ak-chit-funds",storageBucket:"ak-chit-funds.firebasestorage.app",messagingSenderId:"297195194526",appId:"1:297195194526:web:b71c7c09dcf8610211938f"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
let ALL_MEMBERS=[];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function getCollection(col){const s=await db.collection(col).get();return s.docs.map(d=>({id:d.id,...d.data()}));}
function fmtDate(d){if(!d)return"‚Äî";const[y,m,day]=d.split("-");return`${day}/${m}/${y}`;}
function fmtAmt(v){return'‚Çπ'+(parseFloat(v)||0).toLocaleString('en-IN');}
function ini(n){return(n||'?').split(' ').map(x=>x[0]||'').join('').toUpperCase().slice(0,2)||'??';}
function isAdmin(){ return CURRENT_USER && CURRENT_USER.role === 'admin'; }
function guardAdmin(fn){ return function(...args){ if(!isAdmin()){ showToast('üö´ Access denied',false); return; } return fn(...args); }; }

function openModal(id){document.getElementById(id).style.display='block';}
function closeModal(id){document.getElementById(id).style.display='none';}

function toggleChitPickedName(){document.getElementById('chitPickedNameDiv').style.display=document.getElementById('pChitPicked').value==='Yes'?'block':'none';}

function clearMemberSearch(){
    document.getElementById('summarySearch').value='';
    document.getElementById('summaryView').value='';
    document.getElementById('summaryList').style.display='none';
    document.getElementById('ledgerData').innerHTML='';
    updateUI();
}

function showToast(msg,ok=true){
    const t=document.createElement('div');
    t.style.cssText=`position:fixed;top:20px;left:50%;transform:translateX(-50%);background:${ok?'#10b981':'#ef4444'};color:white;padding:12px 24px;border-radius:12px;font-weight:700;font-size:13px;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,.4);white-space:nowrap;`;
    t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3000);
}

function showConfirm(icon,title,msg,onOk){
    document.getElementById('confirmIcon').textContent=icon;
    document.getElementById('confirmTitle').textContent=title;
    document.getElementById('confirmMsg').textContent=msg;
    document.getElementById('confirmOkBtn').onclick=()=>{closeModal('confirmModal');onOk();};
    openModal('confirmModal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DUE DATE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getGroupDueDates(group){
    const start=group.startDate||group.gStart;
    if(!start) return[];
    const totalMonths=parseInt(group.duration||group.gDuration)||21;
    const dueDay=parseInt(group.dueDay)||new Date(start).getDate();
    const s=new Date(start+'T00:00:00');
    const startYear=s.getFullYear();
    const startMonth=s.getMonth();
    const pad=n=>String(n).padStart(2,'0');
    const dates=[];
    for(let i=0;i<totalMonths;i++){
        const yr=startYear+Math.floor((startMonth+i)/12);
        const mo=(startMonth+i)%12;
        const maxDay=new Date(yr,mo+1,0).getDate();
        const day=Math.min(dueDay,maxDay);
        dates.push(`${yr}-${pad(mo+1)}-${pad(day)}`);
    }
    return dates;
}

function getMonthSlot(dueDates, payDate){
    if(!dueDates.length) return -1;
    if(payDate<dueDates[0]) return 0;
    for(let i=0;i<dueDates.length;i++){
        const nextDue=dueDates[i+1]||'9999-99-99';
        if(payDate>=dueDates[i]&&payDate<nextDue) return i;
    }
    return dueDates.length-1;
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAYMENT BALANCE CALC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcBalance(){
    const chit=parseFloat(document.getElementById('pChit').value)||0;
    const paid=parseFloat(document.getElementById('pPaid').value)||0;
    // balance shown in paid field hint only ‚Äî no display element needed now
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(t){
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
    document.getElementById(t+'Tab').classList.add('active');
    document.getElementById('nav'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');
    updateUI();
}

async function migrateData(){
    const ms=await getCollection('members');
    for(let m of ms){if(m.groupId&&!m.groupIds){await db.collection('members').doc(m.id).update({groupIds:[m.groupId],groupId:firebase.firestore.FieldValue.delete()});}}
    updateUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UPDATE UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function updateUI(){
    const m=await getCollection('members');const g=await getCollection('groups');const p=await getCollection('payments');
    ALL_MEMBERS=m;
    if(CURRENT_USER && CURRENT_USER.role==='member'){
        // Member sees only their own group count and paid today
        const myPays=p.filter(x=>x.memberId===CURRENT_USER.memberId);
        const myGroups=new Set(myPays.map(x=>x.groupId));
        document.getElementById('memberCount').innerText='‚Äî';
        document.getElementById('groupCount').innerText=myGroups.size;
        const today=new Date().toISOString().split('T')[0];
        document.getElementById('todayColl').innerText=fmtAmt(myPays.filter(x=>x.date===today).reduce((s,x)=>s+(parseFloat(x.paid)||0),0));
        return;
    }
    document.getElementById('memberCount').innerText=m.length;
    document.getElementById('groupCount').innerText=g.length;
    const today=new Date().toISOString().split('T')[0];
    document.getElementById('todayColl').innerText=fmtAmt(p.filter(x=>x.date===today).reduce((s,x)=>s+(parseFloat(x.paid)||0),0));
    if(document.getElementById('groupsTab').classList.contains('active'))renderGroupsTab();
    if(document.getElementById('listTab').classList.contains('active'))renderListTab();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEARCH AUTOCOMPLETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function filterSearch(inputId,listId,hiddenId){
    const query=document.getElementById(inputId).value.toLowerCase();
    const list=document.getElementById(listId);
    list.innerHTML='';if(!query){list.style.display='none';return;}
    const filtered=ALL_MEMBERS.filter(m=>m.name.toLowerCase().includes(query));
    if(filtered.length>0){
        list.style.display='block';
        filtered.forEach(m=>{
            const div=document.createElement('div');div.className='suggestion-item';div.innerText=m.name;
            div.onclick=()=>{document.getElementById(inputId).value=m.name;document.getElementById(hiddenId).value=m.id;list.style.display='none';
                if(hiddenId==='summaryView')loadMemberLedger();if(hiddenId==='pMember')linkGroupForPayment();};
            list.appendChild(div);});
    }else{list.style.display='none';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEMBER LEDGER ‚Äî HOME TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadMemberLedger(){
    // Privacy guard: members can only view their own ledger
    const mid = CURRENT_USER && CURRENT_USER.role === 'member'
        ? CURRENT_USER.memberId
        : document.getElementById('summaryView').value;
    if(!mid) return;

    const ms=await getCollection('members');const gs=await getCollection('groups');const ps=await getCollection('payments');
    const m=ms.find(x=>x.id===mid);if(!m)return;
    const mPays=ps.filter(p=>p.memberId===mid);
    const totalPaid=mPays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
    const totalBal=mPays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
    const memberGroups=gs.filter(g=>m.groupIds&&m.groupIds.includes(g.id));

    const payTablesHtml=memberGroups.map((grp,gi)=>{
        const pays=mPays.filter(p=>p.groupId===grp.id).sort((a,b)=>(a.date||'').localeCompare(b.date||''));
        const allDueDates=getGroupDueDates(grp);
        const tPaid=pays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
        const tBal=pays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
        const tableId=`ledgerTable_${gi}`;
        const totalMonths=parseInt(grp.duration||grp.gDuration)||21;
        let elapsed=0;
        if(grp.startDate||grp.gStart){
            const s=new Date(grp.startDate||grp.gStart);
            const n=new Date();
            elapsed=Math.max(0,Math.min(totalMonths,(n.getFullYear()-s.getFullYear())*12+(n.getMonth()-s.getMonth())+1));
        }
        const left=Math.max(0,totalMonths-elapsed);
        const gStartDisplay=fmtDate(grp.startDate||grp.gStart||'');
        const gDueDayOrd=grp.dueDay?`${grp.dueDay}${['st','nd','rd'][((grp.dueDay%100-11)%10)-1]||'th'}`:'‚Äî';

        // Count multi-month payments
        const multiMonthCount=pays.filter(p=>p.numMonths&&p.numMonths>1).length;
        // Chit picked info
        const pickedPay=pays.find(p=>p.chitPicked==='Yes');
        const pickedAmt=pickedPay?(parseFloat(pickedPay.chit)||0)*(parseInt(pickedPay.numMonths)||1):0;
        const pickedBy=pickedPay&&pickedPay.chitPickedBy?pickedPay.chitPickedBy:'';

        const rows=pays.map((p,idx)=>{
            const cp=p.chitPicked==='Yes';
            const isMulti=p.numMonths&&p.numMonths>1;
            const months=p.monthSlots||[];
            // Determine month label
            let monthLabel='‚Äî';
            if(isMulti && months.length>0){
                const firstLabel=months[0]>=0&&allDueDates[months[0]]?fmtDate(allDueDates[months[0]]):'‚Äî';
                const lastLabel=months[months.length-1]>=0&&allDueDates[months[months.length-1]]?fmtDate(allDueDates[months[months.length-1]]):'‚Äî';
                monthLabel=`${firstLabel} ‚Üí ${lastLabel}`;
            } else {
                const slotIdx=p.monthSlot!==undefined?p.monthSlot:getMonthSlot(allDueDates,p.date);
                monthLabel=slotIdx>=0&&allDueDates[slotIdx]?fmtDate(allDueDates[slotIdx]):'‚Äî';
            }

            const rowClass=cp?'chit-picked':(isMulti?'multi-month-row':'');
            const chitPickedAmt=cp?(parseFloat(p.chit)||0)*(parseInt(p.numMonths)||1):0;
            return`<tr class="${rowClass}">
                <td style="color:var(--text-dim);font-weight:700;">${idx+1}</td>
                <td style="color:#a5b4fc;font-weight:700;white-space:normal;min-width:90px;font-size:0.62rem;">${monthLabel}${isMulti?`<br><span class="multi-month-badge">üìÖ ${p.numMonths} months</span>`:''}</td>
                <td>${fmtDate(p.date)}</td>
                <td style="color:#c4b5fd;">${fmtAmt(p.chit)}${isMulti?`<span style="font-size:0.55rem;color:var(--text-dim);display:block;">/mo √ó ${p.numMonths}</span>`:''}</td>
                <td style="color:#34d399;font-weight:700;">${fmtAmt(p.paid)}</td>
                <td style="color:#f59e0b;">${fmtAmt(p.balance)}</td>
                <td style="color:var(--text-dim);font-size:0.6rem;">${p.paidBy||'‚Äî'}</td>
                <td>${cp
                    ?`<div><span class="chit-yes-badge">‚úÖ Picked</span>${p.chitPickedBy?`<div style="font-size:0.58rem;color:var(--text-dim);margin-top:3px;">by ${p.chitPickedBy}</div>`:''}</div>`
                    :'<span class="chit-no">‚Äî</span>'}</td>
                <td><button class="btn-edit-sm" onclick="openEditPayment('${p.id}')" style="font-size:0.6rem;padding:3px 7px;">‚úèÔ∏è</button></td>
            </tr>`;
        }).join('');

        return`<div style="margin-bottom:12px;">
            <div style="background:#1c253b;border-radius:12px 12px 0 0;padding:10px 14px;border:1px solid var(--border);border-bottom:none;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
                <div>
                    <div style="font-size:0.8rem;font-weight:800;color:#f39c12;margin-bottom:4px;">üìÇ ${grp.name}</div>
                    <div style="display:flex;gap:5px;flex-wrap:wrap;">
                        <span style="font-size:0.58rem;background:rgba(99,102,241,.15);border:1px solid rgba(99,102,241,.3);border-radius:5px;padding:1px 6px;color:#a5b4fc;">üóì Started: ${gStartDisplay}</span>
                        ${grp.dueDay?`<span style="font-size:0.58rem;background:rgba(243,156,18,.12);border:1px solid rgba(243,156,18,.3);border-radius:5px;padding:1px 6px;color:#f39c12;">üìÖ Due: ${gDueDayOrd}</span>`:''}
                        ${multiMonthCount>0?`<span style="font-size:0.58rem;background:rgba(99,102,241,.18);border:1px solid rgba(99,102,241,.35);border-radius:5px;padding:1px 6px;color:#a5b4fc;">üì¶ ${multiMonthCount} bulk payment${multiMonthCount>1?'s':''}</span>`:''}
                    </div>
                </div>
                <div style="text-align:right;flex-shrink:0;">
                    <div style="font-size:1rem;font-weight:800;color:#a5b4fc;">${left}<span style="font-size:0.62rem;color:var(--text-dim);">/${totalMonths}</span></div>
                    <div style="font-size:0.55rem;color:var(--text-dim);text-transform:uppercase;">months pending</div>
                </div>
            </div>
            <div style="background:var(--card-bg);border:1px solid var(--border);border-radius:0 0 12px 12px;overflow:hidden;">
                <div onclick="toggleLedgerTable('${tableId}',this)" style="display:flex;justify-content:space-between;align-items:center;padding:9px 14px;cursor:pointer;user-select:none;border-bottom:1px solid var(--border);">
                    <span style="font-size:0.65rem;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:.6px;">Payment History (${pays.length} entries)</span>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:0.65rem;color:#34d399;">${fmtAmt(tPaid)} paid</span>
                        ${tBal>0?`<span style="font-size:0.65rem;color:#f59e0b;">${fmtAmt(tBal)} bal</span>`:''}
                        <span style="font-size:0.8rem;color:var(--text-dim);transition:transform .25s;" class="ledger-chevron">‚ñ∂</span>
                    </div>
                </div>
                <div id="${tableId}" style="display:none;">
                    <div style="overflow-x:auto;"><table class="table-custom">
                        <thead><tr><th>#</th><th>Month(s) Covered</th><th>Pay Date</th><th>Chit/Mo</th><th>Total Paid</th><th>Balance</th><th>Mode</th><th>Chit Picked Amt</th><th></th></tr></thead>
                        <tbody>${rows||`<tr><td colspan="9" style="text-align:center;color:var(--text-dim);padding:16px;">No payments yet</td></tr>`}
                        ${pays.length?`<tr style="font-weight:800;background:rgba(255,255,255,.04);">
                            <td colspan="4" style="color:var(--text-dim);">Total</td>
                            <td style="color:#34d399;">${fmtAmt(tPaid)}</td>
                            <td style="color:#f59e0b;">${fmtAmt(tBal)}</td>
                            <td colspan="3"></td>
                        </tr>`:''}
                        </tbody>
                    </table></div>
                    ${multiMonthCount>0?`<div style="padding:8px 14px 10px;font-size:0.62rem;color:#a5b4fc;border-top:1px solid var(--border);">
                        <span style="margin-right:6px;">üìÖ</span> Purple rows = multi-month bulk payments
                    </div>`:''}
                </div>
            </div>
        </div>`;
    }).join('');

    const isMember = CURRENT_USER && CURRENT_USER.role === 'member';
    const ledgerHtml = `
        <div style="display:flex;align-items:center;gap:14px;margin-bottom:12px;padding-top:4px;">
            <div style="width:44px;height:44px;border-radius:12px;background:rgba(243,156,18,.15);border:2px solid rgba(243,156,18,.4);color:#f39c12;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;flex-shrink:0;">${ini(m.name)}</div>
            <div style="flex:1;">
                <div style="font-size:1rem;font-weight:800;">${m.name}</div>
                <div style="font-size:0.68rem;color:var(--text-dim);">${mPays.length} payments ¬∑ ${memberGroups.length} group${memberGroups.length!==1?'s':''}</div>
            </div>
            ${!isMember?`<div style="display:flex;gap:6px;">
                <button class="btn-edit-sm" onclick="openEditMember('${mid}')">‚úèÔ∏è</button>
                <button class="btn-pdf" onclick="generateMemberPDF('${mid}')">üìÑ PDF</button>
            </div>`:`<button class="btn-pdf" onclick="generateMemberPDF('${mid}')">üìÑ PDF</button>`}
        </div>
        ${payTablesHtml||'<div style="text-align:center;color:var(--text-dim);padding:20px;">No payments yet</div>'}
    `;

    if(isMember){
        document.getElementById('memberLedgerData').innerHTML = ledgerHtml;
        // Update member header stats
        const myGroupCount = memberGroups.length;
        document.getElementById('mhGroups').textContent = myGroupCount;
        document.getElementById('mhTotalPaid').textContent = fmtAmt(totalPaid);
        document.getElementById('mhBalance').textContent = fmtAmt(totalBal);
    } else {
        document.getElementById('ledgerData').innerHTML = ledgerHtml;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEMBER CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openAddMember(){
    if(!isAdmin()){showToast('üö´ Access denied',false);return;}
    document.getElementById('mName').value='';document.getElementById('mPhone').value='';
    document.getElementById('memberModalTitle').textContent='üë§ Create Member';
    document.getElementById('deleteMemberArea').style.display='none';
    const gs=await getCollection('groups');
    document.getElementById('groupCheckboxes').innerHTML=gs.map(g=>`
        <div class="d-flex gap-2 align-items-center p-1">
            <input type="checkbox" class="group-cb" value="${g.id}" style="accent-color:#f39c12;width:16px;height:16px;">
            <span style="font-size:0.9rem;">${g.name}</span>
        </div>`).join('');
    openModal('memberModal');
}

async function openEditMember(mid){
    if(!isAdmin()){showToast('üö´ Access denied',false);return;}
    const ms=await getCollection('members');const m=ms.find(x=>x.id===mid);if(!m)return;
    document.getElementById('editMemberId').value=m.id;
    document.getElementById('mName').value=m.name||'';
    document.getElementById('mPhone').value=m.phone||'';
    document.getElementById('memberModalTitle').textContent='‚úèÔ∏è Edit Member';
    document.getElementById('deleteMemberArea').style.display='block';
    const gs=await getCollection('groups');
    document.getElementById('groupCheckboxes').innerHTML=gs.map(g=>`
        <div class="d-flex gap-2 align-items-center p-1">
            <input type="checkbox" class="group-cb" value="${g.id}" ${m.groupIds&&m.groupIds.includes(g.id)?'checked':''} style="accent-color:#f39c12;width:16px;height:16px;">
            <span style="font-size:0.9rem;">${g.name}</span>
        </div>`).join('');
    openModal('memberModal');
}

async function saveMember(){
    if(!isAdmin()){showToast('üö´ Access denied',false);return;}
    const n=document.getElementById('mName').value.trim();
    const p=document.getElementById('mPhone').value.trim();
    const eid=document.getElementById('editMemberId').value;
    const gids=Array.from(document.querySelectorAll('.group-cb:checked')).map(cb=>cb.value);
    if(!n)return showToast('‚ùå Enter member name',false);
    if(gids.length===0)return showToast('‚ùå Select at least one group',false);
    if(eid)await db.collection('members').doc(eid).update({name:n,phone:p,groupIds:gids});
    else await db.collection('members').add({name:n,phone:p,groupIds:gids});
    closeModal('memberModal');showToast(`‚úÖ Member "${n}" saved!`);updateUI();
}

function deleteMemberFromModal(){
    const eid=document.getElementById('editMemberId').value;if(!eid)return;
    const name=document.getElementById('mName').value;
    showConfirm('üóë','Delete Member?',`This will permanently delete "${name}" and ALL their payment records.`,async()=>{
        const pays=await db.collection('payments').where('memberId','==',eid).get();
        const batch=db.batch();
        pays.docs.forEach(d=>batch.delete(d.ref));
        await batch.commit();
        await db.collection('members').doc(eid).delete();
        closeModal('memberModal');
        if(document.getElementById('summaryView').value===eid){
            document.getElementById('summaryView').value='';
            document.getElementById('summarySearch').value='';
            document.getElementById('ledgerData').innerHTML='';
        }
        showToast('üóë Member & all payments deleted');updateUI();
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GROUP CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddGroup(){
    if(!isAdmin()){showToast('üö´ Access denied',false);return;}
    document.getElementById('gName').value='';
    document.getElementById('gDuration').value='';
    document.getElementById('gDueDay').value='';
    document.getElementById('gStart').value='';
    document.getElementById('groupModalTitle').textContent='üè¶ New Group';
    document.getElementById('deleteGroupArea').style.display='none';
    openModal('groupModal');
}

async function openEditGroup(gid){
    if(!isAdmin()){showToast('üö´ Access denied',false);return;}
    const gs=await getCollection('groups');const g=gs.find(x=>x.id===gid);if(!g)return;
    document.getElementById('editGroupId').value=g.id;
    document.getElementById('gName').value=g.name||'';
    document.getElementById('gDuration').value=g.duration||g.gDuration||'';
    document.getElementById('gDueDay').value=g.dueDay||'';
    document.getElementById('gStart').value=g.startDate||g.gStart||'';
    document.getElementById('groupModalTitle').textContent='‚úèÔ∏è Edit Group';
    document.getElementById('deleteGroupArea').style.display='block';
    openModal('groupModal');
}

async function saveGroup(){
    if(!isAdmin()){showToast('üö´ Access denied',false);return;}
    const name=document.getElementById('gName').value.trim();
    const duration=document.getElementById('gDuration').value;
    const dueDay=parseInt(document.getElementById('gDueDay').value)||null;
    const startDate=document.getElementById('gStart').value;
    const eid=document.getElementById('editGroupId').value;
    if(!name)return showToast('‚ùå Enter group name',false);
    if(dueDay&&(dueDay<1||dueDay>31))return showToast('‚ùå Due Day must be 1‚Äì31',false);
    const data={name,duration,startDate};
    if(dueDay) data.dueDay=dueDay;
    if(eid)await db.collection('groups').doc(eid).update(data);
    else await db.collection('groups').add(data);
    closeModal('groupModal');showToast(`‚úÖ Group "${name}" saved!`);updateUI();
}

function deleteGroupFromModal(){
    const eid=document.getElementById('editGroupId').value;if(!eid)return;
    const name=document.getElementById('gName').value;
    showConfirm('üóë','Delete Group?',`This will permanently delete "${name}". Member assignments and payments will remain.`,async()=>{
        await db.collection('groups').doc(eid).delete();
        closeModal('groupModal');showToast('üóë Group deleted');updateUI();
    });
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAYMENT FORM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function resetPaymentForm(){
    document.getElementById('pDate').value=new Date().toISOString().split('T')[0];
    document.getElementById('pMemberSearch').value='';
    document.getElementById('pMember').value='';
    document.getElementById('pMemberList').style.display='none';
    document.getElementById('pGroup').innerHTML='<option value="">-- Select Member First --</option>';
    document.getElementById('pChit').value='';
    document.getElementById('pPaid').value='';
    document.getElementById('pPaidBy').value='';
    document.getElementById('pChitPicked').value='No';
    document.getElementById('pChitPickedBy').value='';
    document.getElementById('chitPickedNameDiv').style.display='none';
    const sel=document.getElementById('pChitPicked');
    [...sel.options].forEach(o=>o.disabled=false);
    sel.title='';
}

function openPaymentModal(){
    if(!isAdmin()){showToast('üö´ Access denied',false);return;}
    resetPaymentForm();
    openModal('paymentModal');
}

async function linkGroupForPayment(){
    const mid=document.getElementById('pMember').value;
    const ms=await getCollection('members');const m=ms.find(x=>x.id===mid);if(!m)return;
    const gs=await getCollection('groups');
    document.getElementById('pGroup').innerHTML=gs.filter(g=>m.groupIds&&m.groupIds.includes(g.id)).map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
    await onGroupChange();
}

async function onGroupChange(){
    document.getElementById('pChit').value='';
    document.getElementById('pPaid').value='';
    // Check if member already picked chit in this group
    const mid=document.getElementById('pMember').value;
    const gid=document.getElementById('pGroup').value;
    if(mid&&gid){
        const ps=await getCollection('payments');
        const alreadyPicked=ps.some(p=>p.memberId===mid&&p.groupId===gid&&p.chitPicked==='Yes');
        const sel=document.getElementById('pChitPicked');
        if(alreadyPicked){
            sel.value='No';
            [...sel.options].forEach(o=>{if(o.value==='Yes')o.disabled=true;});
            sel.title='This member already picked the chit in this group';
            document.getElementById('chitPickedNameDiv').style.display='none';
        } else {
            [...sel.options].forEach(o=>o.disabled=false);
            sel.title='';
        }
    }
}

async function savePayment(){
    if(!isAdmin()){showToast('üö´ Access denied',false);return;}
    const mid=document.getElementById('pMember').value;
    const gid=document.getElementById('pGroup').value;
    const date=document.getElementById('pDate').value;
    const chitPerMonth=parseFloat(document.getElementById('pChit').value)||0;
    const paid=parseFloat(document.getElementById('pPaid').value)||0;
    const paidBy=document.getElementById('pPaidBy').value;
    const chitPicked=document.getElementById('pChitPicked').value;
    const chitPickedBy=document.getElementById('pChitPickedBy').value.trim();

    if(!mid)return showToast('‚ùå Select a member',false);
    if(!gid)return showToast('‚ùå Select a group',false);
    if(!date)return showToast('‚ùå Enter date',false);
    if(!paid)return showToast('‚ùå Enter amount paid',false);

    if(chitPicked==='Yes'){
        const ps=await getCollection('payments');
        const alreadyPicked=ps.some(p=>p.memberId===mid&&p.groupId===gid&&p.chitPicked==='Yes');
        if(alreadyPicked)return showToast('‚ùå This member already picked the chit',false);
    }

    const gs=await getCollection('groups');
    const grp=gs.find(g=>g.id===gid);
    const dueDates=grp?getGroupDueDates(grp):[];
    const slotIdx=getMonthSlot(dueDates,date);
    const balance=Math.max(0,chitPerMonth-paid);
    await db.collection('payments').add({
        memberId:mid, groupId:gid, date,
        chit:chitPerMonth, paid, balance, paidBy, chitPicked, chitPickedBy,
        numMonths:1,
        monthSlot:slotIdx>=0?slotIdx:null,
        monthSlots:slotIdx>=0?[slotIdx]:[]
    });
    showToast('‚úÖ Payment saved!');
    closeModal('paymentModal');
    updateUI();
    if(document.getElementById('summaryView').value===mid) loadMemberLedger();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDIT / DELETE EXISTING PAYMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openEditPayment(pid){
    if(!isAdmin()){showToast('üö´ Access denied',false);return;}
    const ps=await getCollection('payments');
    const p=ps.find(x=>x.id===pid);if(!p)return;
    document.getElementById('epId').value=pid;
    document.getElementById('epDate').value=p.date||'';
    document.getElementById('epChit').value=p.chit||'';
    document.getElementById('epPaid').value=p.paid||'';
    document.getElementById('epBal').value=p.balance||'';
    document.getElementById('epPaidBy').value=p.paidBy||'';
    document.getElementById('epChitPicked').value=p.chitPicked||'No';
    document.getElementById('epChitPickedBy').value=p.chitPickedBy||'';
    document.getElementById('epChitPickedNameDiv').style.display=p.chitPicked==='Yes'?'block':'none';

    // Show multi-month info if applicable
    const infoBox=document.getElementById('epMultiMonthInfo');
    const detailEl=document.getElementById('epMultiMonthDetail');
    if(p.numMonths&&p.numMonths>1){
        infoBox.style.display='block';

        // Get group for due dates
        const gs=await getCollection('groups');
        const grp=gs.find(g=>g.id===p.groupId);
        let slotLabels='';
        if(grp&&p.monthSlots){
            const dueDates=getGroupDueDates(grp);
            slotLabels=p.monthSlots.map((s,i)=>dueDates[s]?fmtDate(dueDates[s]):`Month ${s+1}`).join(' ‚Üí ');
        }
        detailEl.innerHTML=`Covers <strong>${p.numMonths} months</strong>${slotLabels?': '+slotLabels:''}`;
    } else {
        infoBox.style.display='none';
    }

    openModal('editPaymentModal');
}

function epCalcBalance(){
    const chit=parseFloat(document.getElementById('epChit').value)||0;
    const paid=parseFloat(document.getElementById('epPaid').value)||0;
    document.getElementById('epBal').value=Math.max(0,chit-paid);
}
function epTogglePickedName(){
    document.getElementById('epChitPickedNameDiv').style.display=document.getElementById('epChitPicked').value==='Yes'?'block':'none';
}

async function saveEditPayment(){
    if(!isAdmin()){showToast('üö´ Access denied',false);return;}
    const pid=document.getElementById('epId').value;if(!pid)return;
    const date=document.getElementById('epDate').value;
    const chit=parseFloat(document.getElementById('epChit').value)||0;
    const paid=parseFloat(document.getElementById('epPaid').value)||0;
    const balance=Math.max(0,chit-paid);
    const paidBy=document.getElementById('epPaidBy').value;
    const chitPicked=document.getElementById('epChitPicked').value;
    const chitPickedBy=document.getElementById('epChitPickedBy').value.trim();
    if(!date)return showToast('‚ùå Enter date',false);
    if(!paid)return showToast('‚ùå Enter amount paid',false);
    await db.collection('payments').doc(pid).update({date,chit,paid,balance,paidBy,chitPicked,chitPickedBy});
    closeModal('editPaymentModal');showToast('‚úÖ Payment updated!');updateUI();
    const mid=document.getElementById('summaryView').value;
    if(mid)loadMemberLedger();
}

async function deletePayment(){
    if(!isAdmin()){showToast('üö´ Access denied',false);return;}
    const pid=document.getElementById('epId').value;if(!pid)return;
    showConfirm('üóë','Delete Payment?','This will permanently delete this payment record.',async()=>{
        await db.collection('payments').doc(pid).delete();
        closeModal('editPaymentModal');showToast('üóë Payment deleted');updateUI();
        const mid=document.getElementById('summaryView').value;
        if(mid)loadMemberLedger();
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GROUPS TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderGroupsTab(){
    const gs=await getCollection('groups');const ms=await getCollection('members');const ps=await getCollection('payments');
    if(!gs.length){document.getElementById('groupListArea').innerHTML='<div style="text-align:center;color:var(--text-dim);padding:40px;">No groups yet.</div>';return;}
    document.getElementById('groupListArea').innerHTML=gs.map((g,gIdx)=>{
        const gMs=ms.filter(m=>m.groupIds&&m.groupIds.includes(g.id));
        const gPays=ps.filter(p=>p.groupId===g.id);
        const tPaid=gPays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
        const tBal=gPays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
        const picked=gPays.filter(p=>p.chitPicked==='Yes').length;
        const totalMonths=parseInt(g.duration||g.gDuration)||21;
        let elapsed=0;
        if(g.startDate||g.gStart){const _s=new Date(g.startDate||g.gStart),_n=new Date();elapsed=Math.max(0,Math.min(totalMonths,(_n.getFullYear()-_s.getFullYear())*12+(_n.getMonth()-_s.getMonth())+1));}
        const left=Math.max(0,totalMonths-elapsed);const pct=Math.min(100,Math.round(elapsed/totalMonths*100));

        const memberRows=gMs.map((m,i)=>{
            const mp=ps.filter(p=>p.memberId===m.id&&p.groupId===g.id);
            const paid=mp.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
            const bal=mp.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
            const pickedPay=mp.find(p=>p.chitPicked==='Yes');
            // Chit picked amount = chit per month √ó numMonths for that payment record
            const pickedAmt=pickedPay?(parseFloat(pickedPay.chit)||0)*(parseInt(pickedPay.numMonths)||1):0;
            const pickedBy=pickedPay&&pickedPay.chitPickedBy?pickedPay.chitPickedBy:'';
            const monthsCovered=mp.reduce((s,p)=>s+(p.numMonths||1),0);
            return`<tr${pickedPay?' class="chit-picked"':''}>
                <td>${i+1}</td>
                <td><strong>${m.name}</strong><br><span style="font-size:0.6rem;color:var(--text-dim);">${m.phone||''}</span></td>
                <td style="color:#34d399;">${fmtAmt(paid)}</td>
                <td style="color:#f59e0b;">${fmtAmt(bal)}</td>
                <td style="color:#a5b4fc;font-size:0.65rem;">${monthsCovered}/${totalMonths}</td>
                <td>${pickedPay
                    ?`<div><span class="chit-yes-badge">‚úÖ Picked</span><div style="color:#34d399;font-weight:800;font-size:0.72rem;margin-top:3px;">${fmtAmt(pickedAmt)}</div>${pickedBy?`<div style="font-size:0.58rem;color:var(--text-dim);">by ${pickedBy}</div>`:''}</div>`
                    :'<span class="chit-no">‚Äî</span>'}</td>
                <td><button class="btn-edit-sm" onclick="openEditMember('${m.id}')">‚úèÔ∏è</button></td>
            </tr>`;}).join('');

        const gStartDisp=fmtDate(g.startDate||g.gStart||'');
        const gDueDayDisp=g.dueDay?`${g.dueDay}${['st','nd','rd'][((g.dueDay%100-11)%10)-1]||'th'} of month`:'‚Äî';
        const bodyId=`grpBody_${gIdx}`;
        return`<div class="group-card">
            <div class="group-card-header" onclick="toggleGroupCard('${bodyId}',this)">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <div>
                        <div style="font-size:1rem;font-weight:800;color:#f39c12;">üìÇ ${g.name}</div>
                        <div style="font-size:0.68rem;color:var(--text-dim);">${gMs.length} members ¬∑ ${gPays.length} payment entries</div>
                        <div style="display:flex;gap:6px;margin-top:5px;flex-wrap:wrap;">
                            <span style="font-size:0.62rem;background:rgba(99,102,241,.15);border:1px solid rgba(99,102,241,.3);border-radius:6px;padding:2px 7px;color:#a5b4fc;">üóì Started: ${gStartDisp}</span>
                            ${g.dueDay?`<span style="font-size:0.62rem;background:rgba(243,156,18,.12);border:1px solid rgba(243,156,18,.3);border-radius:6px;padding:2px 7px;color:#f39c12;">üìÖ Due: ${gDueDayDisp}</span>`:''}
                        </div>
                    </div>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <button onclick="generateGroupPDF('${g.id}');event.stopPropagation();" class="btn-pdf" style="padding:5px 10px;font-size:0.7rem;">üìÑ PDF</button>
                        <button onclick="openEditGroup('${g.id}');event.stopPropagation();" class="btn-edit-sm">‚úèÔ∏è Edit</button>
                        <span class="chevron-icon closed">‚ñº</span>
                    </div>
                </div>
                <div class="row g-2 mt-2">
                    <div class="col-3"><div class="mini-stat" style="border-top:2px solid #34d399;"><div class="mini-stat-lbl">Collected</div><div class="mini-stat-val" style="color:#34d399;">${fmtAmt(tPaid)}</div></div></div>
                    <div class="col-3"><div class="mini-stat" style="border-top:2px solid #f59e0b;"><div class="mini-stat-lbl">Balance</div><div class="mini-stat-val" style="color:#f59e0b;">${fmtAmt(tBal)}</div></div></div>
                    <div class="col-3"><div class="mini-stat" style="border-top:2px solid #a5b4fc;"><div class="mini-stat-lbl">Pending</div><div class="mini-stat-val" style="color:#a5b4fc;">${left}/${totalMonths}</div></div></div>
                    <div class="col-3"><div class="mini-stat" style="border-top:2px solid #34d399;"><div class="mini-stat-lbl">Picked</div><div class="mini-stat-val" style="color:#34d399;">${picked}</div></div></div>
                </div>
                <div class="prog-bar-outer mt-2"><div class="prog-bar-inner" style="width:${pct}%"></div></div>
                <div class="prog-label" style="margin-top:3px;"><span>Month ${elapsed}/${totalMonths}</span><span>${left}/${totalMonths} months pending</span></div>
            </div>
            <div class="group-body" id="${bodyId}" style="max-height:0px;opacity:0;margin-top:0;">
                ${gMs.length?`<div style="overflow-x:auto;"><table class="table-custom">
                    <thead><tr><th>#</th><th>Member</th><th>Paid</th><th>Balance</th><th>Months</th><th>Chit Picked Amt</th><th></th></tr></thead>
                    <tbody>${memberRows}</tbody>
                </table></div>`:'<div style="text-align:center;color:var(--text-dim);font-size:0.8rem;padding:10px;">No members yet</div>'}
            </div>
        </div>`;
    }).join('');
}

function toggleGroupCard(bodyId, header){
    const body=document.getElementById(bodyId);
    const chevron=header.querySelector('.chevron-icon');
    if(!body) return;
    const isOpen=body.style.maxHeight!=='0px'&&!body.classList.contains('collapsed');
    if(isOpen){
        body.style.maxHeight='0px';body.style.opacity='0';body.style.marginTop='0';
        if(chevron){chevron.classList.remove('open');chevron.classList.add('closed');}
    } else {
        body.style.maxHeight='2000px';body.style.opacity='1';body.style.marginTop='12px';
        if(chevron){chevron.classList.remove('closed');chevron.classList.add('open');}
    }
}

function toggleLedgerTable(id, header){
    const el=document.getElementById(id);
    if(!el)return;
    const chevron=header.querySelector('.ledger-chevron');
    const isOpen=el.style.display!=='none';
    el.style.display=isOpen?'none':'block';
    if(chevron)chevron.style.transform=isOpen?'rotate(0deg)':'rotate(90deg)';
}

async function renderListTab(){
    const gs=await getCollection('groups');const ms=await getCollection('members');const ps=await getCollection('payments');
    document.getElementById('simpleListArea').innerHTML=gs.map((g,gi)=>{
        const gMs=ms.filter(m=>m.groupIds&&m.groupIds.includes(g.id));
        const gPays=ps.filter(p=>p.groupId===g.id);
        const totalMonths=parseInt(g.duration||g.gDuration)||21;
        const listId=`listGroup_${gi}`;
        const tCollected=gPays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
        const tBalance=gPays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);

        const memberCards=gMs.map((m,i)=>{
            const mp=ps.filter(p=>p.memberId===m.id&&p.groupId===g.id)
                       .sort((a,b)=>(b.date||'').localeCompare(a.date||''));
            const totalPaid=mp.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
            const totalBal=mp.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
            const monthsCovered=mp.reduce((s,p)=>s+(p.numMonths||1),0);
            const lastPay=mp[0];
            const lastDate=lastPay?fmtDate(lastPay.date):'‚Äî';
            const lastMode=lastPay&&lastPay.paidBy?lastPay.paidBy:'‚Äî';
            const modes=[...new Set(mp.map(p=>p.paidBy).filter(Boolean))];
            const pickedPay=mp.find(p=>p.chitPicked==='Yes');
            const pickedAmt=pickedPay?(parseFloat(pickedPay.chit)||0)*(parseInt(pickedPay.numMonths)||1):0;

            return`<div style="border-bottom:1px solid rgba(255,255,255,0.05);padding:12px 16px;">
                <!-- Member name row -->
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                    <div style="width:32px;height:32px;border-radius:9px;background:rgba(243,156,18,.15);border:1.5px solid rgba(243,156,18,.3);color:#f39c12;display:flex;align-items:center;justify-content:center;font-size:0.72rem;font-weight:900;flex-shrink:0;">${ini(m.name)}</div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:800;font-size:0.88rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${m.name}</div>
                        <div style="font-size:0.65rem;color:var(--text-dim);">üì± ${m.phone||'‚Äî'}</div>
                    </div>
                    ${pickedPay?`<span class="chit-yes-badge" style="flex-shrink:0;">‚úÖ Picked</span>`:''}
                    <button class="btn-edit-sm" onclick="openEditMember('${m.id}')" style="flex-shrink:0;">‚úèÔ∏è</button>
                </div>
                <!-- Stats grid -->
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:6px;">
                    <div style="background:rgba(52,211,153,.07);border:1px solid rgba(52,211,153,.2);border-radius:9px;padding:7px 8px;text-align:center;">
                        <div style="font-size:0.75rem;font-weight:800;color:#34d399;">${fmtAmt(totalPaid)}</div>
                        <div style="font-size:0.55rem;color:var(--text-dim);text-transform:uppercase;margin-top:1px;">Total Paid</div>
                    </div>
                    <div style="background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);border-radius:9px;padding:7px 8px;text-align:center;">
                        <div style="font-size:0.75rem;font-weight:800;color:#f59e0b;">${fmtAmt(totalBal)}</div>
                        <div style="font-size:0.55rem;color:var(--text-dim);text-transform:uppercase;margin-top:1px;">Balance</div>
                    </div>
                    <div style="background:rgba(165,180,252,.07);border:1px solid rgba(165,180,252,.2);border-radius:9px;padding:7px 8px;text-align:center;">
                        <div style="font-size:0.75rem;font-weight:800;color:#a5b4fc;">${monthsCovered}/${totalMonths}</div>
                        <div style="font-size:0.55rem;color:var(--text-dim);text-transform:uppercase;margin-top:1px;">Months</div>
                    </div>
                </div>
                <!-- Meta row -->
                <div style="display:flex;flex-wrap:wrap;gap:5px;align-items:center;">
                    ${mp.length?`<span style="font-size:0.6rem;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:5px;padding:2px 7px;color:var(--text-dim);">üìÖ Last: ${lastDate}</span>`:''}
                    ${modes.length?modes.map(mode=>`<span style="font-size:0.6rem;background:rgba(99,102,241,.1);border:1px solid rgba(99,102,241,.25);border-radius:5px;padding:2px 7px;color:#a5b4fc;">${mode}</span>`).join(''):''}
                    ${pickedPay?`<span style="font-size:0.6rem;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.25);border-radius:5px;padding:2px 7px;color:#34d399;">üèÜ ${fmtAmt(pickedAmt)}${pickedPay.chitPickedBy?' ¬∑ '+pickedPay.chitPickedBy:''}</span>`:''}
                    ${mp.length===0?`<span style="font-size:0.6rem;color:#f87171;">‚ö† No payments yet</span>`:''}
                </div>
            </div>`;
        }).join('');

        return`<div class="list-group-header" onclick="toggleListGroup('${listId}',this)">
            <div>
                <div style="font-weight:800;">${g.name}</div>
                <div style="font-size:0.62rem;color:var(--text-dim);margin-top:2px;">${gMs.length} members ¬∑ ${fmtAmt(tCollected)} collected ¬∑ ${fmtAmt(tBalance)} balance</div>
            </div>
            <span style="display:flex;align-items:center;gap:8px;">
                <span class="list-chevron" style="font-size:0.8rem;color:var(--text-dim);transition:transform .25s;transform:rotate(-90deg);">‚ñº</span>
            </span>
        </div>
        <div id="${listId}" style="display:none;">${memberCards||'<div style="padding:16px;text-align:center;color:var(--text-dim);font-size:0.8rem;">No members in this group</div>'}</div>`;
    }).join('')||'<div style="text-align:center;color:var(--text-dim);padding:40px;">No groups yet.</div>';
}

function toggleListGroup(id,header){
    const el=document.getElementById(id);
    const ch=header.querySelector('.list-chevron');
    const open=el.style.display!=='none';
    el.style.display=open?'none':'block';
    ch.style.transform=open?'rotate(-90deg)':'rotate(0deg)';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACKUP / RESTORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function exportFullBackup(){
    if(!isAdmin()){showToast('üö´ Access denied',false);return;}
    const d={m:await getCollection('members'),g:await getCollection('groups'),p:await getCollection('payments')};
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json'}));
    a.download=`AK_Chit_Backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();showToast('‚úÖ Backup downloaded!');
}

async function exportToExcel(){
    if(!isAdmin()){showToast('üö´ Access denied',false);return;}
    showToast('‚è≥ Generating Excel‚Ä¶',true);
    const members=await getCollection('members');
    const groups=await getCollection('groups');
    const payments=await getCollection('payments');
    const wb=XLSX.utils.book_new();
    const today=new Date().toISOString().split('T')[0];

    // ‚îÄ‚îÄ Sheet 1: Members ‚îÄ‚îÄ
    const mRows=members.map(m=>({
        'Name':m.name||'',
        'Phone':m.phone||'',
        'Groups':((m.groupIds||[]).map(gid=>{const g=groups.find(x=>x.id===gid);return g?g.name:gid;})).join(', '),
    }));
    const wsM=XLSX.utils.json_to_sheet(mRows.length?mRows:[{'Name':'','Phone':'','Groups':''}]);
    wsM['!cols']=[{wch:28},{wch:16},{wch:40}];
    XLSX.utils.book_append_sheet(wb,wsM,'Members');

    // ‚îÄ‚îÄ Sheet 2: Groups ‚îÄ‚îÄ
    const gRows=groups.map(g=>{
        const gPays=payments.filter(p=>p.groupId===g.id);
        const gMs=members.filter(m=>m.groupIds&&m.groupIds.includes(g.id));
        return{
            'Group Name':g.name||'',
            'Duration (Months)':g.duration||g.gDuration||'',
            'Start Date':g.startDate||g.gStart||'',
            'Due Day':g.dueDay||'',
            'Members':gMs.length,
            'Total Collected':gPays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0),
            'Total Balance':gPays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0),
            'Chits Picked':gPays.filter(p=>p.chitPicked==='Yes').length,
        };
    });
    const wsG=XLSX.utils.json_to_sheet(gRows.length?gRows:[{}]);
    wsG['!cols']=[{wch:24},{wch:18},{wch:14},{wch:10},{wch:10},{wch:18},{wch:14},{wch:14}];
    XLSX.utils.book_append_sheet(wb,wsG,'Groups');

    // ‚îÄ‚îÄ Sheet 3: All Payments ‚îÄ‚îÄ
    const pRows=payments.map(p=>{
        const m=members.find(x=>x.id===p.memberId);
        const g=groups.find(x=>x.id===p.groupId);
        return{
            'Date':p.date||'',
            'Member':m?m.name:'Unknown',
            'Phone':m?m.phone||'':'',
            'Group':g?g.name:'Unknown',
            'Chit/Month':parseFloat(p.chit)||0,
            'Months':p.numMonths||1,
            'Total Paid':parseFloat(p.paid)||0,
            'Balance':parseFloat(p.balance)||0,
            'Mode':p.paidBy||'',
            'Chit Picked':p.chitPicked||'No',
            'Chit Picked Value':p.chitPickedBy||'',
        };
    }).sort((a,b)=>a['Date'].localeCompare(b['Date']));
    const wsP=XLSX.utils.json_to_sheet(pRows.length?pRows:[{}]);
    wsP['!cols']=[{wch:12},{wch:24},{wch:14},{wch:20},{wch:12},{wch:8},{wch:12},{wch:12},{wch:14},{wch:12},{wch:18}];
    XLSX.utils.book_append_sheet(wb,wsP,'All Payments');

    // ‚îÄ‚îÄ Sheet 4: Member Summary (one row per member per group) ‚îÄ‚îÄ
    const sumRows=[];
    members.forEach(m=>{
        (m.groupIds||[]).forEach(gid=>{
            const g=groups.find(x=>x.id===gid);
            const mp=payments.filter(p=>p.memberId===m.id&&p.groupId===gid);
            const pickedPay=mp.find(p=>p.chitPicked==='Yes');
            sumRows.push({
                'Member':m.name||'',
                'Phone':m.phone||'',
                'Group':g?g.name:'',
                'Months Paid':mp.reduce((s,p)=>s+(p.numMonths||1),0),
                'Total Paid':mp.reduce((s,p)=>s+(parseFloat(p.paid)||0),0),
                'Total Balance':mp.reduce((s,p)=>s+(parseFloat(p.balance)||0),0),
                'Chit Picked':pickedPay?'Yes':'No',
                'Chit Picked Value':pickedPay?pickedPay.chitPickedBy||'':'',
                'Last Payment':mp.length?mp.sort((a,b)=>b.date.localeCompare(a.date))[0].date:'',
            });
        });
    });
    const wsS=XLSX.utils.json_to_sheet(sumRows.length?sumRows:[{}]);
    wsS['!cols']=[{wch:24},{wch:14},{wch:20},{wch:12},{wch:12},{wch:14},{wch:12},{wch:18},{wch:14}];
    XLSX.utils.book_append_sheet(wb,wsS,'Member Summary');

    XLSX.writeFile(wb,`AKChitFunds_Export_${today}.xlsx`);
    showToast('‚úÖ Excel exported!');
}

function confirmRestore(){
    if(!isAdmin()){showToast('üö´ Access denied',false);return;}
    const file=document.getElementById('restoreFile').files[0];
    if(!file)return showToast('‚ùå Select a backup file first',false);
    showConfirm('üîÑ','Restore All Data?','This will overwrite ALL existing data.',()=>executeRestore());
}

async function executeRestore(){
    const file=document.getElementById('restoreFile').files[0];if(!file)return;
    showToast('‚è≥ Restoring‚Ä¶',true);
    const reader=new FileReader();
    reader.onload=async(e)=>{
        try{
            const data=JSON.parse(e.target.result);
            const delCol=async(col)=>{const s=await db.collection(col).get();const batch=db.batch();s.docs.forEach(d=>batch.delete(d.ref));if(s.docs.length)await batch.commit();};
            await delCol('members');await delCol('groups');await delCol('payments');
            let count=0;
            if(data.m)for(let x of data.m){const {id,...rest}=x;await db.collection('members').doc(id).set(rest);count++;}
            if(data.g)for(let x of data.g){const {id,...rest}=x;await db.collection('groups').doc(id).set(rest);count++;}
            if(data.p)for(let x of data.p){const {id,...rest}=x;await db.collection('payments').doc(id).set(rest);count++;}
            showToast(`‚úÖ Restored ${count} records!`);updateUI();
        }catch(err){console.error(err);showToast('‚ùå Invalid backup file',false);}
    };
    reader.readAsText(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF RENDER HELPER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPDF(filename){
    return new Promise((resolve)=>{
        const wrapper=document.getElementById('pdf-template');
        const content=document.getElementById('pdfContent');
        wrapper.classList.add('rendering');
        wrapper.style.visibility='visible';

        const opt={
            margin:[8,8,8,8],
            filename,
            image:{type:'jpeg',quality:0.97},
            html2canvas:{scale:2,useCORS:true,logging:false,allowTaint:false,backgroundColor:'#ffffff'},
            jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},
            pagebreak:{mode:['avoid-all','css','legacy']}
        };

        setTimeout(()=>{
            html2pdf().set(opt).from(content).save().then(()=>{
                wrapper.classList.remove('rendering');
                wrapper.style.visibility='hidden';
                resolve();
            }).catch(err=>{
                console.error('PDF error:',err);
                wrapper.classList.remove('rendering');
                wrapper.style.visibility='hidden';
                resolve();
            });
        },400);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF ‚Äî MEMBER STATEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateMemberPDF(mid){
    showToast('‚è≥ Generating PDF‚Ä¶',true);
    const ms=await getCollection('members');const gs=await getCollection('groups');const ps=await getCollection('payments');
    const m=ms.find(x=>x.id===mid);if(!m)return;
    const mPays=ps.filter(p=>p.memberId===mid);
    const totalPaid=mPays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
    const totalBal=mPays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
    const chitsPicked=mPays.filter(p=>p.chitPicked==='Yes').length;
    const memberGroups=gs.filter(g=>m.groupIds&&m.groupIds.includes(g.id));
    const today=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});

    const grouped={};
    mPays.forEach(p=>{const gid=p.groupId||'unk';if(!grouped[gid])grouped[gid]=[];grouped[gid].push(p);});

    const groupSections=memberGroups.map(g=>{
        const pays=(grouped[g.id]||[]).sort((a,b)=>(a.date||'').localeCompare(b.date||''));
        const totalMonths=parseInt(g.duration||g.gDuration)||21;
        let elapsed=0;
        if(g.startDate||g.gStart){const _s=new Date(g.startDate||g.gStart),_n=new Date();elapsed=Math.max(0,Math.min(totalMonths,(_n.getFullYear()-_s.getFullYear())*12+(_n.getMonth()-_s.getMonth())+1));}
        const left=Math.max(0,totalMonths-elapsed);
        const pct=Math.min(100,Math.round(elapsed/totalMonths*100));
        const gPaid=pays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
        const gBal=pays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
        const allDueDates=getGroupDueDates(g);
        const gStartDisp=fmtDate(g.startDate||g.gStart||'');
        const gDueDayDisp=g.dueDay?`${g.dueDay}${['st','nd','rd'][((g.dueDay%100-11)%10)-1]||'th'} of month`:'‚Äî';
        const totalMonthsCovered=pays.reduce((s,p)=>s+(p.numMonths||1),0);

        const rows=pays.map((p,idx)=>{
            const cp=p.chitPicked==='Yes';
            const isMulti=p.numMonths&&p.numMonths>1;
            let monthLabel='‚Äî';
            if(isMulti&&p.monthSlots&&p.monthSlots.length>0){
                const f=allDueDates[p.monthSlots[0]]?fmtDate(allDueDates[p.monthSlots[0]]):'‚Äî';
                const l=allDueDates[p.monthSlots[p.monthSlots.length-1]]?fmtDate(allDueDates[p.monthSlots[p.monthSlots.length-1]]):'‚Äî';
                monthLabel=`${f} ‚Üí ${l}`;
            } else {
                const slotIdx=p.monthSlot!==undefined?p.monthSlot:getMonthSlot(allDueDates,p.date);
                monthLabel=slotIdx>=0&&allDueDates[slotIdx]?fmtDate(allDueDates[slotIdx]):'‚Äî';
            }
            return`<tr class="${cp?'pdf-chit-row':(isMulti?'pdf-multi-row':'')}">
                <td>${idx+1}</td>
                <td style="font-weight:700;">${monthLabel}${isMulti?`<br><span class="pdf-multi-badge">üìÖ ${p.numMonths} months</span>`:''}</td>
                <td>${fmtDate(p.date)}</td>
                <td>‚Çπ${(parseFloat(p.chit)||0).toLocaleString('en-IN')}${isMulti?` √ó ${p.numMonths}`:''}</td>
                <td style="color:#065f46;font-weight:700;">‚Çπ${(parseFloat(p.paid)||0).toLocaleString('en-IN')}</td>
                <td style="color:#92400e;font-weight:700;">‚Çπ${(parseFloat(p.balance)||0).toLocaleString('en-IN')}</td>
                <td>${p.paidBy||'‚Äî'}</td>
                <td>${cp?`<span class="pdf-chit-badge">‚úÖ PICKED</span>`:'‚Äî'}</td>
            </tr>`;
        }).join('');

        return`<div style="margin-bottom:22px;">
            <div class="pdf-group-title">üìÇ ${g.name}</div>
            <div style="display:flex;gap:12px;font-size:10px;color:#888;margin-bottom:4px;flex-wrap:wrap;">
                <span>üóì Start: <strong>${gStartDisp}</strong></span>
                <span>üìÖ Due: <strong>${gDueDayDisp}</strong></span>
                <span>Month ${elapsed}/${totalMonths} ¬∑ <strong>${left} pending</strong></span>
                <span>Months covered: <strong>${totalMonthsCovered}/${totalMonths}</strong></span>
            </div>
            <div class="pdf-progress-outer"><div class="pdf-progress-inner" style="width:${pct}%"></div></div>
            <div style="font-size:10px;color:#888;text-align:right;margin-bottom:10px;">Paid: ‚Çπ${gPaid.toLocaleString('en-IN')} ¬∑ Balance: ‚Çπ${gBal.toLocaleString('en-IN')}</div>
            ${pays.length?`<table class="pdf-table">
                <thead><tr><th>#</th><th>Month(s) Covered</th><th>Pay Date</th><th>Chit/Mo</th><th>Total Paid</th><th>Balance</th><th>Mode</th><th>Chit?</th></tr></thead>
                <tbody>${rows}
                <tr class="pdf-total-row"><td colspan="4"><strong>Total</strong></td><td><strong>‚Çπ${gPaid.toLocaleString('en-IN')}</strong></td><td><strong>‚Çπ${gBal.toLocaleString('en-IN')}</strong></td><td colspan="2"></td></tr>
                </tbody></table>`:'<p style="color:#888;font-size:11px;">No payments yet.</p>'}
        </div>`;
    }).join('');

    document.getElementById('pdfContent').innerHTML=`
        <div class="pdf-page">
        <div class="pdf-header">
            <div><div class="pdf-brand">üèÜ AK CHIT FUNDS</div><div class="pdf-brand-sub">Chit Fund Management ¬∑ Admin Report</div></div>
            <div><div class="pdf-right-title">MEMBER STATEMENT</div><div class="pdf-right-sub">Generated: ${today}</div></div>
        </div>
        <div class="pdf-member-box">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
                <div>
                    <div class="pdf-member-name">${m.name}</div>
                    <div class="pdf-member-sub">üìû ${m.phone||'No phone'}</div>
                    <div class="pdf-member-sub">üìÇ Groups: ${memberGroups.map(g=>g.name).join(', ')||'‚Äî'}</div>
                </div>
                <div class="pdf-stats-row">
                    <div class="pdf-stat-box"><div class="pdf-stat-val" style="color:#065f46;">‚Çπ${totalPaid.toLocaleString('en-IN')}</div><div class="pdf-stat-lbl">Total Paid</div></div>
                    <div class="pdf-stat-box"><div class="pdf-stat-val" style="color:#92400e;">‚Çπ${totalBal.toLocaleString('en-IN')}</div><div class="pdf-stat-lbl">Balance</div></div>
                    <div class="pdf-stat-box"><div class="pdf-stat-val">${mPays.length}</div><div class="pdf-stat-lbl">Payments</div></div>
                    <div class="pdf-stat-box"><div class="pdf-stat-val" style="color:#065f46;">${chitsPicked}</div><div class="pdf-stat-lbl">Chits Picked</div></div>
                </div>
            </div>
        </div>
        <div class="pdf-section-title">Payment History ‚Äî Group Wise</div>
        ${groupSections||'<p style="color:#888;">No payments recorded.</p>'}
        <div class="pdf-footer"><span>AK Chit Funds ¬∑ Admin Portal</span><span>Member: ${m.name} ¬∑ ${today}</span><span>CONFIDENTIAL</span></div>
        </div>`;

    await renderPDF(`AKChitFunds_${m.name.replace(/\s+/g,'_')}_Statement.pdf`);
    showToast('‚úÖ PDF Downloaded!',true);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF ‚Äî GROUP REPORT (FIXED)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateGroupPDF(gid){
    showToast('‚è≥ Generating Group PDF‚Ä¶',true);
    const gs=await getCollection('groups');const ms=await getCollection('members');const ps=await getCollection('payments');
    const g=gs.find(x=>x.id===gid);if(!g){showToast('‚ùå Group not found',false);return;}
    const gMs=ms.filter(m=>m.groupIds&&m.groupIds.includes(g.id));
    const gPays=ps.filter(p=>p.groupId===gid);
    const today=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});
    const totalPaid=gPays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
    const totalBal=gPays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
    const totalPicked=gPays.filter(p=>p.chitPicked==='Yes').length;
    const totalMonths=parseInt(g.duration||g.gDuration)||21;
    let elapsed=0;
    if(g.startDate||g.gStart){const _s=new Date(g.startDate||g.gStart),_n=new Date();elapsed=Math.max(0,Math.min(totalMonths,(_n.getFullYear()-_s.getFullYear())*12+(_n.getMonth()-_s.getMonth())+1));}
    const left=Math.max(0,totalMonths-elapsed);const pct=Math.min(100,Math.round(elapsed/totalMonths*100));
    const allDueDates=getGroupDueDates(g);

    // ‚îÄ‚îÄ Member Summary table
    const summaryRows=gMs.map((m,i)=>{
        const mp=gPays.filter(p=>p.memberId===m.id);
        const mPaid=mp.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
        const mBal=mp.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
        const mPicked=mp.filter(p=>p.chitPicked==='Yes').length;
        const monthsCovered=mp.reduce((s,p)=>s+(p.numMonths||1),0);
        const lastPay=[...mp].sort((a,b)=>(b.date||'').localeCompare(a.date||''))[0];
        return`<tr>
            <td>${i+1}</td>
            <td><strong>${m.name}</strong>${m.phone?`<br><span style="font-size:9px;color:#888;">${m.phone}</span>`:''}</td>
            <td style="color:#065f46;font-weight:700;">‚Çπ${mPaid.toLocaleString('en-IN')}</td>
            <td style="color:${mBal>0?'#92400e':'#065f46'};font-weight:700;">‚Çπ${mBal.toLocaleString('en-IN')}</td>
            <td>${mp.length} (${monthsCovered}/${totalMonths} mo.)</td>
            <td>${lastPay?fmtDate(lastPay.date):'‚Äî'}</td>
            <td>${mPicked>0?`<span class="pdf-chit-badge">‚úÖ ${mPicked}x</span>`:'‚Äî'}</td>
        </tr>`;
    }).join('');

    // ‚îÄ‚îÄ Per-member detailed payment history
    const detailSections=gMs.map((m,mi)=>{
        const mp=gPays.filter(p=>p.memberId===m.id).sort((a,b)=>(a.date||'').localeCompare(b.date||''));
        const mPaid=mp.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
        const mBal=mp.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
        const monthsCovered=mp.reduce((s,p)=>s+(p.numMonths||1),0);

        const rows=mp.map((p,idx)=>{
            const cp=p.chitPicked==='Yes';
            const isMulti=p.numMonths&&p.numMonths>1;
            let monthLabel='‚Äî';
            if(isMulti&&p.monthSlots&&p.monthSlots.length>0){
                const f=allDueDates[p.monthSlots[0]]?fmtDate(allDueDates[p.monthSlots[0]]):'‚Äî';
                const l=allDueDates[p.monthSlots[p.monthSlots.length-1]]?fmtDate(allDueDates[p.monthSlots[p.monthSlots.length-1]]):'‚Äî';
                monthLabel=`${f} ‚Üí ${l}`;
            } else {
                const slotIdx=p.monthSlot!==undefined?p.monthSlot:getMonthSlot(allDueDates,p.date);
                monthLabel=slotIdx>=0&&allDueDates[slotIdx]?fmtDate(allDueDates[slotIdx]):'‚Äî';
            }
            return`<tr class="${cp?'pdf-chit-row':(isMulti?'pdf-multi-row':'')}">
                <td>${idx+1}</td>
                <td>${monthLabel}${isMulti?`<br><span class="pdf-multi-badge">üìÖ ${p.numMonths} months</span>`:''}</td>
                <td>${fmtDate(p.date)}</td>
                <td>‚Çπ${(parseFloat(p.chit)||0).toLocaleString('en-IN')}${isMulti?` √ó ${p.numMonths}`:''}</td>
                <td style="color:#065f46;font-weight:700;">‚Çπ${(parseFloat(p.paid)||0).toLocaleString('en-IN')}</td>
                <td style="color:${(parseFloat(p.balance)||0)>0?'#92400e':'#065f46'};font-weight:700;">‚Çπ${(parseFloat(p.balance)||0).toLocaleString('en-IN')}</td>
                <td>${p.paidBy||'‚Äî'}</td>
                <td>${cp?`<span class="pdf-chit-badge">‚úÖ PICKED</span>`:'‚Äî'}</td>
            </tr>`;
        }).join('');

        return`<div style="margin-bottom:18px;page-break-inside:avoid;">
            <table style="width:100%;border-collapse:collapse;margin-bottom:5px;">
                <tr>
                    <td style="font-size:12px;font-weight:800;padding:6px 0;">${mi+1}. ${m.name}${m.phone?` <span style="font-size:10px;color:#888;font-weight:400;">¬∑ ${m.phone}</span>`:''}</td>
                    <td style="text-align:right;font-size:10px;color:#555;">
                        Paid: <strong style="color:#065f46;">‚Çπ${mPaid.toLocaleString('en-IN')}</strong> &nbsp;
                        Bal: <strong style="color:${mBal>0?'#92400e':'#065f46'};">‚Çπ${mBal.toLocaleString('en-IN')}</strong> &nbsp;
                        Months: <strong>${monthsCovered}/${totalMonths}</strong>
                    </td>
                </tr>
            </table>
            ${mp.length===0?`<p style="font-size:10px;color:#999;padding:6px 0;">No payments recorded.</p>`:`
            <table class="pdf-table">
                <thead><tr><th>#</th><th>Month(s) Covered</th><th>Pay Date</th><th>Chit/Mo</th><th>Paid</th><th>Balance</th><th>Mode</th><th>Chit?</th></tr></thead>
                <tbody>
                    ${rows}
                    <tr class="pdf-total-row">
                        <td colspan="4"><strong>Subtotal</strong></td>
                        <td><strong>‚Çπ${mPaid.toLocaleString('en-IN')}</strong></td>
                        <td><strong>‚Çπ${mBal.toLocaleString('en-IN')}</strong></td>
                        <td colspan="2"></td>
                    </tr>
                </tbody>
            </table>`}
        </div>`;
    }).join('');

    document.getElementById('pdfContent').innerHTML=`
    <div class="pdf-page">
        <!-- HEADER -->
        <div class="pdf-header">
            <div>
                <div class="pdf-brand">üèÜ AK CHIT FUNDS</div>
                <div class="pdf-brand-sub">Chit Fund Management ¬∑ Group Report</div>
            </div>
            <div>
                <div class="pdf-right-title">GROUP STATEMENT</div>
                <div class="pdf-right-sub">Generated: ${today}</div>
            </div>
        </div>

        <!-- GROUP INFO BOX -->
        <div class="pdf-member-box">
            <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:14px;align-items:flex-start;">
                <div style="flex:1;min-width:200px;">
                    <div class="pdf-member-name">üìÇ ${g.name}</div>
                    <div class="pdf-member-sub">üìÖ Duration: <strong>${totalMonths} months</strong> &nbsp;|&nbsp; Start: <strong>${fmtDate(g.startDate||g.gStart||'')}</strong></div>
                    <div class="pdf-member-sub">üóì Monthly Due: <strong>${g.dueDay?`${g.dueDay}${['st','nd','rd'][((g.dueDay%100-11)%10)-1]||'th'} of every month`:'‚Äî'}</strong></div>
                    <div class="pdf-member-sub">üìä Progress: Month <strong>${elapsed}/${totalMonths}</strong> &nbsp;¬∑&nbsp; <strong>${left} months pending</strong></div>
                    <div style="margin-top:10px;">
                        <div class="pdf-progress-outer" style="height:10px;">
                            <div class="pdf-progress-inner" style="width:${pct}%;"></div>
                        </div>
                        <div style="font-size:9px;color:#888;text-align:right;margin-top:2px;">${pct}% complete</div>
                    </div>
                </div>
                <div>
                    <div class="pdf-stats-row" style="gap:8px;">
                        <div class="pdf-stat-box">
                            <div class="pdf-stat-val" style="color:#065f46;">‚Çπ${totalPaid.toLocaleString('en-IN')}</div>
                            <div class="pdf-stat-lbl">Total Collected</div>
                        </div>
                        <div class="pdf-stat-box">
                            <div class="pdf-stat-val" style="color:#92400e;">‚Çπ${totalBal.toLocaleString('en-IN')}</div>
                            <div class="pdf-stat-lbl">Total Balance</div>
                        </div>
                        <div class="pdf-stat-box">
                            <div class="pdf-stat-val">${gMs.length}</div>
                            <div class="pdf-stat-lbl">Members</div>
                        </div>
                        <div class="pdf-stat-box">
                            <div class="pdf-stat-val" style="color:#065f46;">${totalPicked}</div>
                            <div class="pdf-stat-lbl">Chits Picked</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MEMBER SUMMARY TABLE -->
        <div class="pdf-section-title">üë• Member Summary (${gMs.length} Members)</div>
        <table class="pdf-table" style="margin-bottom:20px;">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Member Name</th>
                    <th>Total Paid</th>
                    <th>Balance</th>
                    <th>Payments (Months)</th>
                    <th>Last Payment</th>
                    <th>Chit Picked</th>
                </tr>
            </thead>
            <tbody>
                ${summaryRows||`<tr><td colspan="7" style="text-align:center;color:#888;padding:12px;">No members in this group</td></tr>`}
                <tr class="pdf-total-row">
                    <td colspan="2"><strong>GRAND TOTAL (${gMs.length} members)</strong></td>
                    <td><strong style="color:#065f46;">‚Çπ${totalPaid.toLocaleString('en-IN')}</strong></td>
                    <td><strong style="color:${totalBal>0?'#92400e':'#065f46'};">‚Çπ${totalBal.toLocaleString('en-IN')}</strong></td>
                    <td><strong>${gPays.length} entries</strong></td>
                    <td colspan="2"><strong>${totalPicked} chit${totalPicked!==1?'s':''} picked</strong></td>
                </tr>
            </tbody>
        </table>

        <!-- DETAILED PAYMENT HISTORY -->
        <div class="pdf-section-title" style="page-break-before:auto;">üìã Detailed Payment History ‚Äî Member Wise</div>
        ${detailSections||'<p style="color:#888;font-size:11px;">No payment records found.</p>'}

        <!-- FOOTER -->
        <div class="pdf-footer">
            <span>AK Chit Funds ¬∑ Admin Portal</span>
            <span>Group: <strong>${g.name}</strong> ¬∑ ${today}</span>
            <span>CONFIDENTIAL</span>
        </div>
    </div>`;

    await renderPDF(`AKChitFunds_Group_${g.name.replace(/\s+/g,'_')}_Report.pdf`);
    showToast('‚úÖ Group PDF Downloaded!',true);
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ADMIN_PHONE = '9876543210'; // ‚Üê Change this to your admin mobile number
let CURRENT_USER = null; // {phone, role:'admin'|'member', memberId, name}

// Session persistence via sessionStorage
function saveSession(user){ sessionStorage.setItem('akcf_user', JSON.stringify(user)); }
function loadSession(){ try{ return JSON.parse(sessionStorage.getItem('akdf_user'))||null; }catch(e){ return null; } }
function clearSession(){ sessionStorage.removeItem('akdf_user'); sessionStorage.removeItem('akdf_user'); }

async function initAuth(){
    // Check existing session
    const saved = sessionStorage.getItem('akdf_session');
    if(saved){
        try{
            const u = JSON.parse(saved);
            CURRENT_USER = u;
            applyUserSession(u);
            return;
        }catch(e){}
    }
    // Show login screen
    document.getElementById('loginScreen').style.display='flex';
}

async function handleLoginSubmit(){
    const phone = document.getElementById('loginPhone').value.trim();
    if(phone.length !== 10){ showToast('‚ùå Enter valid 10-digit mobile number', false); return; }

    showToast('‚è≥ Checking access‚Ä¶', true);

    // Check if admin
    if(phone === ADMIN_PHONE){
        const user = {phone, role:'admin', name:'Admin'};
        CURRENT_USER = user;
        sessionStorage.setItem('akdf_session', JSON.stringify(user));
        applyUserSession(user);
        return;
    }

    // Check if this phone matches an approved member
    const members = await getCollection('members');
    const matched = members.find(m => (m.phone||'').replace(/\D/g,'').slice(-10) === phone);

    if(matched){
        // Check access request status
        const reqs = await db.collection('accessRequests').where('phone','==',phone).get();
        if(!reqs.empty){
            const req = reqs.docs[0].data();
            if(req.status === 'approved'){
                const user = {phone, role:'member', memberId: matched.id, name: matched.name};
                CURRENT_USER = user;
                sessionStorage.setItem('akdf_session', JSON.stringify(user));
                applyUserSession(user);
                return;
            } else if(req.status === 'denied'){
                showLoginStep('loginStep3');
                return;
            } else {
                // Still pending
                document.getElementById('pendingPhone').textContent = `+91 ${phone}`;
                showLoginStep('loginStep2');
                return;
            }
        } else {
            // First time ‚Äî create access request
            await db.collection('accessRequests').add({
                phone, name: matched.name, memberId: matched.id,
                status: 'pending', requestedAt: new Date().toISOString()
            });
            document.getElementById('pendingPhone').textContent = `+91 ${phone}`;
            showLoginStep('loginStep2');
            showToast('üì® Access request sent to admin', true);
            return;
        }
    } else {
        // Phone not found in members
        showToast('‚ùå Mobile number not registered. Contact admin.', false);
        return;
    }
}

async function checkAccessStatus(){
    const phone = document.getElementById('loginPhone').value.trim() ||
                  (CURRENT_USER && CURRENT_USER.phone) || '';
    if(!phone){ goBackToLogin(); return; }

    const reqs = await db.collection('accessRequests').where('phone','==',phone).get();
    if(!reqs.empty){
        const req = reqs.docs[0].data();
        if(req.status === 'approved'){
            const members = await getCollection('members');
            const matched = members.find(m => (m.phone||'').replace(/\D/g,'').slice(-10) === phone);
            if(matched){
                const user = {phone, role:'member', memberId: matched.id, name: matched.name};
                sessionStorage.setItem('akdf_session', JSON.stringify(user));
                showToast('‚úÖ Access approved! Loading‚Ä¶', true);
                setTimeout(()=>location.reload(), 800);
                return;
            }
        } else if(req.status === 'denied'){
            showLoginStep('loginStep3');
            return;
        }
    }
    showToast('‚è≥ Still pending approval', true);
}

let _pendingPollTimer = null;

function showLoginStep(stepId){
    ['loginStep1','loginStep2','loginStep3'].forEach(id=>{
        document.getElementById(id).classList.remove('active');
    });
    document.getElementById(stepId).classList.add('active');
    // Start auto-poll when on pending screen
    if(stepId === 'loginStep2'){
        if(_pendingPollTimer) clearInterval(_pendingPollTimer);
        _pendingPollTimer = setInterval(silentCheckStatus, 5000);
    } else {
        if(_pendingPollTimer){ clearInterval(_pendingPollTimer); _pendingPollTimer=null; }
    }
}

async function silentCheckStatus(){
    const phone = document.getElementById('loginPhone').value.trim();
    if(!phone) return;
    const reqs = await db.collection('accessRequests').where('phone','==',phone).get().catch(()=>({docs:[]}));
    if(!reqs.docs || reqs.docs.length===0) return;
    const req = reqs.docs[0].data();
    if(req.status === 'approved'){
        if(_pendingPollTimer){ clearInterval(_pendingPollTimer); _pendingPollTimer=null; }
        const members = await getCollection('members');
        const matched = members.find(m => (m.phone||'').replace(/\D/g,'').slice(-10) === phone);
        if(matched){
            const user = {phone, role:'member', memberId: matched.id, name: matched.name};
            sessionStorage.setItem('akdf_session', JSON.stringify(user));
            showToast('‚úÖ Access approved! Loading‚Ä¶', true);
            setTimeout(()=>location.reload(), 1000);
        }
    } else if(req.status === 'denied'){
        if(_pendingPollTimer){ clearInterval(_pendingPollTimer); _pendingPollTimer=null; }
        showLoginStep('loginStep3');
    }
}

function goBackToLogin(){
    document.getElementById('loginPhone').value='';
    showLoginStep('loginStep1');
}

function applyUserSession(user){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('logoutBtn').style.display='block';

    if(user.role === 'admin'){
        document.getElementById('adminHeader').style.display='flex';
        document.getElementById('memberHeader').style.display='none';
        document.getElementById('headerRoleBadge').textContent='ADMIN';
        document.getElementById('headerRoleBadge').style.display='inline';
        document.getElementById('accessReqBtn').style.display='inline-flex';
        document.getElementById('logoutBtn').style.display='block';
        // Show all admin UI
        document.getElementById('adminStatCards').style.display='';
        document.getElementById('adminActionBtns').style.display='flex';
        document.getElementById('adminMemberSearch').style.display='';
        document.getElementById('memberLedgerArea').style.display='none';
        document.getElementById('adminQuickBtns').style.display='flex';
        updateUI();
        pollPendingRequests();
    } else {
        // Member mode ‚Äî replace header, hide all admin UI
        document.getElementById('adminHeader').style.display='none';
        document.getElementById('memberHeader').style.display='block';
        document.getElementById('logoutBtn').style.display='none'; // logout is in member header
        // Populate member header
        document.getElementById('memberHeaderAvatar').textContent = ini(user.name);
        document.getElementById('memberHeaderName').textContent = user.name;
        document.getElementById('memberHeaderPhone').textContent = `üì± +91 ${user.phone}`;
        // Hide all admin-only blocks
        document.getElementById('adminStatCards').style.display='none';
        document.getElementById('adminActionBtns').style.display='none';
        document.getElementById('adminMemberSearch').style.display='none';
        document.getElementById('adminQuickBtns').style.display='none';
        // Hide admin nav tabs + nav bar itself
        document.getElementById('navGroups').style.display='none';
        document.getElementById('navList').style.display='none';
        document.getElementById('navBackup').style.display='none';
        document.querySelector('.nav-bar').style.display='none';
        // Show member ledger area
        document.getElementById('memberLedgerArea').style.display='block';
        // Load ONLY this member's own data
        document.getElementById('summaryView').value = user.memberId;
        loadMemberLedger();
    }
}

function handleLogout(){
    sessionStorage.removeItem('akdf_session');
    CURRENT_USER = null;
    document.body.classList.remove('member-mode');
    // Restore headers
    document.getElementById('adminHeader').style.display='flex';
    document.getElementById('memberHeader').style.display='none';
    // Restore nav
    document.getElementById('navGroups').style.display='';
    document.getElementById('navList').style.display='';
    document.getElementById('navBackup').style.display='';
    document.querySelector('.nav-bar').style.display='';
    // Restore admin UI blocks
    document.getElementById('adminStatCards').style.display='';
    document.getElementById('adminActionBtns').style.display='flex';
    document.getElementById('adminMemberSearch').style.display='';
    document.getElementById('memberLedgerArea').style.display='none';
    document.getElementById('adminQuickBtns').style.display='flex';
    // Reset header badges
    document.getElementById('logoutBtn').style.display='none';
    document.getElementById('accessReqBtn').style.display='none';
    document.getElementById('headerRoleBadge').textContent='ADMIN';
    document.getElementById('headerRoleBadge').className='badge text-warning border border-warning px-2';
    // Clear ledger state
    document.getElementById('ledgerData').innerHTML='';
    document.getElementById('memberLedgerData').innerHTML='';
    document.getElementById('summarySearch').value='';
    document.getElementById('summaryView').value='';
    // Show login
    showLoginStep('loginStep1');
    document.getElementById('loginPhone').value='';
    document.getElementById('loginScreen').style.display='flex';
}

// ‚îÄ‚îÄ ACCESS REQUESTS PANEL (admin only) ‚îÄ‚îÄ
let _reqFilter = 'pending';
async function openAccessRequests(){
    _reqFilter = 'pending';
    await renderAccessRequests();
    openModal('accessModal');
}

async function filterRequests(type){
    _reqFilter = type;
    ['pending','approved','all'].forEach(t=>{
        const btn = document.getElementById(`reqTab${t.charAt(0).toUpperCase()+t.slice(1)}`);
        if(btn) btn.className = t===type ? 'btn-save' : 'btn-cancel';
    });
    await renderAccessRequests();
}

async function renderAccessRequests(){
    const list = document.getElementById('accessRequestsList');
    list.innerHTML = '<div style="text-align:center;color:var(--text-dim);padding:16px;">Loading‚Ä¶</div>';
    let q = db.collection('accessRequests');
    const snap = await q.orderBy('requestedAt','desc').get().catch(()=> db.collection('accessRequests').get());
    const all = snap.docs.map(d=>({id:d.id,...d.data()}));
    const filtered = _reqFilter==='all' ? all : all.filter(r=>r.status===_reqFilter);

    if(!filtered.length){
        list.innerHTML=`<div style="text-align:center;color:var(--text-dim);padding:24px;font-size:0.85rem;">No ${_reqFilter==='all'?'':_reqFilter} requests</div>`;
        return;
    }

    list.innerHTML = filtered.map(r=>`
        <div class="req-card">
            <div style="flex:1;min-width:0;">
                <div class="req-name">${r.name||'Unknown'}</div>
                <div class="req-phone">üì± +91 ${r.phone} &nbsp;¬∑&nbsp; ${r.requestedAt?new Date(r.requestedAt).toLocaleDateString('en-IN'):'‚Äî'}</div>
            </div>
            <div style="display:flex;gap:6px;align-items:center;flex-shrink:0;">
                ${r.status==='pending'
                    ? `<button class="btn-approve" onclick="handleApprove('${r.id}','${r.phone}')">‚úÖ Approve</button>
                       <button class="btn-deny" onclick="handleDeny('${r.id}')">‚úï Deny</button>`
                    : r.status==='approved'
                        ? `<span class="badge-approved">‚úÖ Approved</span><button class="btn-deny" style="font-size:0.62rem;padding:4px 8px;" onclick="handleDeny('${r.id}')">Revoke</button>`
                        : `<span class="badge-denied">üö´ Denied</span><button class="btn-approve" style="font-size:0.62rem;padding:4px 8px;" onclick="handleApprove('${r.id}','${r.phone}')">Re-approve</button>`
                }
            </div>
        </div>`).join('');
}

async function handleApprove(reqId, phone){
    await db.collection('accessRequests').doc(reqId).update({status:'approved', approvedAt: new Date().toISOString()});
    showToast('‚úÖ Access approved!');
    await renderAccessRequests();
    await pollPendingRequests();
}

async function handleDeny(reqId){
    await db.collection('accessRequests').doc(reqId).update({status:'denied', deniedAt: new Date().toISOString()});
    showToast('üö´ Access denied');
    await renderAccessRequests();
    await pollPendingRequests();
}

async function pollPendingRequests(){
    if(!CURRENT_USER || CURRENT_USER.role!=='admin') return;
    const snap = await db.collection('accessRequests').where('status','==','pending').get().catch(()=>({docs:[]}));
    const count = snap.docs.length;
    const badge = document.getElementById('pendingCount');
    if(count > 0){
        badge.style.display='flex';
        badge.textContent=count;
    } else {
        badge.style.display='none';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('pDate').value=new Date().toISOString().split('T')[0];
setTimeout(migrateData,800);
// Start auth
initAuth();
// Poll pending requests every 60s when admin is logged in
setInterval(()=>{ if(CURRENT_USER&&CURRENT_USER.role==='admin') pollPendingRequests(); }, 60000);
</script>
</body>
</html>
