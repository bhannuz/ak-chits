<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AK Chit Funds</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root { --bg-dark: #050a18; --card-bg: #11192e; --accent-gold: #f39c12; --text-main: #ffffff; --text-dim: #8e9aaf; --border-color: #1c2641; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', sans-serif; padding-bottom: 120px; }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; }
        .brand-logo { color: var(--accent-gold); font-weight: bold; font-size: 1.3rem; }
        .stat-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 15px; text-align: center; }
        .stat-num { font-size: 1.4rem; font-weight: bold; display: block; }
        .stat-label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; }

        /* Group Header with Months Progress */
        .group-header-card { background: #1c2641; padding: 12px 18px; border-radius: 12px; margin-top: 20px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--accent-gold); }
        .month-tracker { font-size: 0.85rem; color: var(--accent-gold); font-weight: bold; }
        
        .member-row { background: var(--card-bg); border: 1px solid var(--border-color); margin: 5px 0; padding: 10px 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .pending-badge { background: rgba(255, 23, 68, 0.2); color: #ff1744; padding: 2px 8px; border-radius: 5px; font-size: 0.75rem; }

        .btn-action-outline { flex: 1; background: transparent; border: 1px solid var(--border-color); color: white; padding: 15px; border-radius: 15px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .entry-section { display: none; background: var(--card-bg); border-radius: 20px; padding: 20px; margin: 20px 0; border: 1px solid var(--accent-gold); }
        .form-dark { background: #0a1021; border: 1px solid var(--border-color); color: white; padding: 12px; margin-bottom: 10px; border-radius: 10px; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #0a1021; display: flex; justify-content: space-around; padding: 15px; border-top: 1px solid var(--border-color); }
    </style>
</head>
<body>

<div class="container py-2">
    <div class="app-header"><div class="brand-logo">üèÜ AK Chit Funds</div><span class="badge bg-dark text-warning border border-warning">ADMIN</span></div>

    <div class="row g-2 text-center mb-3">
        <div class="col-4"><div class="stat-card"><span class="stat-num" id="memberCount">0</span><span class="stat-label">Members</span></div></div>
        <div class="col-4"><div class="stat-card"><span class="stat-num" id="groupCount">0</span><span class="stat-label">Groups</span></div></div>
        <div class="col-4"><div class="stat-card"><span class="stat-num text-success">‚Çπ0</span><span class="stat-label">Today</span></div></div>
    </div>

    <div id="groupExplorer">
        <h6 class="text-dim mt-4 mb-2 small px-2">ACTIVE GROUPS & MEMBERS</h6>
        <div id="groupListContainer">
            </div>
    </div>

    <div class="action-container d-flex gap-2 mt-4">
        <button class="btn-action-outline" onclick="toggleSection('memberForm')">‚ûï Member</button>
        <button class="btn-action-outline" onclick="toggleSection('groupForm')">üè¶ Group</button>
    </div>

    <div id="memberForm" class="entry-section">
        <h6 class="text-warning mb-3">Add Member to Group</h6>
        <input type="text" id="mName" class="form-control form-dark" placeholder="Member Name">
        <select id="mGroup" class="form-select form-dark mb-2"><option value="">-- Select Group --</option></select>
        <input type="number" id="mMonthsPaid" class="form-control form-dark" placeholder="Months Already Paid">
        <button class="btn btn-warning w-100 fw-bold" onclick="saveMember()">Save Member</button>
    </div>

    <div id="groupForm" class="entry-section">
        <h6 class="text-warning mb-3">Create Group Master</h6>
        <input type="text" id="gName" class="form-control form-dark mb-2" placeholder="Group Name">
        <input type="number" id="gTotalMonths" class="form-control form-dark mb-3" placeholder="Total Duration (e.g. 20 Months)">
        <button class="btn btn-warning w-100 fw-bold" onclick="saveGroup()">Create Group</button>
    </div>
</div>

<div class="nav-bar">
    <div class="text-warning small text-center" onclick="location.reload()">üè†<br>Home</div>
    <div class="text-secondary small text-center" onclick="exportToCSV()">üì•<br>Backup</div>
</div>

<script>
    const db = new Dexie("AKChitFundsDB");
    db.version(4).stores({ 
        members: "++id, name, groupId, monthsPaid", 
        groups: "++id, name, totalMonths" 
    });

    function toggleSection(id) {
        const el = document.getElementById(id);
        const isVisible = el.style.display === 'block';
        document.querySelectorAll('.entry-section').forEach(s => s.style.display = 'none');
        el.style.display = isVisible ? 'none' : 'block';
    }

    async function saveGroup() {
        const name = document.getElementById('gName').value;
        const totalMonths = document.getElementById('gTotalMonths').value || 20;
        if(name) await db.groups.add({ name, totalMonths });
        updateUI(); toggleSection('groupForm');
    }

    async function saveMember() {
        const name = document.getElementById('mName').value;
        const groupId = document.getElementById('mGroup').value;
        const monthsPaid = parseInt(document.getElementById('mMonthsPaid').value) || 0;
        if(name && groupId) await db.members.add({ name, groupId: parseInt(groupId), monthsPaid });
        updateUI(); toggleSection('memberForm');
    }

    async function updateUI() {
        const groups = await db.groups.toArray();
        const members = await db.members.toArray();
        
        document.getElementById('memberCount').innerText = members.length;
        document.getElementById('groupCount').innerText = groups.length;

        // Populate Dropdown
        document.getElementById('mGroup').innerHTML = '<option value="">-- Select Group --</option>' + 
            groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');

        // Render Group Explorer
        let html = '';
        for (let g of groups) {
            const groupMembers = members.filter(m => m.groupId === g.id);
            html += `
                <div class="group-header-card shadow-sm">
                    <span class="fw-bold">${g.name}</span>
                    <span class="month-tracker">${g.totalMonths} Mo Total</span>
                </div>
            `;
            groupMembers.forEach(m => {
                const pending = g.totalMonths - m.monthsPaid;
                html += `
                    <div class="member-row">
                        <span>üë§ ${m.name}</span>
                        <span class="pending-badge">${pending} Months Pending</span>
                    </div>
                `;
            });
        }
        document.getElementById('groupListContainer').innerHTML = html || '<div class="text-center py-5 text-secondary">No groups created yet.</div>';
    }

    updateUI();
</script>
</body>
</html>