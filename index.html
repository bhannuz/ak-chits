<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AK Chit Funds - Admin Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --bg-dark:#0a0e1a; --card-bg:#141b2d; --input-bg:#1c253b; --accent-gold:linear-gradient(90deg,#ff9800,#f57c00); --text-main:#ffffff; --text-dim:#8e9aaf; --border:#252f48; }
        * { box-sizing:border-box; }
        body { background-color:var(--bg-dark); color:var(--text-main); font-family:'Segoe UI',sans-serif; padding-bottom:120px; }
        .app-header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid var(--border); }
        .brand { color:#f39c12; font-weight:bold; font-size:1.3rem; }
        .stat-card { background:var(--card-bg); border:1px solid var(--border); border-radius:15px; padding:15px; text-align:center; }
        .stat-num { font-size:1.3rem; font-weight:bold; display:block; }
        .stat-label { font-size:0.65rem; color:var(--text-dim); text-transform:uppercase; }

        /* MODALS */
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.92); z-index:2000; padding:20px; overflow-y:auto; }
        .modal-content-custom { background:var(--card-bg); border-radius:25px; padding:25px; max-width:450px; margin:20px auto; border:1px solid var(--border); }
        .form-input { background:var(--input-bg); border:1px solid var(--border); color:white; padding:12px; border-radius:12px; width:100%; margin-bottom:12px; font-size:0.9rem; }
        .form-input option { background:#1c253b; }
        .form-label-small { font-size:0.72rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:.5px; margin-bottom:5px; display:block; }
        .btn-save { background:var(--accent-gold); color:black; border:none; width:100%; padding:14px; border-radius:14px; font-weight:bold; margin-bottom:10px; cursor:pointer; font-size:0.95rem; }
        .btn-cancel { background:var(--input-bg); color:white; border:none; width:100%; padding:12px; border-radius:14px; cursor:pointer; }
        .btn-danger-full { background:linear-gradient(135deg,#ef4444,#dc2626); color:white; border:none; width:100%; padding:12px; border-radius:14px; font-weight:700; cursor:pointer; margin-bottom:10px; }
        .modal-title { font-size:1.1rem; font-weight:800; margin-bottom:16px; }

        /* NAV BAR */
        .nav-bar { position:fixed; bottom:0; width:100%; background:#070b14; display:flex; justify-content:space-around; padding:12px 0 calc(12px + env(safe-area-inset-bottom)); border-top:1px solid var(--border); z-index:1000; }
        .nav-item { cursor:pointer; text-align:center; font-size:0.62rem; color:var(--text-dim); padding:4px 10px; }
        .nav-item.active { color:#f39c12; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }

        /* TABLES */
        .table-custom { color:white; font-size:0.7rem; width:100%; border-collapse:collapse; }
        .table-custom th { color:var(--text-dim); border-bottom:1px solid var(--border); padding:8px 5px; font-size:0.6rem; text-transform:uppercase; white-space:nowrap; }
        .table-custom td { padding:9px 5px; border-bottom:1px solid rgba(255,255,255,0.05); vertical-align:middle; white-space:nowrap; }
        .table-custom tr.chit-picked { background:rgba(16,185,129,0.08); }
        .table-custom tr.chit-picked td:first-child { border-left:3px solid #10b981; }
        .table-custom tr.multi-month-row { background:rgba(99,102,241,0.09); }
        .table-custom tr.multi-month-row td:first-child { border-left:3px solid #818cf8; }
        .chit-yes-badge { display:inline-block; background:rgba(16,185,129,0.2); color:#34d399; border:1px solid rgba(16,185,129,0.4); border-radius:5px; padding:2px 7px; font-size:0.6rem; font-weight:800; }
        .chit-no { color:var(--text-dim); font-size:0.65rem; }
        .multi-month-badge { display:inline-flex; align-items:center; gap:3px; background:rgba(99,102,241,0.18); color:#a5b4fc; border:1px solid rgba(99,102,241,0.4); border-radius:5px; padding:2px 7px; font-size:0.6rem; font-weight:800; }

        /* AUTOCOMPLETE */
        .suggestions-list { position:absolute; top:100%; left:0; right:0; background:var(--input-bg); border:1px solid var(--border); border-radius:0 0 12px 12px; z-index:3000; max-height:200px; overflow-y:auto; display:none; margin-top:-12px; }
        .suggestion-item { padding:12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.9rem; }
        .suggestion-item:hover { background:#252f48; color:#f39c12; }

        /* GROUP CHECKBOX */
        .group-checkbox-area { max-height:150px; overflow-y:auto; background:var(--input-bg); padding:10px; border-radius:12px; border:1px solid var(--border); margin-bottom:15px; }

        /* STAT BOXES */
        .mini-stat { background:var(--input-bg); border-radius:10px; padding:10px 8px; text-align:center; }
        .mini-stat-val { font-size:0.9rem; font-weight:800; }
        .mini-stat-lbl { font-size:0.6rem; color:var(--text-dim); text-transform:uppercase; margin-top:2px; }

        /* PROGRESS BAR */
        .prog-bar-outer { background:#252f48; border-radius:5px; height:7px; overflow:hidden; margin:6px 0 3px; }
        .prog-bar-inner { height:100%; border-radius:5px; background:linear-gradient(90deg,#f39c12,#f57c00); }
        .prog-label { font-size:0.65rem; color:var(--text-dim); display:flex; justify-content:space-between; }

        /* LIST TAB */
        .list-group-header { background:#1c253b; padding:12px 15px; border-radius:10px; margin-top:12px; font-weight:bold; color:#f39c12; border-left:4px solid #f39c12; display:flex; justify-content:space-between; align-items:center; cursor:pointer; user-select:none; }

        /* PDF BUTTON */
        .btn-pdf { background:linear-gradient(135deg,#e74c3c,#c0392b); color:white; border:none; border-radius:8px; padding:7px 13px; font-size:0.75rem; font-weight:700; cursor:pointer; }
        .btn-edit-sm { background:rgba(243,156,18,.12); border:1px solid rgba(243,156,18,.35); color:#f39c12; border-radius:7px; padding:4px 10px; font-size:0.68rem; font-weight:700; cursor:pointer; }

        /* GROUPS TAB COLLAPSIBLE */
        .group-card { background:var(--card-bg); border:1px solid var(--border); border-radius:16px; padding:16px; margin-bottom:14px; overflow:hidden; }
        .group-card-header { cursor:pointer; user-select:none; }
        .group-body { transition:max-height 0.3s ease, opacity 0.3s ease; overflow:hidden; }
        .chevron-icon { transition:transform 0.25s ease; display:inline-block; font-size:0.8rem; color:var(--text-dim); }

        /* Multi-month selector checkboxes */
        .month-selector-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; max-height:220px; overflow-y:auto; }
        .month-cb-item { display:flex; align-items:center; gap:6px; background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:8px; padding:6px 8px; cursor:pointer; transition:all .15s; font-size:0.68rem; }
        .month-cb-item.selected { background:rgba(99,102,241,0.2); border-color:rgba(99,102,241,0.6); color:#a5b4fc; font-weight:700; }
        .month-cb-item.already-paid { background:rgba(16,185,129,0.07); border-color:rgba(16,185,129,0.3); color:#34d399; opacity:0.6; cursor:not-allowed; }
        .month-cb-item input[type=checkbox] { accent-color:#818cf8; width:13px; height:13px; flex-shrink:0; }

        /* ‚ïê‚ïê PDF EXPORT STYLES (REFINED) ‚ïê‚ïê */
        #pdf-template { position:absolute; left:-9999px; top:0; width:794px; visibility:hidden; pointer-events:none; background:white; }
        #pdf-template.rendering { visibility:visible; }
        
        .pdf-page { 
            background:white; 
            color:#111; 
            padding:35px; /* Adequate gutter spacing */
            font-family:'Segoe UI',Arial,sans-serif; 
            width:794px; /* A4 Width at 96dpi */
            min-height:1123px; /* A4 Height */
            margin:0;
            box-sizing:border-box; /* Crucial: ensures padding doesn't shift width */
        }
        .pdf-header { display:flex; justify-content:space-between; align-items:flex-start; border-bottom:4px solid #f39c12; padding-bottom:14px; margin-bottom:20px; }
        .pdf-brand { font-size:26px; font-weight:900; color:#f39c12; }
        .pdf-brand-sub { font-size:11px; color:#888; margin-top:2px; }
        .pdf-right-title { font-size:16px; font-weight:800; text-align:right; }
        .pdf-right-sub { font-size:11px; color:#888; text-align:right; margin-top:3px; }
        .pdf-member-box { background:#fffbf0; border:2px solid #f39c12; border-radius:12px; padding:16px 20px; margin-bottom:20px; }
        .pdf-member-name { font-size:20px; font-weight:800; }
        .pdf-member-sub { font-size:12px; color:#555; margin-top:4px; }
        .pdf-stats-row { display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
        .pdf-stat-box { flex:1; min-width:100px; border:1px solid #ddd; border-radius:8px; padding:10px; text-align:center; background:white; }
        .pdf-stat-val { font-size:15px; font-weight:800; }
        .pdf-stat-lbl { font-size:9px; color:#888; text-transform:uppercase; letter-spacing:.4px; margin-top:2px; }
        .pdf-section-title { font-size:11px; font-weight:800; color:#888; text-transform:uppercase; letter-spacing:1px; margin:20px 0 8px; border-bottom:1px solid #eee; padding-bottom:6px; }
        .pdf-group-title { font-size:13px; font-weight:800; margin-bottom:6px; color:#111; }
        .pdf-progress-outer { background:#eee; border-radius:5px; height:8px; margin-bottom:4px; overflow:hidden; }
        .pdf-progress-inner { height:100%; background:linear-gradient(90deg,#f39c12,#f57c00); border-radius:5px; }
        .pdf-table { width:100%; border-collapse:collapse; font-size:11px; margin-bottom:20px; }
        .pdf-table th { background:#f5f5f5; border:1px solid #ccc; padding:7px 9px; font-size:9px; text-transform:uppercase; color:#555; text-align:left; }
        .pdf-table td { border:1px solid #ddd; padding:7px 9px; }
        .pdf-table tr:nth-child(even) td { background:#fafafa; }
        .pdf-table tr.pdf-chit-row td { background:#f0fff8 !important; border-left:4px solid #10b981; }
        .pdf-table tr.pdf-multi-row td { background:#eef2ff !important; border-left:4px solid #818cf8; }
        .pdf-chit-badge { background:#d1fae5; color:#065f46; border-radius:4px; padding:2px 6px; font-size:9px; font-weight:800; }
        .pdf-multi-badge { background:#e0e7ff; color:#3730a3; border-radius:4px; padding:2px 6px; font-size:9px; font-weight:800; }
        .pdf-total-row td { background:#fff8e1 !important; font-weight:800; border-top:2px solid #f39c12; }
        .pdf-footer { margin-top:24px; border-top:1px solid #ddd; padding-top:12px; display:flex; justify-content:space-between; font-size:10px; color:#aaa; }
    </style>
</head>
<body>

<div class="container py-2">
    <div class="app-header">
        <div class="brand">üèÜ AK Chit Funds <small style="font-size:0.5em;color:#2ecc71;">‚òÅ CLOUD</small></div>
        <span class="badge text-warning border border-warning px-2">ADMIN</span>
    </div>

    <div id="homeTab" class="tab-content active">
        <div class="row g-2 mt-3 text-center">
            <div class="col-4"><div class="stat-card"><span class="stat-num" id="memberCount">-</span><span class="stat-label">Members</span></div></div>
            <div class="col-4"><div class="stat-card"><span class="stat-num" id="groupCount">-</span><span class="stat-label">Groups</span></div></div>
            <div class="col-4"><div class="stat-card"><span class="stat-num text-success" id="todayColl">‚Çπ0</span><span class="stat-label">Today</span></div></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;">
            <button class="btn btn-warning w-100 py-3 fw-bold shadow" onclick="openPaymentModal()" style="border-radius:20px;">üí≥ Record Payment</button>
            <button onclick="resetPaymentForm();openModal('paymentModal');" title="Refresh Form" style="background:var(--card-bg);border:1px solid var(--border);color:#f39c12;border-radius:20px;padding:0 18px;font-size:1.2rem;cursor:pointer;flex-shrink:0;">üîÑ</button>
        </div>

        <div class="p-3 my-3" style="background:var(--card-bg);border-radius:20px;border:1px solid var(--border);">
            <div style="display:flex;gap:8px;align-items:flex-start;">
                <div style="position:relative;flex:1;">
                    <input type="text" id="summarySearch" class="form-input" style="margin-bottom:0;" placeholder="üîç Search Member for Summary / PDF..." oninput="filterSearch('summarySearch','summaryList','summaryView')">
                    <input type="hidden" id="summaryView">
                    <div id="summaryList" class="suggestions-list"></div>
                </div>
                <button onclick="clearMemberSearch()" title="Clear / Refresh" style="background:var(--input-bg);border:1px solid var(--border);color:#f39c12;border-radius:12px;padding:12px 14px;font-size:1rem;cursor:pointer;flex-shrink:0;line-height:1;">üîÑ</button>
            </div>
            <div id="ledgerData"></div>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-outline-warning w-100 py-3 fw-bold" onclick="openAddMember()">üë§ Create Member</button>
            <button class="btn btn-outline-success w-100 py-3 fw-bold" onclick="openAddGroup()">üè¶ New Group</button>
        </div>
    </div>

    <div id="groupsTab" class="tab-content"><div id="groupListArea" class="mt-2"></div></div>

    <div id="listTab" class="tab-content"><div id="simpleListArea" class="mt-2"></div></div>

    <div id="backupTab" class="tab-content">
        <h5 class="mt-4 mb-3 text-warning text-center">üíæ Data Management</h5>
        <div class="stat-card p-4">
            <button class="btn btn-warning w-100 py-3 mb-3 fw-bold" onclick="exportFullBackup()">üíæ Download JSON Backup</button>
            <hr style="border-color:var(--border);">
            <p class="small mb-2" style="color:var(--text-dim);">Restore all data from backup file:</p>
            <input type="file" id="restoreFile" class="form-control mb-2 bg-dark text-white border-secondary" accept=".json">
            <button class="btn btn-outline-info w-100 py-3 fw-bold" onclick="confirmRestore()">üîÑ Restore All Data</button>
        </div>
    </div>
</div>

<div id="pdf-template"><div id="pdfContent"></div></div>

<div id="memberModal" class="modal-overlay">
    <div class="modal-content-custom">
        <div class="modal-title" id="memberModalTitle">üë§ Create Member</div>
        <input type="hidden" id="editMemberId">
        <label class="form-label-small">Full Name</label>
        <input type="text" id="mName" class="form-input" placeholder="e.g. Rama Krishna">
        <label class="form-label-small">Phone Number</label>
        <input type="text" id="mPhone" class="form-input" placeholder="e.g. 9876543210">
        <label class="form-label-small">Assign to Groups</label>
        <div id="groupCheckboxes" class="group-checkbox-area"></div>
        <button class="btn-save" onclick="saveMember()">‚úì Save Member</button>
        <div id="deleteMemberArea" style="display:none;">
            <button class="btn-danger-full" onclick="deleteMemberFromModal()">üóë Delete Member</button>
        </div>
        <button class="btn-cancel" onclick="closeModal('memberModal')">Cancel</button>
    </div>
</div>

<div id="groupModal" class="modal-overlay">
    <div class="modal-content-custom">
        <div class="modal-title" id="groupModalTitle">üè¶ New Group</div>
        <input type="hidden" id="editGroupId">
        <label class="form-label-small">Group Name</label>
        <input type="text" id="gName" class="form-input" placeholder="e.g. Group A">
        <label class="form-label-small">Duration (Months)</label>
        <input type="number" id="gDuration" class="form-input" placeholder="e.g. 21">
        <label class="form-label-small">Monthly Due Day (1‚Äì31)</label>
        <input type="number" id="gDueDay" class="form-input" placeholder="e.g. 5" min="1" max="31">
        <label class="form-label-small">Start Date</label>
        <input type="date" id="gStart" class="form-input">
        <button class="btn-save" onclick="saveGroup()">‚úì Save Group</button>
        <div id="deleteGroupArea" style="display:none;">
            <button class="btn-danger-full" onclick="deleteGroupFromModal()">üóë Delete Group</button>
        </div>
        <button class="btn-cancel" onclick="closeModal('groupModal')">Cancel</button>
    </div>
</div>

<div id="paymentModal" class="modal-overlay">
    <div class="modal-content-custom">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div class="modal-title" style="margin-bottom:0;">üí≥ Record Payment</div>
            <button onclick="resetPaymentForm()" style="background:rgba(243,156,18,.12);border:1px solid rgba(243,156,18,.3);color:#f39c12;border-radius:10px;padding:6px 12px;font-size:0.75rem;font-weight:700;cursor:pointer;">üîÑ Refresh</button>
        </div>
        <label class="form-label-small">Payment Date</label>
        <input type="date" id="pDate" class="form-input">
        <label class="form-label-small">Member</label>
        <div style="position:relative;">
            <input type="text" id="pMemberSearch" class="form-input" placeholder="üîç Search Member..." oninput="filterSearch('pMemberSearch','pMemberList','pMember')">
            <input type="hidden" id="pMember">
            <div id="pMemberList" class="suggestions-list"></div>
        </div>
        <label class="form-label-small">Group</label>
        <select id="pGroup" class="form-input" onchange="onGroupChange()"><option value="">-- Select Member First --</option></select>

        <label class="form-label-small">Number of Months Paying</label>
        <select id="pNumMonths" class="form-input" onchange="onNumMonthsChange()">
            <option value="1">1 Month (Normal)</option>
            <option value="multi">Multiple Months (pick below) üìÖ</option>
        </select>

        <div id="multiMonthPreview" style="display:none; background:rgba(99,102,241,0.08); border:1px solid rgba(99,102,241,0.25); border-radius:12px; padding:12px 14px; margin-bottom:12px;">
            <div class="form-label-small" style="color:#a5b4fc;">üìÖ Select Months to Pay</div>
            <div id="monthSelectorGrid" class="month-selector-grid"></div>
            <div id="selectedSummary" style="display:none; font-size:0.68rem; color:#a5b4fc; margin-top:8px; font-weight:700; padding:6px 10px; background:rgba(99,102,241,0.12); border-radius:8px;"></div>
        </div>

        <div class="row g-2">
            <div class="col-6">
                <label class="form-label-small">Chit Amount <span id="perMonthLabel" style="color:#a5b4fc;font-size:0.65rem;"></span></label>
                <input type="number" id="pChit" class="form-input" oninput="calcBalance()">
            </div>
            <div class="col-6">
                <label class="form-label-small">Total Amount Paid</label>
                <input type="number" id="pPaid" class="form-input" oninput="calcBalance()">
            </div>
        </div>

        <label class="form-label-small">Paid By</label>
        <select id="pPaidBy" class="form-input">
            <option value="">-- Select Mode --</option>
            <option>UPI</option><option>GPay</option><option>PhonePe</option>
            <option>Cash</option><option>Bank Transfer</option>
        </select>
        <label class="form-label-small">Chit Picked?</label>
        <select id="pChitPicked" class="form-input" onchange="toggleChitPickedName()">
            <option value="No">No</option><option value="Yes">Yes ‚úÖ</option>
        </select>
        <div id="chitPickedNameDiv" style="display:none;">
            <label class="form-label-small">Picked By (Name)</label>
            <input type="text" id="pChitPickedBy" class="form-input">
        </div>
        <button class="btn-save" onclick="savePayment()">‚úì Sync Payment</button>
        <button class="btn-cancel" onclick="closeModal('paymentModal')">Cancel</button>
    </div>
</div>

<div id="editPaymentModal" class="modal-overlay">
    <div class="modal-content-custom">
        <div class="modal-title">‚úèÔ∏è Edit Payment</div>
        <input type="hidden" id="epId">
        <label class="form-label-small">Payment Date</label>
        <input type="date" id="epDate" class="form-input">
        <div class="row g-2">
            <div class="col-6"><label class="form-label-small">Chit Amount</label><input type="number" id="epChit" class="form-input" oninput="epCalcBalance()"></div>
            <div class="col-6"><label class="form-label-small">Amount Paid</label><input type="number" id="epPaid" class="form-input" oninput="epCalcBalance()"></div>
        </div>
        <label class="form-label-small">Paid By</label>
        <select id="epPaidBy" class="form-input">
            <option>UPI</option><option>GPay</option><option>PhonePe</option>
            <option>Cash</option><option>Bank Transfer</option>
        </select>
        <button class="btn-save" onclick="saveEditPayment()">‚úì Update Payment</button>
        <button class="btn-danger-full" onclick="deletePayment()">üóë Delete Payment</button>
        <button class="btn-cancel" onclick="closeModal('editPaymentModal')">Cancel</button>
    </div>
</div>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-content-custom" style="max-width:360px;">
        <div class="modal-title text-center" id="confirmTitle">Are you sure?</div>
        <p style="font-size:0.85rem;color:var(--text-dim);text-align:center;" id="confirmMsg"></p>
        <button class="btn-danger-full" id="confirmOkBtn">Confirm</button>
        <button class="btn-cancel" onclick="closeModal('confirmModal')">Cancel</button>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" id="navHome" onclick="switchTab('home')">üè†<br>Home</div>
    <div class="nav-item" id="navGroups" onclick="switchTab('groups')">üìÅ<br>Groups</div>
    <div class="nav-item" id="navList" onclick="switchTab('list')">üìú<br>List</div>
    <div class="nav-item" id="navBackup" onclick="switchTab('backup')">üíæ<br>Backup</div>
</div>

<script>
// FIREBASE CONFIG
const firebaseConfig={apiKey:"AIzaSyB9_sBL83skvIaOVAE8msHwIWq8QQwhxFU",authDomain:"ak-chit-funds.firebaseapp.com",projectId:"ak-chit-funds",storageBucket:"ak-chit-funds.firebasestorage.app",messagingSenderId:"297195194526",appId:"1:297195194526:web:b71c7c09dcf8610211938f"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
let ALL_MEMBERS=[];

// HELPERS
async function getCollection(col){const s=await db.collection(col).get();return s.docs.map(d=>({id:d.id,...d.data()}));}
function fmtDate(d){if(!d)return"‚Äî";const[y,m,day]=d.split("-");return`${day}/${m}/${y}`;}
function fmtAmt(v){return'‚Çπ'+(parseFloat(v)||0).toLocaleString('en-IN');}
function ini(n){return(n||'?').split(' ').map(x=>x[0]||'').join('').toUpperCase().slice(0,2)||'??';}
function openModal(id){document.getElementById(id).style.display='block';}
function closeModal(id){document.getElementById(id).style.display='none';}
function toggleChitPickedName(){document.getElementById('chitPickedNameDiv').style.display=document.getElementById('pChitPicked').value==='Yes'?'block':'none';}
function showToast(msg,ok=true){const t=document.createElement('div');t.style.cssText=`position:fixed;top:20px;left:50%;transform:translateX(-50%);background:${ok?'#10b981':'#ef4444'};color:white;padding:12px 24px;border-radius:12px;font-weight:700;z-index:9999;`;t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3000);}

// LOGIC HELPERS
function getGroupDueDates(group){
    const start=group.startDate||group.gStart; if(!start) return[];
    const totalMonths=parseInt(group.duration||group.gDuration)||21;
    const dueDay=parseInt(group.dueDay)||new Date(start).getDate();
    const s=new Date(start+'T00:00:00'); const startYear=s.getFullYear(); const startMonth=s.getMonth();
    const pad=n=>String(n).padStart(2,'0'); const dates=[];
    for(let i=0;i<totalMonths;i++){
        const yr=startYear+Math.floor((startMonth+i)/12); const mo=(startMonth+i)%12;
        const maxDay=new Date(yr,mo+1,0).getDate(); const day=Math.min(dueDay,maxDay);
        dates.push(`${yr}-${pad(mo+1)}-${pad(day)}`);
    }
    return dates;
}

function getMonthSlot(dueDates, payDate){
    if(!dueDates.length) return -1;
    if(payDate<dueDates[0]) return 0;
    for(let i=0;i<dueDates.length;i++){
        const nextDue=dueDates[i+1]||'9999-99-99';
        if(payDate>=dueDates[i]&&payDate<nextDue) return i;
    }
    return dueDates.length-1;
}

// UI TABS
function switchTab(t){
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
    document.getElementById(t+'Tab').classList.add('active');
    document.getElementById('nav'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');
    updateUI();
}

async function updateUI(){
    const m=await getCollection('members'); const g=await getCollection('groups'); const p=await getCollection('payments');
    ALL_MEMBERS=m; document.getElementById('memberCount').innerText=m.length; document.getElementById('groupCount').innerText=g.length;
    const today=new Date().toISOString().split('T')[0];
    document.getElementById('todayColl').innerText=fmtAmt(p.filter(x=>x.date===today).reduce((s,x)=>s+(parseFloat(x.paid)||0),0));
    if(document.getElementById('groupsTab').classList.contains('active'))renderGroupsTab();
}

// MEMBER LEDGER
function filterSearch(inputId,listId,hiddenId){
    const query=document.getElementById(inputId).value.toLowerCase();
    const list=document.getElementById(listId); list.innerHTML='';
    if(!query){list.style.display='none';return;}
    const filtered=ALL_MEMBERS.filter(m=>m.name.toLowerCase().includes(query));
    if(filtered.length>0){
        list.style.display='block';
        filtered.forEach(m=>{
            const div=document.createElement('div'); div.className='suggestion-item'; div.innerText=m.name;
            div.onclick=()=>{
                document.getElementById(inputId).value=m.name;
                document.getElementById(hiddenId).value=m.id; list.style.display='none';
                if(hiddenId==='summaryView')loadMemberLedger();
                if(hiddenId==='pMember')linkGroupForPayment();
            };
            list.appendChild(div);
        });
    }else{list.style.display='none';}
}

async function loadMemberLedger(){
    const mid=document.getElementById('summaryView').value; if(!mid)return;
    const ms=await getCollection('members'); const gs=await getCollection('groups'); const ps=await getCollection('payments');
    const m=ms.find(x=>x.id===mid); const mPays=ps.filter(p=>p.memberId===mid);
    const memberGroups=gs.filter(g=>m.groupIds&&m.groupIds.includes(g.id));

    let html = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="font-weight:bold; font-size:1.1rem;">${m.name}</div>
        <button class="btn-pdf" onclick="generateMemberPDF('${mid}')">üìÑ Member PDF</button>
    </div>`;
    
    memberGroups.forEach(grp => {
        const pays = mPays.filter(p => p.groupId === grp.id);
        html += `<div style="background:var(--input-bg); padding:10px; border-radius:10px; margin-bottom:10px;">
            <div style="color:#f39c12; font-weight:bold;">${grp.name}</div>
            <div style="font-size:0.7rem; color:var(--text-dim);">Payments: ${pays.length} | Balance: ${fmtAmt(pays.reduce((s,p)=>s+parseFloat(p.balance||0),0))}</div>
        </div>`;
    });
    document.getElementById('ledgerData').innerHTML = html;
}

// MEMBER & GROUP CRUD (Simplified for brevity, matches original logic)
async function openAddMember(){ document.getElementById('editMemberId').value=''; document.getElementById('mName').value=''; document.getElementById('deleteMemberArea').style.display='none'; const gs=await getCollection('groups'); document.getElementById('groupCheckboxes').innerHTML=gs.map(g=>`<div class="d-flex gap-2"><input type="checkbox" class="group-cb" value="${g.id}"> ${g.name}</div>`).join(''); openModal('memberModal'); }
async function saveMember(){ const n=document.getElementById('mName').value; const gids=Array.from(document.querySelectorAll('.group-cb:checked')).map(cb=>cb.value); if(!n) return; await db.collection('members').add({name:n, groupIds:gids}); closeModal('memberModal'); updateUI(); }
function openAddGroup(){ document.getElementById('editGroupId').value=''; document.getElementById('gName').value=''; openModal('groupModal'); }
async function saveGroup(){ const n=document.getElementById('gName').value; const d=document.getElementById('gDuration').value; const s=document.getElementById('gStart').value; await db.collection('groups').add({name:n, duration:d, startDate:s}); closeModal('groupModal'); updateUI(); }

// PAYMENT HANDLING
function resetPaymentForm(){ document.getElementById('pDate').value=new Date().toISOString().split('T')[0]; document.getElementById('pMemberSearch').value=''; document.getElementById('pGroup').innerHTML='<option value="">-- Select --</option>'; document.getElementById('pNumMonths').value='1'; document.getElementById('pChit').value=''; document.getElementById('pPaid').value=''; document.getElementById('multiMonthPreview').style.display='none'; }
function openPaymentModal(){ resetPaymentForm(); openModal('paymentModal'); }
async function linkGroupForPayment(){ const mid=document.getElementById('pMember').value; const ms=await getCollection('members'); const m=ms.find(x=>x.id===mid); const gs=await getCollection('groups'); document.getElementById('pGroup').innerHTML=gs.filter(g=>m.groupIds&&m.groupIds.includes(g.id)).map(g=>`<option value="${g.id}">${g.name}</option>`).join(''); }
async function onGroupChange(){ if(document.getElementById('pNumMonths').value==='multi') buildMonthSelectorGrid(); }
function onNumMonthsChange(){ const v=document.getElementById('pNumMonths').value; document.getElementById('multiMonthPreview').style.display=v==='multi'?'block':'none'; if(v==='multi') buildMonthSelectorGrid(); }
async function buildMonthSelectorGrid(){
    const mid=document.getElementById('pMember').value; const gid=document.getElementById('pGroup').value; if(!mid||!gid) return;
    const gs=await getCollection('groups'); const grp=gs.find(g=>g.id===gid); const dates=getGroupDueDates(grp);
    document.getElementById('monthSelectorGrid').innerHTML = dates.map((d,i)=>`<label class="month-cb-item"><input type="checkbox" value="${i}" onchange="calcBalance()"> ${fmtDate(d)}</label>`).join('');
}
function calcBalance(){ /* Original balance calculation logic */ }
async function savePayment(){
    const mid=document.getElementById('pMember').value; const gid=document.getElementById('pGroup').value; const date=document.getElementById('pDate').value;
    const chit=parseFloat(document.getElementById('pChit').value)||0; const paid=parseFloat(document.getElementById('pPaid').value)||0;
    const slots=Array.from(document.querySelectorAll('#monthSelectorGrid input:checked')).map(cb=>parseInt(cb.value));
    await db.collection('payments').add({memberId:mid, groupId:gid, date, chit, paid, balance:Math.max(0,chit-paid), monthSlots:slots, numMonths:slots.length||1});
    closeModal('paymentModal'); updateUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF RENDER CORE (FIXED)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPDF(filename){
    return new Promise((resolve)=>{
        const wrapper=document.getElementById('pdf-template');
        const content=document.getElementById('pdfContent');
        wrapper.classList.add('rendering');
        wrapper.style.visibility='visible';

        const opt={
            margin: 0, // Set to 0 to prevent internal shifting
            filename,
            image:{type:'jpeg',quality:0.98},
            html2canvas:{
                scale:2,
                useCORS:true,
                logging:false,
                letterRendering:true, // Helps with font spacing
                backgroundColor:'#ffffff'
            },
            jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},
            pagebreak:{mode:['avoid-all','css','legacy']}
        };

        setTimeout(()=>{
            html2pdf().set(opt).from(content).save().then(()=>{
                wrapper.classList.remove('rendering');
                wrapper.style.visibility='hidden';
                resolve();
            });
        },500);
    });
}

// PDF ‚Äî MEMBER STATEMENT
async function generateMemberPDF(mid){
    showToast('‚è≥ Generating Member Report...');
    const ms=await getCollection('members'); const gs=await getCollection('groups'); const ps=await getCollection('payments');
    const m=ms.find(x=>x.id===mid); const mPays=ps.filter(p=>p.memberId===mid);
    const memberGroups=gs.filter(g=>m.groupIds&&m.groupIds.includes(g.id));
    const today=new Date().toLocaleDateString('en-IN');

    let groupHtml = memberGroups.map(g => {
        const pays = mPays.filter(p=>p.groupId===g.id);
        const allDue = getGroupDueDates(g);
        return `<div style="margin-top:20px;">
            <div class="pdf-group-title">üìÇ ${g.name}</div>
            <table class="pdf-table">
                <thead><tr><th>Month</th><th>Date</th><th>Paid</th><th>Bal</th></tr></thead>
                <tbody>${pays.map(p=>`<tr><td>${fmtDate(allDue[p.monthSlot])}</td><td>${fmtDate(p.date)}</td><td>${fmtAmt(p.paid)}</td><td>${fmtAmt(p.balance)}</td></tr>`).join('')}</tbody>
            </table>
        </div>`;
    }).join('');

    document.getElementById('pdfContent').innerHTML=`
        <div class="pdf-page">
            <div class="pdf-header">
                <div><div class="pdf-brand">üèÜ AK CHIT FUNDS</div><div class="pdf-brand-sub">Admin Portal</div></div>
                <div><div class="pdf-right-title">MEMBER STATEMENT</div><div class="pdf-right-sub">${today}</div></div>
            </div>
            <div class="pdf-member-box">
                <div class="pdf-member-name">${m.name}</div>
                <div class="pdf-member-sub">Phone: ${m.phone||'‚Äî'} | Groups: ${memberGroups.length}</div>
            </div>
            ${groupHtml}
            <div class="pdf-footer"><span>Generated for ${m.name}</span><span>Page 1</span></div>
        </div>`;
    await renderPDF(`Report_${m.name}.pdf`);
}

// PDF ‚Äî GROUP REPORT
async function renderGroupsTab(){
    const gs=await getCollection('groups'); const ms=await getCollection('members'); const ps=await getCollection('payments');
    document.getElementById('groupListArea').innerHTML=gs.map(g=>{
        return `<div class="group-card">
            <div class="d-flex justify-content-between">
                <div style="color:#f39c12; font-weight:bold;">${g.name}</div>
                <button class="btn-pdf" onclick="generateGroupPDF('${g.id}')">üìÑ Group PDF</button>
            </div>
        </div>`;
    }).join('');
}

async function generateGroupPDF(gid){
    showToast('‚è≥ Generating Group Report...');
    const gs=await getCollection('groups'); const ms=await getCollection('members'); const ps=await getCollection('payments');
    const g=gs.find(x=>x.id===gid); const gMs=ms.filter(m=>m.groupIds&&m.groupIds.includes(g.id));
    const gPays=ps.filter(p=>p.groupId===gid);
    const today=new Date().toLocaleDateString('en-IN');

    const rows = gMs.map((m,i)=>{
        const mp=gPays.filter(p=>p.memberId===m.id);
        return `<tr><td>${i+1}</td><td>${m.name}</td><td>${fmtAmt(mp.reduce((s,p)=>s+parseFloat(p.paid||0),0))}</td><td>${fmtAmt(mp.reduce((s,p)=>s+parseFloat(p.balance||0),0))}</td></tr>`;
    }).join('');

    document.getElementById('pdfContent').innerHTML=`
        <div class="pdf-page">
            <div class="pdf-header">
                <div><div class="pdf-brand">üèÜ AK CHIT FUNDS</div><div class="pdf-brand-sub">Group Management</div></div>
                <div><div class="pdf-right-title">GROUP STATEMENT</div><div class="pdf-right-sub">${today}</div></div>
            </div>
            <div class="pdf-member-box">
                <div class="pdf-member-name">üìÇ ${g.name}</div>
                <div class="pdf-member-sub">Duration: ${g.duration} months | Start: ${fmtDate(g.startDate)}</div>
            </div>
            <table class="pdf-table">
                <thead><tr><th>#</th><th>Member Name</th><th>Total Paid</th><th>Balance</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>
            <div class="pdf-footer"><span>Report for ${g.name}</span><span>Page 1</span></div>
        </div>`;
    await renderPDF(`GroupReport_${g.name}.pdf`);
}

// INIT
switchTab('home');
</script>
</body>
</html>
