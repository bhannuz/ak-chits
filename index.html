<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>AK Chit Funds - Admin Portal</title>
Â  Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
Â  Â  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
Â  Â  <style>
Â  Â  Â  Â  :root { --bg-dark:#0a0e1a; --card-bg:#141b2d; --input-bg:#1c253b; --accent-gold:linear-gradient(90deg,#ff9800,#f57c00); --text-main:#ffffff; --text-dim:#8e9aaf; --border:#252f48; }
Â  Â  Â  Â  * { box-sizing:border-box; }
Â  Â  Â  Â  body { background-color:var(--bg-dark); color:var(--text-main); font-family:'Segoe UI',sans-serif; padding-bottom:120px; }
Â  Â  Â  Â  .app-header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid var(--border); }
Â  Â  Â  Â  .brand { color:#f39c12; font-weight:bold; font-size:1.3rem; }
Â  Â  Â  Â  .stat-card { background:var(--card-bg); border:1px solid var(--border); border-radius:15px; padding:15px; text-align:center; }
Â  Â  Â  Â  .stat-num { font-size:1.3rem; font-weight:bold; display:block; }
Â  Â  Â  Â  .stat-label { font-size:0.65rem; color:var(--text-dim); text-transform:uppercase; }

Â  Â  Â  Â  /* MODALS */
Â  Â  Â  Â  .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.92); z-index:2000; padding:20px; overflow-y:auto; }
Â  Â  Â  Â  .modal-content-custom { background:var(--card-bg); border-radius:25px; padding:25px; max-width:450px; margin:20px auto; border:1px solid var(--border); }
Â  Â  Â  Â  .form-input { background:var(--input-bg); border:1px solid var(--border); color:white; padding:12px; border-radius:12px; width:100%; margin-bottom:12px; font-size:0.9rem; }
Â  Â  Â  Â  .form-input option { background:#1c253b; }
Â  Â  Â  Â  .form-label-small { font-size:0.72rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:.5px; margin-bottom:5px; display:block; }
Â  Â  Â  Â  .btn-save { background:var(--accent-gold); color:black; border:none; width:100%; padding:14px; border-radius:14px; font-weight:bold; margin-bottom:10px; cursor:pointer; font-size:0.95rem; }
Â  Â  Â  Â  .btn-cancel { background:var(--input-bg); color:white; border:none; width:100%; padding:12px; border-radius:14px; cursor:pointer; }
Â  Â  Â  Â  .btn-danger-full { background:linear-gradient(135deg,#ef4444,#dc2626); color:white; border:none; width:100%; padding:12px; border-radius:14px; font-weight:700; cursor:pointer; margin-bottom:10px; }
Â  Â  Â  Â  .modal-title { font-size:1.1rem; font-weight:800; margin-bottom:16px; }

Â  Â  Â  Â  /* NAV */
Â  Â  Â  Â  .nav-bar { position:fixed; bottom:0; width:100%; background:#070b14; display:flex; justify-content:space-around; padding:12px 0 calc(12px + env(safe-area-inset-bottom)); border-top:1px solid var(--border); z-index:1000; }
Â  Â  Â  Â  .nav-item { cursor:pointer; text-align:center; font-size:0.62rem; color:var(--text-dim); padding:4px 10px; }
Â  Â  Â  Â  .nav-item.active { color:#f39c12; }
Â  Â  Â  Â  .tab-content { display:none; }
Â  Â  Â  Â  .tab-content.active { display:block; }

Â  Â  Â  Â  /* TABLES */
Â  Â  Â  Â  .table-custom { color:white; font-size:0.7rem; width:100%; border-collapse:collapse; }
Â  Â  Â  Â  .table-custom th { color:var(--text-dim); border-bottom:1px solid var(--border); padding:8px 5px; font-size:0.6rem; text-transform:uppercase; white-space:nowrap; }
Â  Â  Â  Â  .table-custom td { padding:9px 5px; border-bottom:1px solid rgba(255,255,255,0.05); vertical-align:middle; white-space:nowrap; }
Â  Â  Â  Â  .table-custom tr.chit-picked { background:rgba(16,185,129,0.08); }
Â  Â  Â  Â  .table-custom tr.chit-picked td:first-child { border-left:3px solid #10b981; }
Â  Â  Â  Â  .table-custom tr.due-row { background:rgba(239,68,68,0.07); }
Â  Â  Â  Â  .table-custom tr.due-row td { color:#f87171; font-style:italic; }
Â  Â  Â  Â  .table-custom tr.partial-row { background:rgba(245,158,11,0.07); }
Â  Â  Â  Â  /* Multi-month highlight */
Â  Â  Â  Â  .table-custom tr.multi-month-row { background:rgba(99,102,241,0.09); }
Â  Â  Â  Â  .table-custom tr.multi-month-row td:first-child { border-left:3px solid #818cf8; }
Â  Â  Â  Â  .due-badge { display:inline-block; background:rgba(239,68,68,0.15); color:#f87171; border:1px solid rgba(239,68,68,0.3); border-radius:4px; padding:1px 6px; font-size:0.6rem; font-weight:700; }
Â  Â  Â  Â  .partial-badge { display:inline-block; background:rgba(245,158,11,0.2); color:#fbbf24; border:1px solid rgba(245,158,11,0.4); border-radius:4px; padding:1px 6px; font-size:0.6rem; font-weight:700; }
Â  Â  Â  Â  .chit-yes-badge { display:inline-block; background:rgba(16,185,129,0.2); color:#34d399; border:1px solid rgba(16,185,129,0.4); border-radius:5px; padding:2px 7px; font-size:0.6rem; font-weight:800; }
Â  Â  Â  Â  .chit-no { color:var(--text-dim); font-size:0.65rem; }
Â  Â  Â  Â  /* Multi-month badge */
Â  Â  Â  Â  .multi-month-badge { display:inline-flex; align-items:center; gap:3px; background:rgba(99,102,241,0.18); color:#a5b4fc; border:1px solid rgba(99,102,241,0.4); border-radius:5px; padding:2px 7px; font-size:0.6rem; font-weight:800; }

Â  Â  Â  Â  /* AUTOCOMPLETE */
Â  Â  Â  Â  .suggestions-list { position:absolute; top:100%; left:0; right:0; background:var(--input-bg); border:1px solid var(--border); border-radius:0 0 12px 12px; z-index:3000; max-height:200px; overflow-y:auto; display:none; margin-top:-12px; }
Â  Â  Â  Â  .suggestion-item { padding:12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.9rem; }
Â  Â  Â  Â  .suggestion-item:hover { background:#252f48; color:#f39c12; }

Â  Â  Â  Â  /* GROUP CHECKBOX */
Â  Â  Â  Â  .group-checkbox-area { max-height:150px; overflow-y:auto; background:var(--input-bg); padding:10px; border-radius:12px; border:1px solid var(--border); margin-bottom:15px; }

Â  Â  Â  Â  /* STAT BOXES */
Â  Â  Â  Â  .mini-stat { background:var(--input-bg); border-radius:10px; padding:10px 8px; text-align:center; }
Â  Â  Â  Â  .mini-stat-val { font-size:0.9rem; font-weight:800; }
Â  Â  Â  Â  .mini-stat-lbl { font-size:0.6rem; color:var(--text-dim); text-transform:uppercase; margin-top:2px; }

Â  Â  Â  Â  /* PROGRESS BAR */
Â  Â  Â  Â  .prog-bar-outer { background:#252f48; border-radius:5px; height:7px; overflow:hidden; margin:6px 0 3px; }
Â  Â  Â  Â  .prog-bar-inner { height:100%; border-radius:5px; background:linear-gradient(90deg,#f39c12,#f57c00); }
Â  Â  Â  Â  .prog-label { font-size:0.65rem; color:var(--text-dim); display:flex; justify-content:space-between; }

Â  Â  Â  Â  /* LIST TAB */
Â  Â  Â  Â  .list-group-header { background:#1c253b; padding:12px 15px; border-radius:10px; margin-top:12px; font-weight:bold; color:#f39c12; border-left:4px solid #f39c12; display:flex; justify-content:space-between; align-items:center; cursor:pointer; user-select:none; }

Â  Â  Â  Â  /* MONTHS BADGE */
Â  Â  Â  Â  .months-badge { display:inline-flex; align-items:center; gap:5px; background:rgba(99,102,241,.15); border:1px solid rgba(99,102,241,.3); border-radius:8px; padding:4px 10px; font-size:0.72rem; font-weight:700; color:#a5b4fc; }

Â  Â  Â  Â  /* PDF BUTTON */
Â  Â  Â  Â  .btn-pdf { background:linear-gradient(135deg,#e74c3c,#c0392b); color:white; border:none; border-radius:8px; padding:7px 13px; font-size:0.75rem; font-weight:700; cursor:pointer; }

Â  Â  Â  Â  /* EDIT/DELETE SMALL BUTTONS */
Â  Â  Â  Â  .btn-edit-sm { background:rgba(243,156,18,.12); border:1px solid rgba(243,156,18,.35); color:#f39c12; border-radius:7px; padding:4px 10px; font-size:0.68rem; font-weight:700; cursor:pointer; }
Â  Â  Â  Â  .btn-del-sm { background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35); color:#f87171; border-radius:7px; padding:4px 10px; font-size:0.68rem; font-weight:700; cursor:pointer; }

Â  Â  Â  Â  /* GROUPS TAB COLLAPSIBLE */
Â  Â  Â  Â  .group-card { background:var(--card-bg); border:1px solid var(--border); border-radius:16px; padding:16px; margin-bottom:14px; overflow:hidden; }
Â  Â  Â  Â  .group-card-header { cursor:pointer; user-select:none; }
Â  Â  Â  Â  .group-body { transition:max-height 0.3s ease, opacity 0.3s ease; overflow:hidden; }
Â  Â  Â  Â  .group-body.collapsed { max-height:0 !important; opacity:0; }
Â  Â  Â  Â  .chevron-icon { transition:transform 0.25s ease; display:inline-block; font-size:0.8rem; color:var(--text-dim); }
Â  Â  Â  Â  .chevron-icon.open { transform: rotate(0deg); }
Â  Â  Â  Â  .chevron-icon.closed { transform: rotate(-90deg); }

Â  Â  Â  Â  /* Multi-month preview box */
Â  Â  Â  Â  .multi-month-preview { background:rgba(99,102,241,0.08); border:1px solid rgba(99,102,241,0.25); border-radius:12px; padding:12px 14px; margin-bottom:12px; display:none; }
Â  Â  Â  Â  .multi-month-preview-title { font-size:0.68rem; color:#a5b4fc; font-weight:700; text-transform:uppercase; letter-spacing:.5px; margin-bottom:8px; }
Â  Â  Â  Â  .multi-month-chip { display:inline-flex; align-items:center; background:rgba(99,102,241,0.2); border:1px solid rgba(99,102,241,0.35); border-radius:6px; padding:3px 9px; font-size:0.68rem; color:#c7d2fe; margin:2px; font-weight:600; }
Â  Â  Â  Â  /* Month selector checkboxes */
Â  Â  Â  Â  .month-selector-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; max-height:220px; overflow-y:auto; }
Â  Â  Â  Â  .month-cb-item { display:flex; align-items:center; gap:6px; background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:8px; padding:6px 8px; cursor:pointer; transition:all .15s; font-size:0.68rem; }
Â  Â  Â  Â  .month-cb-item:hover { background:rgba(99,102,241,0.12); border-color:rgba(99,102,241,0.4); }
Â  Â  Â  Â  .month-cb-item.selected { background:rgba(99,102,241,0.2); border-color:rgba(99,102,241,0.6); color:#a5b4fc; font-weight:700; }
Â  Â  Â  Â  .month-cb-item.already-paid { background:rgba(16,185,129,0.07); border-color:rgba(16,185,129,0.3); color:#34d399; opacity:0.6; cursor:not-allowed; }
Â  Â  Â  Â  .month-cb-item input[type=checkbox] { accent-color:#818cf8; width:13px; height:13px; flex-shrink:0; }
Â  Â  Â  Â  .selected-summary { font-size:0.68rem; color:#a5b4fc; margin-top:8px; font-weight:700; padding:6px 10px; background:rgba(99,102,241,0.12); border-radius:8px; }

Â  Â  Â  Â  /* â•â• PDF STYLES â•â• */
Â  Â  Â  Â  #pdf-template { position:absolute; left:-9999px; top:0; width:794px; visibility:hidden; pointer-events:none; background:white; }
Â  Â  Â  Â  #pdf-template.rendering { visibility:visible; }
Â  Â  Â  Â  .pdf-page { background:white; color:#111; padding:20px 30px; font-family:'Segoe UI',Arial,sans-serif; width:750px; }
Â  Â  Â  Â  .pdf-header { display:flex; justify-content:space-between; align-items:flex-start; border-bottom:4px solid #f39c12; padding-bottom:14px; margin-bottom:20px; }
Â  Â  Â  Â  .pdf-brand { font-size:26px; font-weight:900; color:#f39c12; }
Â  Â  Â  Â  .pdf-brand-sub { font-size:11px; color:#888; margin-top:2px; }
Â  Â  Â  Â  .pdf-right-title { font-size:16px; font-weight:800; text-align:right; }
Â  Â  Â  Â  .pdf-right-sub { font-size:11px; color:#888; text-align:right; margin-top:3px; }
Â  Â  Â  Â  .pdf-member-box { background:#fffbf0; border:2px solid #f39c12; border-radius:12px; padding:16px 20px; margin-bottom:20px; }
Â  Â  Â  Â  .pdf-member-name { font-size:20px; font-weight:800; }
Â  Â  Â  Â  .pdf-member-sub { font-size:12px; color:#555; margin-top:4px; }
Â  Â  Â  Â  .pdf-stats-row { display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
Â  Â  Â  Â  .pdf-stat-box { flex:1; min-width:100px; border:1px solid #ddd; border-radius:8px; padding:10px; text-align:center; background:white; }
Â  Â  Â  Â  .pdf-stat-val { font-size:15px; font-weight:800; }
Â  Â  Â  Â  .pdf-stat-lbl { font-size:9px; color:#888; text-transform:uppercase; letter-spacing:.4px; margin-top:2px; }
Â  Â  Â  Â  .pdf-section-title { font-size:11px; font-weight:800; color:#888; text-transform:uppercase; letter-spacing:1px; margin:20px 0 8px; border-bottom:1px solid #eee; padding-bottom:6px; }
Â  Â  Â  Â  .pdf-group-title { font-size:13px; font-weight:800; margin-bottom:6px; color:#111; }
Â  Â  Â  Â  .pdf-progress-outer { background:#eee; border-radius:5px; height:8px; margin-bottom:4px; overflow:hidden; }
Â  Â  Â  Â  .pdf-progress-inner { height:100%; background:linear-gradient(90deg,#f39c12,#f57c00); border-radius:5px; }
Â  Â  Â  Â  .pdf-table { width:100%; border-collapse:collapse; font-size:11px; margin-bottom:20px; }
Â  Â  Â  Â  .pdf-table th { background:#f5f5f5; border:1px solid #ccc; padding:7px 9px; font-size:9px; text-transform:uppercase; color:#555; text-align:left; }
Â  Â  Â  Â  .pdf-table td { border:1px solid #ddd; padding:7px 9px; }
Â  Â  Â  Â  .pdf-table tr:nth-child(even) td { background:#fafafa; }
Â  Â  Â  Â  .pdf-table tr.pdf-chit-row td { background:#f0fff8 !important; }
Â  Â  Â  Â  .pdf-table tr.pdf-chit-row td:first-child { border-left:3px solid #10b981; }
Â  Â  Â  Â  .pdf-table tr.pdf-due-row td { background:#fff5f5 !important; color:#c0392b; font-style:italic; }
Â  Â  Â  Â  .pdf-table tr.pdf-partial-row td { background:#fffbeb !important; }
Â  Â  Â  Â  .pdf-table tr.pdf-multi-row td { background:#eef2ff !important; }
Â  Â  Â  Â  .pdf-table tr.pdf-multi-row td:first-child { border-left:3px solid #818cf8; }
Â  Â  Â  Â  .pdf-chit-badge { background:#d1fae5; color:#065f46; border-radius:4px; padding:2px 6px; font-size:9px; font-weight:800; }
Â  Â  Â  Â  .pdf-due-badge { background:#fee2e2; color:#b91c1c; border-radius:4px; padding:2px 6px; font-size:9px; font-weight:800; }
Â  Â  Â  Â  .pdf-partial-badge { background:#fef3c7; color:#92400e; border-radius:4px; padding:2px 6px; font-size:9px; font-weight:800; }
Â  Â  Â  Â  .pdf-multi-badge { background:#e0e7ff; color:#3730a3; border-radius:4px; padding:2px 6px; font-size:9px; font-weight:800; }
Â  Â  Â  Â  .pdf-total-row td { background:#fff8e1 !important; font-weight:800; border-top:2px solid #f39c12; }
Â  Â  Â  Â  .pdf-footer { margin-top:24px; border-top:1px solid #ddd; padding-top:12px; display:flex; justify-content:space-between; font-size:10px; color:#aaa; }
Â  Â  </style>
</head>
<body>

<div class="container py-2">
Â  Â  <div class="app-header">
Â  Â  Â  Â  <div class="brand">ğŸ† AK Chit Funds <small style="font-size:0.5em;color:#2ecc71;">â˜ CLOUD</small></div>
Â  Â  Â  Â  <span class="badge text-warning border border-warning px-2">ADMIN</span>
Â  Â  </div>

Â  Â  <!-- HOME TAB -->
Â  Â  <div id="homeTab" class="tab-content active">
Â  Â  Â  Â  <div class="row g-2 mt-3 text-center">
Â  Â  Â  Â  Â  Â  <div class="col-4"><div class="stat-card"><span class="stat-num" id="memberCount">-</span><span class="stat-label">Members</span></div></div>
Â  Â  Â  Â  Â  Â  <div class="col-4"><div class="stat-card"><span class="stat-num" id="groupCount">-</span><span class="stat-label">Groups</span></div></div>
Â  Â  Â  Â  Â  Â  <div class="col-4"><div class="stat-card"><span class="stat-num text-success" id="todayColl">â‚¹0</span><span class="stat-label">Today</span></div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="display:flex;gap:8px;margin-top:12px;">
Â  Â  Â  Â  Â  Â  <button class="btn btn-warning w-100 py-3 fw-bold shadow" onclick="openPaymentModal()" style="border-radius:20px;">ğŸ’³ Record Payment</button>
Â  Â  Â  Â  Â  Â  <button onclick="resetPaymentForm();openModal('paymentModal');" title="Refresh Form" style="background:var(--card-bg);border:1px solid var(--border);color:#f39c12;border-radius:20px;padding:0 18px;font-size:1.2rem;cursor:pointer;flex-shrink:0;">ğŸ”„</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- MEMBER SEARCH -->
Â  Â  Â  Â  <div class="p-3 my-3" style="background:var(--card-bg);border-radius:20px;border:1px solid var(--border);">
Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;align-items:flex-start;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="position:relative;flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="summarySearch" class="form-input" style="margin-bottom:0;" placeholder="ğŸ” Search Member for Summary / PDF..." oninput="filterSearch('summarySearch','summaryList','summaryView')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="summaryView">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="summaryList" class="suggestions-list"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="clearMemberSearch()" title="Clear / Refresh" style="background:var(--input-bg);border:1px solid var(--border);color:#f39c12;border-radius:12px;padding:12px 14px;font-size:1rem;cursor:pointer;flex-shrink:0;line-height:1;">ğŸ”„</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="ledgerData"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- QUICK ACTION BUTTONS -->
Â  Â  Â  Â  <div class="d-flex gap-2">
Â  Â  Â  Â  Â  Â  <button class="btn btn-outline-warning w-100 py-3 fw-bold" onclick="openAddMember()">ğŸ‘¤ Create Member</button>
Â  Â  Â  Â  Â  Â  <button class="btn btn-outline-success w-100 py-3 fw-bold" onclick="openAddGroup()">ğŸ¦ New Group</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- GROUPS TAB -->
Â  Â  <div id="groupsTab" class="tab-content"><div id="groupListArea" class="mt-2"></div></div>

Â  Â  <!-- LIST TAB -->
Â  Â  <div id="listTab" class="tab-content"><div id="simpleListArea" class="mt-2"></div></div>

Â  Â  <!-- BACKUP TAB -->
Â  Â  <div id="backupTab" class="tab-content">
Â  Â  Â  Â  <h5 class="mt-4 mb-3 text-warning text-center">ğŸ’¾ Data Management</h5>
Â  Â  Â  Â  <div class="stat-card p-4">
Â  Â  Â  Â  Â  Â  <button class="btn btn-warning w-100 py-3 mb-3 fw-bold" onclick="exportFullBackup()">ğŸ’¾ Download JSON Backup</button>
Â  Â  Â  Â  Â  Â  <hr style="border-color:var(--border);">
Â  Â  Â  Â  Â  Â  <p class="small mb-2" style="color:var(--text-dim);">Restore all data from backup file:</p>
Â  Â  Â  Â  Â  Â  <input type="file" id="restoreFile" class="form-control mb-2 bg-dark text-white border-secondary" accept=".json">
Â  Â  Â  Â  Â  Â  <button class="btn btn-outline-info w-100 py-3 fw-bold" onclick="confirmRestore()">ğŸ”„ Restore All Data</button>
Â  Â  Â  Â  Â  Â  <p class="small mt-2 text-center" style="color:#ef4444;">âš ï¸ This will overwrite existing data</p>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<!-- PDF TEMPLATE - off screen container -->
<div id="pdf-template"><div id="pdfContent" style="background:white;font-family:'Segoe UI',Arial,sans-serif;width:794px;color:#111;"></div></div>

<!-- â•â•â•â•â•â• MODALS â•â•â•â•â•â• -->

<!-- MEMBER MODAL -->
<div id="memberModal" class="modal-overlay">
Â  Â  <div class="modal-content-custom">
Â  Â  Â  Â  <div class="modal-title" id="memberModalTitle">ğŸ‘¤ Create Member</div>
Â  Â  Â  Â  <input type="hidden" id="editMemberId">
Â  Â  Â  Â  <label class="form-label-small">Full Name</label>
Â  Â  Â  Â  <input type="text" id="mName" class="form-input" placeholder="e.g. Rama Krishna">
Â  Â  Â  Â  <label class="form-label-small">Phone Number</label>
Â  Â  Â  Â  <input type="text" id="mPhone" class="form-input" placeholder="e.g. 9876543210">
Â  Â  Â  Â  <label class="form-label-small">Assign to Groups</label>
Â  Â  Â  Â  <div id="groupCheckboxes" class="group-checkbox-area"></div>
Â  Â  Â  Â  <button class="btn-save" onclick="saveMember()">âœ“ Save Member</button>
Â  Â  Â  Â  <div id="deleteMemberArea" style="display:none;">
Â  Â  Â  Â  Â  Â  <button class="btn-danger-full" onclick="deleteMemberFromModal()">ğŸ—‘ Delete Member</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="btn-cancel" onclick="closeModal('memberModal')">Cancel</button>
Â  Â  </div>
</div>

<!-- GROUP MODAL -->
<div id="groupModal" class="modal-overlay">
Â  Â  <div class="modal-content-custom">
Â  Â  Â  Â  <div class="modal-title" id="groupModalTitle">ğŸ¦ New Group</div>
Â  Â  Â  Â  <input type="hidden" id="editGroupId">
Â  Â  Â  Â  <label class="form-label-small">Group Name</label>
Â  Â  Â  Â  <input type="text" id="gName" class="form-input" placeholder="e.g. Group A">
Â  Â  Â  Â  <label class="form-label-small">Duration (Months)</label>
Â  Â  Â  Â  <input type="number" id="gDuration" class="form-input" placeholder="e.g. 21">
Â  Â  Â  Â  <label class="form-label-small">Monthly Due Day (1â€“31)</label>
Â  Â  Â  Â  <input type="number" id="gDueDay" class="form-input" placeholder="e.g. 5 means 5th of every month" min="1" max="31">
Â  Â  Â  Â  <label class="form-label-small">Start Date</label>
Â  Â  Â  Â  <input type="date" id="gStart" class="form-input">
Â  Â  Â  Â  <button class="btn-save" onclick="saveGroup()">âœ“ Save Group</button>
Â  Â  Â  Â  <div id="deleteGroupArea" style="display:none;">
Â  Â  Â  Â  Â  Â  <button class="btn-danger-full" onclick="deleteGroupFromModal()">ğŸ—‘ Delete Group</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="btn-cancel" onclick="closeModal('groupModal')">Cancel</button>
Â  Â  </div>
</div>

<!-- PAYMENT MODAL â€” with multi-month support -->
<div id="paymentModal" class="modal-overlay">
Â  Â  <div class="modal-content-custom">
Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
Â  Â  Â  Â  Â  Â  <div class="modal-title" style="margin-bottom:0;">ğŸ’³ Record Payment</div>
Â  Â  Â  Â  Â  Â  <button onclick="resetPaymentForm()" title="Clear all fields" style="background:rgba(243,156,18,.12);border:1px solid rgba(243,156,18,.3);color:#f39c12;border-radius:10px;padding:6px 12px;font-size:0.75rem;font-weight:700;cursor:pointer;">ğŸ”„ Refresh</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <label class="form-label-small">Payment Date</label>
Â  Â  Â  Â  <input type="date" id="pDate" class="form-input">
Â  Â  Â  Â  <label class="form-label-small">Member</label>
Â  Â  Â  Â  <div style="position:relative;">
Â  Â  Â  Â  Â  Â  <input type="text" id="pMemberSearch" class="form-input" placeholder="ğŸ” Search Member..." oninput="filterSearch('pMemberSearch','pMemberList','pMember')">
Â  Â  Â  Â  Â  Â  <input type="hidden" id="pMember">
Â  Â  Â  Â  Â  Â  <div id="pMemberList" class="suggestions-list"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <label class="form-label-small">Group</label>
Â  Â  Â  Â  <select id="pGroup" class="form-input" onchange="onGroupChange()"><option value="">-- Select Member First --</option></select>

Â  Â  Â  Â  <!-- â”€â”€ MULTI-MONTH SELECTOR â”€â”€ -->
Â  Â  Â  Â  <label class="form-label-small">Number of Months Paying</label>
Â  Â  Â  Â  <div style="display:flex;gap:8px;margin-bottom:8px;">
Â  Â  Â  Â  Â  Â  <select id="pNumMonths" class="form-input" style="margin-bottom:0;flex:1;" onchange="onNumMonthsChange()">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="1">1 Month (Normal)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="multi">Multiple Months (pick below) ğŸ“…</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Month picker grid â€” shown when "Multiple Months" is selected -->
Â  Â  Â  Â  <div id="multiMonthPreview" class="multi-month-preview">
Â  Â  Â  Â  Â  Â  <div class="multi-month-preview-title">ğŸ“… Select Months to Pay</div>
Â  Â  Â  Â  Â  Â  <div style="font-size:0.62rem;color:var(--text-dim);margin-bottom:8px;">âœ… Green = already paid &nbsp;|&nbsp; Tick boxes to select months being paid now</div>
Â  Â  Â  Â  Â  Â  <div id="monthSelectorGrid" class="month-selector-grid"></div>
Â  Â  Â  Â  Â  Â  <div id="selectedSummary" class="selected-summary" style="display:none;"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row g-2">
Â  Â  Â  Â  Â  Â  <div class="col-6">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label-small">Chit Amount <span id="perMonthLabel" style="color:#a5b4fc;font-size:0.65rem;"></span></label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="pChit" class="form-input" placeholder="â‚¹ per month" oninput="calcBalance()">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-6">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label-small">Total Amount Paid</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="pPaid" class="form-input" placeholder="â‚¹ total" oninput="calcBalance()">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <!-- Total chit reference -->
Â  Â  Â  Â  <div id="totalChitRef" style="display:none;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.25);border-radius:10px;padding:8px 12px;margin-bottom:12px;font-size:0.75rem;">
Â  Â  Â  Â  Â  Â  <span style="color:var(--text-dim);">Total Chit Value:</span>
Â  Â  Â  Â  Â  Â  <span id="totalChitVal" style="color:#a5b4fc;font-weight:700;margin-left:6px;"></span>
Â  Â  Â  Â  Â  Â  <span style="color:var(--text-dim);margin-left:12px;">Balance:</span>
Â  Â  Â  Â  Â  Â  <span id="totalBalVal" style="color:#f59e0b;font-weight:700;margin-left:6px;"></span>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <label class="form-label-small">Paid By</label>
Â  Â  Â  Â  <select id="pPaidBy" class="form-input">
Â  Â  Â  Â  Â  Â  <option value="">-- Select Mode --</option>
Â  Â  Â  Â  Â  Â  <option>UPI</option><option>GPay</option><option>PhonePe</option>
Â  Â  Â  Â  Â  Â  <option>PPay</option><option>Bank Transfer</option><option>Cash</option><option>Cheque</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <label class="form-label-small">Chit Picked?</label>
Â  Â  Â  Â  <select id="pChitPicked" class="form-input" onchange="toggleChitPickedName()">
Â  Â  Â  Â  Â  Â  <option value="No">No</option>
Â  Â  Â  Â  Â  Â  <option value="Yes">Yes âœ…</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <div id="chitPickedNameDiv" style="display:none;">
Â  Â  Â  Â  Â  Â  <label class="form-label-small">Picked By (Name)</label>
Â  Â  Â  Â  Â  Â  <input type="text" id="pChitPickedBy" class="form-input" placeholder="Member who picked chit">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="btn-save" onclick="savePayment()">âœ“ Sync Payment</button>
Â  Â  Â  Â  <button class="btn-cancel" onclick="closeModal('paymentModal')">Cancel</button>
Â  Â  </div>
</div>

<!-- EDIT PAYMENT MODAL -->
<div id="editPaymentModal" class="modal-overlay">
Â  Â  <div class="modal-content-custom">
Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
Â  Â  Â  Â  Â  Â  <div class="modal-title" style="margin-bottom:0;">âœï¸ Edit Payment</div>
Â  Â  Â  Â  Â  Â  <button onclick="closeModal('editPaymentModal')" style="background:none;border:none;color:var(--text-dim);font-size:1.3rem;cursor:pointer;">âœ•</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <input type="hidden" id="epId">
Â  Â  Â  Â  <!-- Multi-month info display (read-only) -->
Â  Â  Â  Â  <div id="epMultiMonthInfo" style="display:none;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.3);border-radius:10px;padding:10px 14px;margin-bottom:12px;">
Â  Â  Â  Â  Â  Â  <div style="font-size:0.68rem;color:#a5b4fc;font-weight:700;margin-bottom:4px;">ğŸ“… MULTI-MONTH PAYMENT</div>
Â  Â  Â  Â  Â  Â  <div id="epMultiMonthDetail" style="font-size:0.75rem;color:#c7d2fe;"></div>
Â  Â  Â  Â  Â  Â  <div style="font-size:0.62rem;color:var(--text-dim);margin-top:4px;">This is part of a grouped payment. Editing updates this month's record only.</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <label class="form-label-small">Payment Date</label>
Â  Â  Â  Â  <input type="date" id="epDate" class="form-input">
Â  Â  Â  Â  <div class="row g-2">
Â  Â  Â  Â  Â  Â  <div class="col-6"><label class="form-label-small">Chit Amount</label><input type="number" id="epChit" class="form-input" placeholder="â‚¹" oninput="epCalcBalance()"></div>
Â  Â  Â  Â  Â  Â  <div class="col-6"><label class="form-label-small">Amount Paid</label><input type="number" id="epPaid" class="form-input" placeholder="â‚¹" oninput="epCalcBalance()"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <label class="form-label-small">Balance (auto)</label>
Â  Â  Â  Â  <input type="number" id="epBal" class="form-input" placeholder="Balance" readonly style="opacity:.7;">
Â  Â  Â  Â  <label class="form-label-small">Paid By</label>
Â  Â  Â  Â  <select id="epPaidBy" class="form-input">
Â  Â  Â  Â  Â  Â  <option value="">-- Select Mode --</option>
Â  Â  Â  Â  Â  Â  <option>UPI</option><option>GPay</option><option>PhonePe</option>
Â  Â  Â  Â  Â  Â  <option>PPay</option><option>Bank Transfer</option><option>Cash</option><option>Cheque</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <label class="form-label-small">Chit Picked?</label>
Â  Â  Â  Â  <select id="epChitPicked" class="form-input" onchange="epTogglePickedName()">
Â  Â  Â  Â  Â  Â  <option value="No">No</option>
Â  Â  Â  Â  Â  Â  <option value="Yes">Yes âœ…</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <div id="epChitPickedNameDiv" style="display:none;">
Â  Â  Â  Â  Â  Â  <label class="form-label-small">Picked By (Name)</label>
Â  Â  Â  Â  Â  Â  <input type="text" id="epChitPickedBy" class="form-input" placeholder="Member who picked chit">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="btn-save" onclick="saveEditPayment()">âœ“ Update Payment</button>
Â  Â  Â  Â  <button class="btn-danger-full" onclick="deletePayment()">ğŸ—‘ Delete Payment</button>
Â  Â  Â  Â  <button class="btn-cancel" onclick="closeModal('editPaymentModal')">Cancel</button>
Â  Â  </div>
</div>

<!-- CONFIRM MODAL -->
<div id="confirmModal" class="modal-overlay">
Â  Â  <div class="modal-content-custom" style="max-width:360px;">
Â  Â  Â  Â  <div style="font-size:2rem;text-align:center;margin-bottom:10px;" id="confirmIcon">âš ï¸</div>
Â  Â  Â  Â  <div class="modal-title text-center" id="confirmTitle">Are you sure?</div>
Â  Â  Â  Â  <p style="font-size:0.85rem;color:var(--text-dim);text-align:center;margin-bottom:20px;" id="confirmMsg"></p>
Â  Â  Â  Â  <button class="btn-danger-full" id="confirmOkBtn">Confirm</button>
Â  Â  Â  Â  <button class="btn-cancel" onclick="closeModal('confirmModal')">Cancel</button>
Â  Â  </div>
</div>

<!-- BOTTOM NAV -->
<div class="nav-bar">
Â  Â  <div class="nav-item active" id="navHome" onclick="switchTab('home')">ğŸ <br>Home</div>
Â  Â  <div class="nav-item" id="navGroups" onclick="switchTab('groups')">ğŸ“<br>Groups</div>
Â  Â  <div class="nav-item" id="navList" onclick="switchTab('list')">ğŸ“œ<br>List</div>
Â  Â  <div class="nav-item" id="navBackup" onclick="switchTab('backup')">ğŸ’¾<br>Backup</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig={apiKey:"AIzaSyB9_sBL83skvIaOVAE8msHwIWq8QQwhxFU",authDomain:"ak-chit-funds.firebaseapp.com",projectId:"ak-chit-funds",storageBucket:"ak-chit-funds.firebasestorage.app",messagingSenderId:"297195194526",appId:"1:297195194526:web:b71c7c09dcf8610211938f"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
let ALL_MEMBERS=[];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function getCollection(col){const s=await db.collection(col).get();return s.docs.map(d=>({id:d.id,...d.data()}));}
function fmtDate(d){if(!d)return"â€”";const[y,m,day]=d.split("-");return`${day}/${m}/${y}`;}
function fmtAmt(v){return'â‚¹'+(parseFloat(v)||0).toLocaleString('en-IN');}
function ini(n){return(n||'?').split(' ').map(x=>x[0]||'').join('').toUpperCase().slice(0,2)||'??';}
function openModal(id){document.getElementById(id).style.display='block';}
function closeModal(id){document.getElementById(id).style.display='none';}

function toggleChitPickedName(){document.getElementById('chitPickedNameDiv').style.display=document.getElementById('pChitPicked').value==='Yes'?'block':'none';}

function clearMemberSearch(){
Â  Â  document.getElementById('summarySearch').value='';
Â  Â  document.getElementById('summaryView').value='';
Â  Â  document.getElementById('summaryList').style.display='none';
Â  Â  document.getElementById('ledgerData').innerHTML='';
Â  Â  updateUI();
}

function showToast(msg,ok=true){
Â  Â  const t=document.createElement('div');
Â  Â  t.style.cssText=`position:fixed;top:20px;left:50%;transform:translateX(-50%);background:${ok?'#10b981':'#ef4444'};color:white;padding:12px 24px;border-radius:12px;font-weight:700;font-size:13px;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,.4);white-space:nowrap;`;
Â  Â  t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3000);
}

function showConfirm(icon,title,msg,onOk){
Â  Â  document.getElementById('confirmIcon').textContent=icon;
Â  Â  document.getElementById('confirmTitle').textContent=title;
Â  Â  document.getElementById('confirmMsg').textContent=msg;
Â  Â  document.getElementById('confirmOkBtn').onclick=()=>{closeModal('confirmModal');onOk();};
Â  Â  openModal('confirmModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DUE DATE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getGroupDueDates(group){
Â  Â  const start=group.startDate||group.gStart;
Â  Â  if(!start) return[];
Â  Â  const totalMonths=parseInt(group.duration||group.gDuration)||21;
Â  Â  const dueDay=parseInt(group.dueDay)||new Date(start).getDate();
Â  Â  const s=new Date(start+'T00:00:00');
Â  Â  const startYear=s.getFullYear();
Â  Â  const startMonth=s.getMonth();
Â  Â  const pad=n=>String(n).padStart(2,'0');
Â  Â  const dates=[];
Â  Â  for(let i=0;i<totalMonths;i++){
Â  Â  Â  Â  const yr=startYear+Math.floor((startMonth+i)/12);
Â  Â  Â  Â  const mo=(startMonth+i)%12;
Â  Â  Â  Â  const maxDay=new Date(yr,mo+1,0).getDate();
Â  Â  Â  Â  const day=Math.min(dueDay,maxDay);
Â  Â  Â  Â  dates.push(`${yr}-${pad(mo+1)}-${pad(day)}`);
Â  Â  }
Â  Â  return dates;
}

function getMonthSlot(dueDates, payDate){
Â  Â  if(!dueDates.length) return -1;
Â  Â  if(payDate<dueDates[0]) return 0;
Â  Â  for(let i=0;i<dueDates.length;i++){
Â  Â  Â  Â  const nextDue=dueDates[i+1]||'9999-99-99';
Â  Â  Â  Â  if(payDate>=dueDates[i]&&payDate<nextDue) return i;
Â  Â  }
Â  Â  return dueDates.length-1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MULTI-MONTH HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Returns set of already-paid month slot indices for a member in a group
async function getPaidSlots(memberId, groupId, group){
Â  Â  const allDueDates=getGroupDueDates(group);
Â  Â  const ps=await getCollection('payments');
Â  Â  const mPays=ps.filter(p=>p.memberId===memberId&&p.groupId===groupId);
Â  Â  const paidSlots=new Set();
Â  Â  mPays.forEach(p=>{
Â  Â  Â  Â  if(Array.isArray(p.monthSlots)) p.monthSlots.forEach(s=>paidSlots.add(s));
Â  Â  Â  Â  else if(p.monthSlot!==undefined&&p.monthSlot!==null) paidSlots.add(p.monthSlot);
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  // legacy: guess from date
Â  Â  Â  Â  Â  Â  const slot=getMonthSlot(allDueDates,p.date);
Â  Â  Â  Â  Â  Â  if(slot>=0) paidSlots.add(slot);
Â  Â  Â  Â  }
Â  Â  });
Â  Â  return {paidSlots, allDueDates};
}

// Get selected month slot indices from the checkbox grid
function getSelectedMonthSlots(){
Â  Â  return Array.from(document.querySelectorAll('#monthSelectorGrid input[type=checkbox]:checked')).map(cb=>parseInt(cb.value));
}

async function onNumMonthsChange(){
Â  Â  const val=document.getElementById('pNumMonths').value;
Â  Â  const preview=document.getElementById('multiMonthPreview');
Â  Â  const perMonthLabel=document.getElementById('perMonthLabel');
Â  Â  document.getElementById('totalChitRef').style.display='none';

Â  Â  if(val==='1'){
Â  Â  Â  Â  preview.style.display='none';
Â  Â  Â  Â  perMonthLabel.textContent='';
Â  Â  } else {
Â  Â  Â  Â  perMonthLabel.textContent='(per month)';
Â  Â  Â  Â  preview.style.display='block';
Â  Â  Â  Â  await buildMonthSelectorGrid();
Â  Â  }
Â  Â  calcBalance();
}

async function buildMonthSelectorGrid(){
Â  Â  const mid=document.getElementById('pMember').value;
Â  Â  const gid=document.getElementById('pGroup').value;
Â  Â  const grid=document.getElementById('monthSelectorGrid');
Â  Â  const summary=document.getElementById('selectedSummary');
Â  Â  grid.innerHTML='<div style="color:var(--text-dim);font-size:0.72rem;padding:8px;">Select member & group firstâ€¦</div>';
Â  Â  summary.style.display='none';
Â  Â  if(!mid||!gid) return;

Â  Â  const gs=await getCollection('groups');
Â  Â  const grp=gs.find(g=>g.id===gid);
Â  Â  if(!grp){grid.innerHTML='<div style="color:#f87171;font-size:0.72rem;">Group not found</div>';return;}

Â  Â  const {paidSlots,allDueDates}=await getPaidSlots(mid,gid,grp);
Â  Â  if(!allDueDates.length){grid.innerHTML='<div style="color:#f87171;font-size:0.72rem;">No due dates configured for this group</div>';return;}

Â  Â  const today=new Date().toISOString().split('T')[0];
Â  Â  grid.innerHTML=allDueDates.map((dd,i)=>{
Â  Â  Â  Â  const paid=paidSlots.has(i);
Â  Â  Â  Â  const isPast=dd<=today;
Â  Â  Â  Â  return`<label class="month-cb-item ${paid?'already-paid':''}" onclick="updateSelectedSummary()">
Â  Â  Â  Â  Â  Â  <input type="checkbox" value="${i}" ${paid?'disabled checked':''} onchange="updateSelectedSummary();calcBalance();">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:0.65rem;font-weight:700;">${fmtDate(dd)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:0.55rem;color:${paid?'#34d399':(isPast?'#f87171':'var(--text-dim)')}">${paid?'âœ… Paid':(isPast?'âš  Overdue':'Upcoming')}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </label>`;
Â  Â  }).join('');
Â  Â  updateSelectedSummary();
}

function updateSelectedSummary(){
Â  Â  const slots=getSelectedMonthSlots();
Â  Â  // Filter out already-paid (disabled) ones â€” only count newly selected
Â  Â  const newlySelected=Array.from(document.querySelectorAll('#monthSelectorGrid input[type=checkbox]:checked:not(:disabled)')).map(cb=>parseInt(cb.value));
Â  Â  const summary=document.getElementById('selectedSummary');
Â  Â  if(newlySelected.length===0){
Â  Â  Â  Â  summary.style.display='none';
Â  Â  } else {
Â  Â  Â  Â  summary.style.display='block';
Â  Â  Â  Â  summary.textContent=`ğŸ“… ${newlySelected.length} month${newlySelected.length>1?'s':''} selected for payment`;
Â  Â  }
Â  Â  calcBalance();
}

function calcBalance(){
Â  Â  const chit=parseFloat(document.getElementById('pChit').value)||0;
Â  Â  const paid=parseFloat(document.getElementById('pPaid').value)||0;
Â  Â  const isMulti=document.getElementById('pNumMonths').value==='multi';

Â  Â  if(isMulti){
Â  Â  Â  Â  const newlySelected=Array.from(document.querySelectorAll('#monthSelectorGrid input[type=checkbox]:checked:not(:disabled)')).length;
Â  Â  Â  Â  const numMonths=Math.max(1,newlySelected);
Â  Â  Â  Â  const totalChit=chit*numMonths;
Â  Â  Â  Â  const bal=Math.max(0,totalChit-paid);
Â  Â  Â  Â  if(numMonths>1){
Â  Â  Â  Â  Â  Â  document.getElementById('totalChitRef').style.display='block';
Â  Â  Â  Â  Â  Â  document.getElementById('totalChitVal').textContent=`â‚¹${totalChit.toLocaleString('en-IN')} (${numMonths} Ã— â‚¹${chit.toLocaleString('en-IN')})`;
Â  Â  Â  Â  Â  Â  document.getElementById('totalBalVal').textContent=`â‚¹${bal.toLocaleString('en-IN')}`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  document.getElementById('totalChitRef').style.display='none';
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  const bal=Math.max(0,chit-paid);
Â  Â  Â  Â  document.getElementById('totalChitRef').style.display='none';
Â  Â  }
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t){
Â  Â  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
Â  Â  document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
Â  Â  document.getElementById(t+'Tab').classList.add('active');
Â  Â  document.getElementById('nav'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');
Â  Â  updateUI();
}

async function migrateData(){
Â  Â  const ms=await getCollection('members');
Â  Â  for(let m of ms){if(m.groupId&&!m.groupIds){await db.collection('members').doc(m.id).update({groupIds:[m.groupId],groupId:firebase.firestore.FieldValue.delete()});}}
Â  Â  updateUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPDATE UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function updateUI(){
Â  Â  const m=await getCollection('members');const g=await getCollection('groups');const p=await getCollection('payments');
Â  Â  ALL_MEMBERS=m;
Â  Â  document.getElementById('memberCount').innerText=m.length;
Â  Â  document.getElementById('groupCount').innerText=g.length;
Â  Â  const today=new Date().toISOString().split('T')[0];
Â  Â  document.getElementById('todayColl').innerText=fmtAmt(p.filter(x=>x.date===today).reduce((s,x)=>s+(parseFloat(x.paid)||0),0));
Â  Â  if(document.getElementById('groupsTab').classList.contains('active'))renderGroupsTab();
Â  Â  if(document.getElementById('listTab').classList.contains('active'))renderListTab();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH AUTOCOMPLETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function filterSearch(inputId,listId,hiddenId){
Â  Â  const query=document.getElementById(inputId).value.toLowerCase();
Â  Â  const list=document.getElementById(listId);
Â  Â  list.innerHTML='';if(!query){list.style.display='none';return;}
Â  Â  const filtered=ALL_MEMBERS.filter(m=>m.name.toLowerCase().includes(query));
Â  Â  if(filtered.length>0){
Â  Â  Â  Â  list.style.display='block';
Â  Â  Â  Â  filtered.forEach(m=>{
Â  Â  Â  Â  Â  Â  const div=document.createElement('div');div.className='suggestion-item';div.innerText=m.name;
Â  Â  Â  Â  Â  Â  div.onclick=()=>{document.getElementById(inputId).value=m.name;document.getElementById(hiddenId).value=m.id;list.style.display='none';
Â  Â  Â  Â  Â  Â  Â  Â  if(hiddenId==='summaryView')loadMemberLedger();if(hiddenId==='pMember')linkGroupForPayment();};
Â  Â  Â  Â  Â  Â  list.appendChild(div);});
Â  Â  }else{list.style.display='none';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEMBER LEDGER â€” HOME TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadMemberLedger(){
Â  Â  const mid=document.getElementById('summaryView').value;if(!mid)return;
Â  Â  const ms=await getCollection('members');const gs=await getCollection('groups');const ps=await getCollection('payments');
Â  Â  const m=ms.find(x=>x.id===mid);if(!m)return;
Â  Â  const mPays=ps.filter(p=>p.memberId===mid);
Â  Â  const totalPaid=mPays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
Â  Â  const totalBal=mPays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
Â  Â  const memberGroups=gs.filter(g=>m.groupIds&&m.groupIds.includes(g.id));

Â  Â  const payTablesHtml=memberGroups.map((grp,gi)=>{
Â  Â  Â  Â  const pays=mPays.filter(p=>p.groupId===grp.id).sort((a,b)=>(a.date||'').localeCompare(b.date||''));
Â  Â  Â  Â  const allDueDates=getGroupDueDates(grp);
Â  Â  Â  Â  const tPaid=pays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
Â  Â  Â  Â  const tBal=pays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
Â  Â  Â  Â  const tableId=`ledgerTable_${gi}`;
Â  Â  Â  Â  const totalMonths=parseInt(grp.duration||grp.gDuration)||21;
Â  Â  Â  Â  let elapsed=0;
Â  Â  Â  Â  if(grp.startDate||grp.gStart){
Â  Â  Â  Â  Â  Â  const s=new Date(grp.startDate||grp.gStart);
Â  Â  Â  Â  Â  Â  const n=new Date();
Â  Â  Â  Â  Â  Â  elapsed=Math.max(0,Math.min(totalMonths,(n.getFullYear()-s.getFullYear())*12+(n.getMonth()-s.getMonth())+1));
Â  Â  Â  Â  }
Â  Â  Â  Â  const left=Math.max(0,totalMonths-elapsed);
Â  Â  Â  Â  const gStartDisplay=fmtDate(grp.startDate||grp.gStart||'');
Â  Â  Â  Â  const gDueDayOrd=grp.dueDay?`${grp.dueDay}${['st','nd','rd'][((grp.dueDay%100-11)%10)-1]||'th'}`:'â€”';

Â  Â  Â  Â  // Count multi-month payments
Â  Â  Â  Â  const multiMonthCount=pays.filter(p=>p.numMonths&&p.numMonths>1).length;

Â  Â  Â  Â  const rows=pays.map((p,idx)=>{
Â  Â  Â  Â  Â  Â  const cp=p.chitPicked==='Yes';
Â  Â  Â  Â  Â  Â  const isMulti=p.numMonths&&p.numMonths>1;
Â  Â  Â  Â  Â  Â  const months=p.monthSlots||[];
Â  Â  Â  Â  Â  Â  // Determine month label
Â  Â  Â  Â  Â  Â  let monthLabel='â€”';
Â  Â  Â  Â  Â  Â  if(isMulti && months.length>0){
Â  Â  Â  Â  Â  Â  Â  Â  const firstLabel=months[0]>=0&&allDueDates[months[0]]?fmtDate(allDueDates[months[0]]):'â€”';
Â  Â  Â  Â  Â  Â  Â  Â  const lastLabel=months[months.length-1]>=0&&allDueDates[months[months.length-1]]?fmtDate(allDueDates[months[months.length-1]]):'â€”';
Â  Â  Â  Â  Â  Â  Â  Â  monthLabel=`${firstLabel} â†’ ${lastLabel}`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const slotIdx=p.monthSlot!==undefined?p.monthSlot:getMonthSlot(allDueDates,p.date);
Â  Â  Â  Â  Â  Â  Â  Â  monthLabel=slotIdx>=0&&allDueDates[slotIdx]?fmtDate(allDueDates[slotIdx]):'â€”';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const rowClass=cp?'chit-picked':(isMulti?'multi-month-row':'');
Â  Â  Â  Â  Â  Â  return`<tr class="${rowClass}">
Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:var(--text-dim);font-weight:700;">${idx+1}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:${isMulti?'#a5b4fc':'#a5b4fc'};font-weight:700;white-space:normal;min-width:90px;font-size:0.62rem;">${monthLabel}${isMulti?`<br><span class="multi-month-badge">ğŸ“… ${p.numMonths} months</span>`:''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${fmtDate(p.date)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:#c4b5fd;">${fmtAmt(p.chit)}${isMulti?`<span style="font-size:0.55rem;color:var(--text-dim);display:block;">/mo Ã— ${p.numMonths}</span>`:''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:#34d399;font-weight:700;">${fmtAmt(p.paid)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:#f59e0b;">${fmtAmt(p.balance)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:var(--text-dim);font-size:0.6rem;">${p.paidBy||'â€”'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${cp?'<span class="chit-yes-badge">âœ… Yes</span>':'<span class="chit-no">No</span>'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><button class="btn-edit-sm" onclick="openEditPayment('${p.id}')" style="font-size:0.6rem;padding:3px 7px;">âœï¸</button></td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  return`<div style="margin-bottom:12px;">
Â  Â  Â  Â  Â  Â  <div style="background:#1c253b;border-radius:12px 12px 0 0;padding:10px 14px;border:1px solid var(--border);border-bottom:none;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:0.8rem;font-weight:800;color:#f39c12;margin-bottom:4px;">ğŸ“‚ ${grp.name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:5px;flex-wrap:wrap;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.58rem;background:rgba(99,102,241,.15);border:1px solid rgba(99,102,241,.3);border-radius:5px;padding:1px 6px;color:#a5b4fc;">ğŸ—“ Started: ${gStartDisplay}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${grp.dueDay?`<span style="font-size:0.58rem;background:rgba(243,156,18,.12);border:1px solid rgba(243,156,18,.3);border-radius:5px;padding:1px 6px;color:#f39c12;">ğŸ“… Due: ${gDueDayOrd}</span>`:''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${multiMonthCount>0?`<span style="font-size:0.58rem;background:rgba(99,102,241,.18);border:1px solid rgba(99,102,241,.35);border-radius:5px;padding:1px 6px;color:#a5b4fc;">ğŸ“¦ ${multiMonthCount} bulk payment${multiMonthCount>1?'s':''}</span>`:''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align:right;flex-shrink:0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:1rem;font-weight:800;color:#a5b4fc;">${left}<span style="font-size:0.62rem;color:var(--text-dim);">/${totalMonths}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:0.55rem;color:var(--text-dim);text-transform:uppercase;">months pending</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="background:var(--card-bg);border:1px solid var(--border);border-radius:0 0 12px 12px;overflow:hidden;">
Â  Â  Â  Â  Â  Â  Â  Â  <div onclick="toggleLedgerTable('${tableId}',this)" style="display:flex;justify-content:space-between;align-items:center;padding:9px 14px;cursor:pointer;user-select:none;border-bottom:1px solid var(--border);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.65rem;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:.6px;">Payment History (${pays.length} entries)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex;align-items:center;gap:8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.65rem;color:#34d399;">${fmtAmt(tPaid)} paid</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${tBal>0?`<span style="font-size:0.65rem;color:#f59e0b;">${fmtAmt(tBal)} bal</span>`:''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.8rem;color:var(--text-dim);transition:transform .25s;" class="ledger-chevron">â–¶</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="${tableId}" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="overflow-x:auto;"><table class="table-custom">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>#</th><th>Month(s) Covered</th><th>Pay Date</th><th>Chit/Mo</th><th>Total Paid</th><th>Balance</th><th>Mode</th><th>Chit?</th><th></th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>${rows||`<tr><td colspan="9" style="text-align:center;color:var(--text-dim);padding:16px;">No payments yet</td></tr>`}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${pays.length?`<tr style="font-weight:800;background:rgba(255,255,255,.04);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td colspan="4" style="color:var(--text-dim);">Total</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:#34d399;">${fmtAmt(tPaid)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:#f59e0b;">${fmtAmt(tBal)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td colspan="3"></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`:''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${multiMonthCount>0?`<div style="padding:8px 14px 10px;font-size:0.62rem;color:#a5b4fc;border-top:1px solid var(--border);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="margin-right:6px;">ğŸ“…</span> Purple rows = multi-month bulk payments
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`:''}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;
Â  Â  }).join('');

Â  Â  document.getElementById('ledgerData').innerHTML=`
Â  Â  Â  Â  <div style="display:flex;align-items:center;gap:14px;margin-bottom:12px;padding-top:4px;">
Â  Â  Â  Â  Â  Â  <div style="width:44px;height:44px;border-radius:12px;background:rgba(243,156,18,.15);border:2px solid rgba(243,156,18,.4);color:#f39c12;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;flex-shrink:0;">${ini(m.name)}</div>
Â  Â  Â  Â  Â  Â  <div style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:1rem;font-weight:800;">${m.name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:0.68rem;color:var(--text-dim);">${mPays.length} payments Â· ${memberGroups.length} group${memberGroups.length!==1?'s':''}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:6px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-edit-sm" onclick="openEditMember('${mid}')">âœï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-pdf" onclick="generateMemberPDF('${mid}')">ğŸ“„ PDF</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  ${payTablesHtml||'<div style="text-align:center;color:var(--text-dim);padding:20px;">No payments yet</div>'}
Â  Â  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEMBER CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openAddMember(){
Â  Â  document.getElementById('editMemberId').value='';
Â  Â  document.getElementById('mName').value='';document.getElementById('mPhone').value='';
Â  Â  document.getElementById('memberModalTitle').textContent='ğŸ‘¤ Create Member';
Â  Â  document.getElementById('deleteMemberArea').style.display='none';
Â  Â  const gs=await getCollection('groups');
Â  Â  document.getElementById('groupCheckboxes').innerHTML=gs.map(g=>`
Â  Â  Â  Â  <div class="d-flex gap-2 align-items-center p-1">
Â  Â  Â  Â  Â  Â  <input type="checkbox" class="group-cb" value="${g.id}" style="accent-color:#f39c12;width:16px;height:16px;">
Â  Â  Â  Â  Â  Â  <span style="font-size:0.9rem;">${g.name}</span>
Â  Â  Â  Â  </div>`).join('');
Â  Â  openModal('memberModal');
}

async function openEditMember(mid){
Â  Â  const ms=await getCollection('members');const m=ms.find(x=>x.id===mid);if(!m)return;
Â  Â  document.getElementById('editMemberId').value=m.id;
Â  Â  document.getElementById('mName').value=m.name||'';
Â  Â  document.getElementById('mPhone').value=m.phone||'';
Â  Â  document.getElementById('memberModalTitle').textContent='âœï¸ Edit Member';
Â  Â  document.getElementById('deleteMemberArea').style.display='block';
Â  Â  const gs=await getCollection('groups');
Â  Â  document.getElementById('groupCheckboxes').innerHTML=gs.map(g=>`
Â  Â  Â  Â  <div class="d-flex gap-2 align-items-center p-1">
Â  Â  Â  Â  Â  Â  <input type="checkbox" class="group-cb" value="${g.id}" ${m.groupIds&&m.groupIds.includes(g.id)?'checked':''} style="accent-color:#f39c12;width:16px;height:16px;">
Â  Â  Â  Â  Â  Â  <span style="font-size:0.9rem;">${g.name}</span>
Â  Â  Â  Â  </div>`).join('');
Â  Â  openModal('memberModal');
}

async function saveMember(){
Â  Â  const n=document.getElementById('mName').value.trim();
Â  Â  const p=document.getElementById('mPhone').value.trim();
Â  Â  const eid=document.getElementById('editMemberId').value;
Â  Â  const gids=Array.from(document.querySelectorAll('.group-cb:checked')).map(cb=>cb.value);
Â  Â  if(!n)return showToast('âŒ Enter member name',false);
Â  Â  if(gids.length===0)return showToast('âŒ Select at least one group',false);
Â  Â  if(eid)await db.collection('members').doc(eid).update({name:n,phone:p,groupIds:gids});
Â  Â  else await db.collection('members').add({name:n,phone:p,groupIds:gids});
Â  Â  closeModal('memberModal');showToast(`âœ… Member "${n}" saved!`);updateUI();
}

function deleteMemberFromModal(){
Â  Â  const eid=document.getElementById('editMemberId').value;if(!eid)return;
Â  Â  const name=document.getElementById('mName').value;
Â  Â  showConfirm('ğŸ—‘','Delete Member?',`This will permanently delete "${name}" and ALL their payment records.`,async()=>{
Â  Â  Â  Â  const pays=await db.collection('payments').where('memberId','==',eid).get();
Â  Â  Â  Â  const batch=db.batch();
Â  Â  Â  Â  pays.docs.forEach(d=>batch.delete(d.ref));
Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  await db.collection('members').doc(eid).delete();
Â  Â  Â  Â  closeModal('memberModal');
Â  Â  Â  Â  if(document.getElementById('summaryView').value===eid){
Â  Â  Â  Â  Â  Â  document.getElementById('summaryView').value='';
Â  Â  Â  Â  Â  Â  document.getElementById('summarySearch').value='';
Â  Â  Â  Â  Â  Â  document.getElementById('ledgerData').innerHTML='';
Â  Â  Â  Â  }
Â  Â  Â  Â  showToast('ğŸ—‘ Member & all payments deleted');updateUI();
Â  Â  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GROUP CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddGroup(){
Â  Â  document.getElementById('editGroupId').value='';
Â  Â  document.getElementById('gName').value='';
Â  Â  document.getElementById('gDuration').value='';
Â  Â  document.getElementById('gDueDay').value='';
Â  Â  document.getElementById('gStart').value='';
Â  Â  document.getElementById('groupModalTitle').textContent='ğŸ¦ New Group';
Â  Â  document.getElementById('deleteGroupArea').style.display='none';
Â  Â  openModal('groupModal');
}

async function openEditGroup(gid){
Â  Â  const gs=await getCollection('groups');const g=gs.find(x=>x.id===gid);if(!g)return;
Â  Â  document.getElementById('editGroupId').value=g.id;
Â  Â  document.getElementById('gName').value=g.name||'';
Â  Â  document.getElementById('gDuration').value=g.duration||g.gDuration||'';
Â  Â  document.getElementById('gDueDay').value=g.dueDay||'';
Â  Â  document.getElementById('gStart').value=g.startDate||g.gStart||'';
Â  Â  document.getElementById('groupModalTitle').textContent='âœï¸ Edit Group';
Â  Â  document.getElementById('deleteGroupArea').style.display='block';
Â  Â  openModal('groupModal');
}

async function saveGroup(){
Â  Â  const name=document.getElementById('gName').value.trim();
Â  Â  const duration=document.getElementById('gDuration').value;
Â  Â  const dueDay=parseInt(document.getElementById('gDueDay').value)||null;
Â  Â  const startDate=document.getElementById('gStart').value;
Â  Â  const eid=document.getElementById('editGroupId').value;
Â  Â  if(!name)return showToast('âŒ Enter group name',false);
Â  Â  if(dueDay&&(dueDay<1||dueDay>31))return showToast('âŒ Due Day must be 1â€“31',false);
Â  Â  const data={name,duration,startDate};
Â  Â  if(dueDay) data.dueDay=dueDay;
Â  Â  if(eid)await db.collection('groups').doc(eid).update(data);
Â  Â  else await db.collection('groups').add(data);
Â  Â  closeModal('groupModal');showToast(`âœ… Group "${name}" saved!`);updateUI();
}

function deleteGroupFromModal(){
Â  Â  const eid=document.getElementById('editGroupId').value;if(!eid)return;
Â  Â  const name=document.getElementById('gName').value;
Â  Â  showConfirm('ğŸ—‘','Delete Group?',`This will permanently delete "${name}". Member assignments and payments will remain.`,async()=>{
Â  Â  Â  Â  await db.collection('groups').doc(eid).delete();
Â  Â  Â  Â  closeModal('groupModal');showToast('ğŸ—‘ Group deleted');updateUI();
Â  Â  });
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAYMENT â€” MULTI-MONTH SUPPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetPaymentForm(){
Â  Â  document.getElementById('pDate').value=new Date().toISOString().split('T')[0];
Â  Â  document.getElementById('pMemberSearch').value='';
Â  Â  document.getElementById('pMember').value='';
Â  Â  document.getElementById('pMemberList').style.display='none';
Â  Â  document.getElementById('pGroup').innerHTML='<option value="">-- Select Member First --</option>';
Â  Â  document.getElementById('pNumMonths').value='1';
Â  Â  document.getElementById('pChit').value='';
Â  Â  document.getElementById('pPaid').value='';
Â  Â  document.getElementById('pPaidBy').value='';
Â  Â  document.getElementById('pChitPicked').value='No';
Â  Â  document.getElementById('pChitPickedBy').value='';
Â  Â  document.getElementById('chitPickedNameDiv').style.display='none';
Â  Â  document.getElementById('multiMonthPreview').style.display='none';
Â  Â  document.getElementById('totalChitRef').style.display='none';
Â  Â  document.getElementById('perMonthLabel').textContent='';
Â  Â  document.getElementById('monthSelectorGrid').innerHTML='';
Â  Â  document.getElementById('selectedSummary').style.display='none';
Â  Â  const sel=document.getElementById('pChitPicked');
Â  Â  [...sel.options].forEach(o=>o.disabled=false);
Â  Â  sel.title='';
}

function openPaymentModal(){
Â  Â  resetPaymentForm();
Â  Â  openModal('paymentModal');
}

async function linkGroupForPayment(){
Â  Â  const mid=document.getElementById('pMember').value;
Â  Â  const ms=await getCollection('members');const m=ms.find(x=>x.id===mid);if(!m)return;
Â  Â  const gs=await getCollection('groups');
Â  Â  document.getElementById('pGroup').innerHTML=gs.filter(g=>m.groupIds&&m.groupIds.includes(g.id)).map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
Â  Â  await onGroupChange();
}

async function onGroupChange(){
Â  Â  document.getElementById('pChit').value='';
Â  Â  document.getElementById('pPaid').value='';
Â  Â  document.getElementById('totalChitRef').style.display='none';
Â  Â  // Check if member already picked chit
Â  Â  const mid=document.getElementById('pMember').value;
Â  Â  const gid=document.getElementById('pGroup').value;
Â  Â  if(mid&&gid){
Â  Â  Â  Â  const ps=await getCollection('payments');
Â  Â  Â  Â  const alreadyPicked=ps.some(p=>p.memberId===mid&&p.groupId===gid&&p.chitPicked==='Yes');
Â  Â  Â  Â  const sel=document.getElementById('pChitPicked');
Â  Â  Â  Â  if(alreadyPicked){
Â  Â  Â  Â  Â  Â  sel.value='No';
Â  Â  Â  Â  Â  Â  [...sel.options].forEach(o=>{if(o.value==='Yes')o.disabled=true;});
Â  Â  Â  Â  Â  Â  sel.title='This member already picked the chit in this group';
Â  Â  Â  Â  Â  Â  document.getElementById('chitPickedNameDiv').style.display='none';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  [...sel.options].forEach(o=>o.disabled=false);
Â  Â  Â  Â  Â  Â  sel.title='';
Â  Â  Â  Â  }
Â  Â  }
Â  Â  // Refresh month picker grid if multi-month mode is active
Â  Â  if(document.getElementById('pNumMonths').value==='multi'){
Â  Â  Â  Â  await buildMonthSelectorGrid();
Â  Â  }
}

async function savePayment(){
Â  Â  const mid=document.getElementById('pMember').value;
Â  Â  const gid=document.getElementById('pGroup').value;
Â  Â  const date=document.getElementById('pDate').value;
Â  Â  const chitPerMonth=parseFloat(document.getElementById('pChit').value)||0;
Â  Â  const paid=parseFloat(document.getElementById('pPaid').value)||0;
Â  Â  const paidBy=document.getElementById('pPaidBy').value;
Â  Â  const chitPicked=document.getElementById('pChitPicked').value;
Â  Â  const chitPickedBy=document.getElementById('pChitPickedBy').value.trim();
Â  Â  const isMulti=document.getElementById('pNumMonths').value==='multi';

Â  Â  if(!mid)return showToast('âŒ Select a member',false);
Â  Â  if(!gid)return showToast('âŒ Select a group',false);
Â  Â  if(!date)return showToast('âŒ Enter date',false);
Â  Â  if(!paid)return showToast('âŒ Enter amount paid',false);

Â  Â  if(chitPicked==='Yes'){
Â  Â  Â  Â  const ps=await getCollection('payments');
Â  Â  Â  Â  const alreadyPicked=ps.some(p=>p.memberId===mid&&p.groupId===gid&&p.chitPicked==='Yes');
Â  Â  Â  Â  if(alreadyPicked)return showToast('âŒ This member already picked the chit',false);
Â  Â  }

Â  Â  if(isMulti){
Â  Â  Â  Â  // Get ONLY the newly-selected (non-disabled) checkboxes
Â  Â  Â  Â  const monthSlots=Array.from(document.querySelectorAll('#monthSelectorGrid input[type=checkbox]:checked:not(:disabled)')).map(cb=>parseInt(cb.value));
Â  Â  Â  Â  if(monthSlots.length===0) return showToast('âŒ Select at least one month in the picker',false);
Â  Â  Â  Â  const numMonths=monthSlots.length;
Â  Â  Â  Â  const totalChit=chitPerMonth*numMonths;
Â  Â  Â  Â  const balance=Math.max(0,totalChit-paid);
Â  Â  Â  Â  await db.collection('payments').add({
Â  Â  Â  Â  Â  Â  memberId:mid, groupId:gid, date,
Â  Â  Â  Â  Â  Â  chit:chitPerMonth, paid, balance, paidBy, chitPicked, chitPickedBy,
Â  Â  Â  Â  Â  Â  numMonths,
Â  Â  Â  Â  Â  Â  monthSlots,
Â  Â  Â  Â  Â  Â  monthSlot:monthSlots[0],Â  Â // first slot for sorting
Â  Â  Â  Â  Â  Â  paidPerMonth:paid/numMonths,
Â  Â  Â  Â  Â  Â  balPerMonth:balance/numMonths
Â  Â  Â  Â  });
Â  Â  Â  Â  showToast(`âœ… ${numMonths}-month payment saved!`);
Â  Â  } else {
Â  Â  Â  Â  // Single month â€” determine slot from date
Â  Â  Â  Â  const gs=await getCollection('groups');
Â  Â  Â  Â  const grp=gs.find(g=>g.id===gid);
Â  Â  Â  Â  const dueDates=grp?getGroupDueDates(grp):[];
Â  Â  Â  Â  const slotIdx=getMonthSlot(dueDates,date);
Â  Â  Â  Â  const balance=Math.max(0,chitPerMonth-paid);
Â  Â  Â  Â  await db.collection('payments').add({
Â  Â  Â  Â  Â  Â  memberId:mid, groupId:gid, date,
Â  Â  Â  Â  Â  Â  chit:chitPerMonth, paid, balance, paidBy, chitPicked, chitPickedBy,
Â  Â  Â  Â  Â  Â  numMonths:1,
Â  Â  Â  Â  Â  Â  monthSlot:slotIdx>=0?slotIdx:null,
Â  Â  Â  Â  Â  Â  monthSlots:slotIdx>=0?[slotIdx]:[]
Â  Â  Â  Â  });
Â  Â  Â  Â  showToast('âœ… Payment saved!');
Â  Â  }

Â  Â  closeModal('paymentModal');
Â  Â  updateUI();
Â  Â  if(document.getElementById('summaryView').value===mid) loadMemberLedger();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDIT / DELETE EXISTING PAYMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openEditPayment(pid){
Â  Â  const ps=await getCollection('payments');
Â  Â  const p=ps.find(x=>x.id===pid);if(!p)return;
Â  Â  document.getElementById('epId').value=pid;
Â  Â  document.getElementById('epDate').value=p.date||'';
Â  Â  document.getElementById('epChit').value=p.chit||'';
Â  Â  document.getElementById('epPaid').value=p.paid||'';
Â  Â  document.getElementById('epBal').value=p.balance||'';
Â  Â  document.getElementById('epPaidBy').value=p.paidBy||'';
Â  Â  document.getElementById('epChitPicked').value=p.chitPicked||'No';
Â  Â  document.getElementById('epChitPickedBy').value=p.chitPickedBy||'';
Â  Â  document.getElementById('epChitPickedNameDiv').style.display=p.chitPicked==='Yes'?'block':'none';

Â  Â  // Show multi-month info if applicable
Â  Â  const infoBox=document.getElementById('epMultiMonthInfo');
Â  Â  const detailEl=document.getElementById('epMultiMonthDetail');
Â  Â  if(p.numMonths&&p.numMonths>1){
Â  Â  Â  Â  infoBox.style.display='block';

Â  Â  Â  Â  // Get group for due dates
Â  Â  Â  Â  const gs=await getCollection('groups');
Â  Â  Â  Â  const grp=gs.find(g=>g.id===p.groupId);
Â  Â  Â  Â  let slotLabels='';
Â  Â  Â  Â  if(grp&&p.monthSlots){
Â  Â  Â  Â  Â  Â  const dueDates=getGroupDueDates(grp);
Â  Â  Â  Â  Â  Â  slotLabels=p.monthSlots.map((s,i)=>dueDates[s]?fmtDate(dueDates[s]):`Month ${s+1}`).join(' â†’ ');
Â  Â  Â  Â  }
Â  Â  Â  Â  detailEl.innerHTML=`Covers <strong>${p.numMonths} months</strong>${slotLabels?': '+slotLabels:''}`;
Â  Â  } else {
Â  Â  Â  Â  infoBox.style.display='none';
Â  Â  }

Â  Â  openModal('editPaymentModal');
}

function epCalcBalance(){
Â  Â  const chit=parseFloat(document.getElementById('epChit').value)||0;
Â  Â  const paid=parseFloat(document.getElementById('epPaid').value)||0;
Â  Â  document.getElementById('epBal').value=Math.max(0,chit-paid);
}
function epTogglePickedName(){
Â  Â  document.getElementById('epChitPickedNameDiv').style.display=document.getElementById('epChitPicked').value==='Yes'?'block':'none';
}

async function saveEditPayment(){
Â  Â  const pid=document.getElementById('epId').value;if(!pid)return;
Â  Â  const date=document.getElementById('epDate').value;
Â  Â  const chit=parseFloat(document.getElementById('epChit').value)||0;
Â  Â  const paid=parseFloat(document.getElementById('epPaid').value)||0;
Â  Â  const balance=Math.max(0,chit-paid);
Â  Â  const paidBy=document.getElementById('epPaidBy').value;
Â  Â  const chitPicked=document.getElementById('epChitPicked').value;
Â  Â  const chitPickedBy=document.getElementById('epChitPickedBy').value.trim();
Â  Â  if(!date)return showToast('âŒ Enter date',false);
Â  Â  if(!paid)return showToast('âŒ Enter amount paid',false);
Â  Â  await db.collection('payments').doc(pid).update({date,chit,paid,balance,paidBy,chitPicked,chitPickedBy});
Â  Â  closeModal('editPaymentModal');showToast('âœ… Payment updated!');updateUI();
Â  Â  const mid=document.getElementById('summaryView').value;
Â  Â  if(mid)loadMemberLedger();
}

async function deletePayment(){
Â  Â  const pid=document.getElementById('epId').value;if(!pid)return;
Â  Â  showConfirm('ğŸ—‘','Delete Payment?','This will permanently delete this payment record.',async()=>{
Â  Â  Â  Â  await db.collection('payments').doc(pid).delete();
Â  Â  Â  Â  closeModal('editPaymentModal');showToast('ğŸ—‘ Payment deleted');updateUI();
Â  Â  Â  Â  const mid=document.getElementById('summaryView').value;
Â  Â  Â  Â  if(mid)loadMemberLedger();
Â  Â  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GROUPS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderGroupsTab(){
Â  Â  const gs=await getCollection('groups');const ms=await getCollection('members');const ps=await getCollection('payments');
Â  Â  if(!gs.length){document.getElementById('groupListArea').innerHTML='<div style="text-align:center;color:var(--text-dim);padding:40px;">No groups yet.</div>';return;}
Â  Â  document.getElementById('groupListArea').innerHTML=gs.map((g,gIdx)=>{
Â  Â  Â  Â  const gMs=ms.filter(m=>m.groupIds&&m.groupIds.includes(g.id));
Â  Â  Â  Â  const gPays=ps.filter(p=>p.groupId===g.id);
Â  Â  Â  Â  const tPaid=gPays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
Â  Â  Â  Â  const tBal=gPays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
Â  Â  Â  Â  const picked=gPays.filter(p=>p.chitPicked==='Yes').length;
Â  Â  Â  Â  const totalMonths=parseInt(g.duration||g.gDuration)||21;
Â  Â  Â  Â  let elapsed=0;
Â  Â  Â  Â  if(g.startDate||g.gStart){const _s=new Date(g.startDate||g.gStart),_n=new Date();elapsed=Math.max(0,Math.min(totalMonths,(_n.getFullYear()-_s.getFullYear())*12+(_n.getMonth()-_s.getMonth())+1));}
Â  Â  Â  Â  const left=Math.max(0,totalMonths-elapsed);const pct=Math.min(100,Math.round(elapsed/totalMonths*100));

Â  Â  Â  Â  const memberRows=gMs.map((m,i)=>{
Â  Â  Â  Â  Â  Â  const mp=ps.filter(p=>p.memberId===m.id&&p.groupId===g.id);
Â  Â  Â  Â  Â  Â  const paid=mp.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
Â  Â  Â  Â  Â  Â  const bal=mp.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
Â  Â  Â  Â  Â  Â  const mpicked=mp.filter(p=>p.chitPicked==='Yes').length;
Â  Â  Â  Â  Â  Â  // Count months actually covered (accounting for multi-month payments)
Â  Â  Â  Â  Â  Â  const monthsCovered=mp.reduce((s,p)=>s+(p.numMonths||1),0);
Â  Â  Â  Â  Â  Â  return`<tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${i+1}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><strong>${m.name}</strong><br><span style="font-size:0.6rem;color:var(--text-dim);">${m.phone||''}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:#34d399;">${fmtAmt(paid)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:#f59e0b;">${fmtAmt(bal)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:#a5b4fc;font-size:0.65rem;">${monthsCovered}/${totalMonths}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${mpicked>0?`<span class="chit-yes-badge">âœ… ${mpicked}x</span>`:'<span class="chit-no">â€”</span>'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><button class="btn-edit-sm" onclick="openEditMember('${m.id}')">âœï¸</button></td>
Â  Â  Â  Â  Â  Â  </tr>`;}).join('');

Â  Â  Â  Â  const gStartDisp=fmtDate(g.startDate||g.gStart||'');
Â  Â  Â  Â  const gDueDayDisp=g.dueDay?`${g.dueDay}${['st','nd','rd'][((g.dueDay%100-11)%10)-1]||'th'} of month`:'â€”';
Â  Â  Â  Â  const bodyId=`grpBody_${gIdx}`;
Â  Â  Â  Â  return`<div class="group-card">
Â  Â  Â  Â  Â  Â  <div class="group-card-header" onclick="toggleGroupCard('${bodyId}',this)">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:flex-start;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:1rem;font-weight:800;color:#f39c12;">ğŸ“‚ ${g.name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:0.68rem;color:var(--text-dim);">${gMs.length} members Â· ${gPays.length} payment entries</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:6px;margin-top:5px;flex-wrap:wrap;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.62rem;background:rgba(99,102,241,.15);border:1px solid rgba(99,102,241,.3);border-radius:6px;padding:2px 7px;color:#a5b4fc;">ğŸ—“ Started: ${gStartDisp}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${g.dueDay?`<span style="font-size:0.62rem;background:rgba(243,156,18,.12);border:1px solid rgba(243,156,18,.3);border-radius:6px;padding:2px 7px;color:#f39c12;">ğŸ“… Due: ${gDueDayDisp}</span>`:''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:6px;align-items:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="generateGroupPDF('${g.id}');event.stopPropagation();" class="btn-pdf" style="padding:5px 10px;font-size:0.7rem;">ğŸ“„ PDF</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openEditGroup('${g.id}');event.stopPropagation();" class="btn-edit-sm">âœï¸ Edit</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="chevron-icon open">â–¼</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="row g-2 mt-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-3"><div class="mini-stat" style="border-top:2px solid #34d399;"><div class="mini-stat-lbl">Collected</div><div class="mini-stat-val" style="color:#34d399;">${fmtAmt(tPaid)}</div></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-3"><div class="mini-stat" style="border-top:2px solid #f59e0b;"><div class="mini-stat-lbl">Balance</div><div class="mini-stat-val" style="color:#f59e0b;">${fmtAmt(tBal)}</div></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-3"><div class="mini-stat" style="border-top:2px solid #a5b4fc;"><div class="mini-stat-lbl">Pending</div><div class="mini-stat-val" style="color:#a5b4fc;">${left}/${totalMonths}</div></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-3"><div class="mini-stat" style="border-top:2px solid #34d399;"><div class="mini-stat-lbl">Picked</div><div class="mini-stat-val" style="color:#34d399;">${picked}</div></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="prog-bar-outer mt-2"><div class="prog-bar-inner" style="width:${pct}%"></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="prog-label" style="margin-top:3px;"><span>Month ${elapsed}/${totalMonths}</span><span>${left}/${totalMonths} months pending</span></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="group-body" id="${bodyId}" style="max-height:2000px;opacity:1;margin-top:12px;">
Â  Â  Â  Â  Â  Â  Â  Â  ${gMs.length?`<div style="overflow-x:auto;"><table class="table-custom">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>#</th><th>Member</th><th>Paid</th><th>Balance</th><th>Months</th><th>Chit?</th><th></th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>${memberRows}</tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table></div>`:'<div style="text-align:center;color:var(--text-dim);font-size:0.8rem;padding:10px;">No members yet</div>'}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;
Â  Â  }).join('');
}

function toggleGroupCard(bodyId, header){
Â  Â  const body=document.getElementById(bodyId);
Â  Â  const chevron=header.querySelector('.chevron-icon');
Â  Â  if(!body) return;
Â  Â  const isOpen=body.style.maxHeight!=='0px'&&!body.classList.contains('collapsed');
Â  Â  if(isOpen){
Â  Â  Â  Â  body.style.maxHeight='0px';body.style.opacity='0';body.style.marginTop='0';
Â  Â  Â  Â  if(chevron){chevron.classList.remove('open');chevron.classList.add('closed');}
Â  Â  } else {
Â  Â  Â  Â  body.style.maxHeight='2000px';body.style.opacity='1';body.style.marginTop='12px';
Â  Â  Â  Â  if(chevron){chevron.classList.remove('closed');chevron.classList.add('open');}
Â  Â  }
}

function toggleLedgerTable(id, header){
Â  Â  const el=document.getElementById(id);
Â  Â  if(!el)return;
Â  Â  const chevron=header.querySelector('.ledger-chevron');
Â  Â  const isOpen=el.style.display!=='none';
Â  Â  el.style.display=isOpen?'none':'block';
Â  Â  if(chevron)chevron.style.transform=isOpen?'rotate(0deg)':'rotate(90deg)';
}

async function renderListTab(){
Â  Â  const gs=await getCollection('groups');const ms=await getCollection('members');
Â  Â  document.getElementById('simpleListArea').innerHTML=gs.map((g,gi)=>{
Â  Â  Â  Â  const gMs=ms.filter(m=>m.groupIds&&m.groupIds.includes(g.id));
Â  Â  Â  Â  const listId=`listGroup_${gi}`;
Â  Â  Â  Â  return`<div class="list-group-header" onclick="toggleListGroup('${listId}',this)">
Â  Â  Â  Â  Â  Â  <span>${g.name}</span>
Â  Â  Â  Â  Â  Â  <span style="display:flex;align-items:center;gap:8px;">
Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.72rem;color:var(--text-dim);">${gMs.length} members</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="list-chevron" style="font-size:0.8rem;color:var(--text-dim);transition:transform .25s;">â–¼</span>
Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="${listId}" style="display:block;">
Â  Â  Â  Â  Â  Â  ${gMs.map((m,i)=>`<div style="padding:10px 20px;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;align-items:center;gap:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <span style="width:28px;color:var(--text-dim);font-size:0.72rem;">${i+1}.</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span style="flex:1;font-size:0.9rem;">${m.name}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.72rem;color:var(--text-dim);">${m.phone||''}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-edit-sm" onclick="openEditMember('${m.id}')">âœï¸</button>
Â  Â  Â  Â  Â  Â  </div>`).join('')}
Â  Â  Â  Â  </div>`;
Â  Â  }).join('')||'<div style="text-align:center;color:var(--text-dim);padding:40px;">No groups yet.</div>';
}

function toggleListGroup(id,header){
Â  Â  const el=document.getElementById(id);
Â  Â  const ch=header.querySelector('.list-chevron');
Â  Â  const open=el.style.display!=='none';
Â  Â  el.style.display=open?'none':'block';
Â  Â  ch.style.transform=open?'rotate(-90deg)':'rotate(0deg)';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKUP / RESTORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function exportFullBackup(){
Â  Â  const d={m:await getCollection('members'),g:await getCollection('groups'),p:await getCollection('payments')};
Â  Â  const a=document.createElement('a');
Â  Â  a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json'}));
Â  Â  a.download=`AK_Chit_Backup_${new Date().toISOString().split('T')[0]}.json`;
Â  Â  a.click();showToast('âœ… Backup downloaded!');
}

function confirmRestore(){
Â  Â  const file=document.getElementById('restoreFile').files[0];
Â  Â  if(!file)return showToast('âŒ Select a backup file first',false);
Â  Â  showConfirm('ğŸ”„','Restore All Data?','This will overwrite ALL existing data.',()=>executeRestore());
}

async function executeRestore(){
Â  Â  const file=document.getElementById('restoreFile').files[0];if(!file)return;
Â  Â  showToast('â³ Restoringâ€¦',true);
Â  Â  const reader=new FileReader();
Â  Â  reader.onload=async(e)=>{
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  const data=JSON.parse(e.target.result);
Â  Â  Â  Â  Â  Â  const delCol=async(col)=>{const s=await db.collection(col).get();const batch=db.batch();s.docs.forEach(d=>batch.delete(d.ref));if(s.docs.length)await batch.commit();};
Â  Â  Â  Â  Â  Â  await delCol('members');await delCol('groups');await delCol('payments');
Â  Â  Â  Â  Â  Â  let count=0;
Â  Â  Â  Â  Â  Â  if(data.m)for(let x of data.m){const {id,...rest}=x;await db.collection('members').doc(id).set(rest);count++;}
Â  Â  Â  Â  Â  Â  if(data.g)for(let x of data.g){const {id,...rest}=x;await db.collection('groups').doc(id).set(rest);count++;}
Â  Â  Â  Â  Â  Â  if(data.p)for(let x of data.p){const {id,...rest}=x;await db.collection('payments').doc(id).set(rest);count++;}
Â  Â  Â  Â  Â  Â  showToast(`âœ… Restored ${count} records!`);updateUI();
Â  Â  Â  Â  }catch(err){console.error(err);showToast('âŒ Invalid backup file',false);}
Â  Â  };
Â  Â  reader.readAsText(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF RENDER HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPDF(filename){
Â  Â  return new Promise((resolve)=>{
Â  Â  Â  Â  const wrapper=document.getElementById('pdf-template');
Â  Â  Â  Â  const content=document.getElementById('pdfContent');
Â  Â  Â  Â  wrapper.classList.add('rendering');
Â  Â  Â  Â  wrapper.style.visibility='visible';

Â  Â  Â  Â  const opt={
Â  Â  Â  Â  Â  Â  margin:[8,8,8,8],
Â  Â  Â  Â  Â  Â  filename,
Â  Â  Â  Â  Â  Â  image:{type:'jpeg',quality:0.97},
Â  Â  Â  Â  Â  Â  html2canvas:{scale:2,useCORS:true,logging:false,allowTaint:false,backgroundColor:'#ffffff'},
Â  Â  Â  Â  Â  Â  jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},
Â  Â  Â  Â  Â  Â  pagebreak:{mode:['avoid-all','css','legacy']}
Â  Â  Â  Â  };

Â  Â  Â  Â  setTimeout(()=>{
Â  Â  Â  Â  Â  Â  html2pdf().set(opt).from(content).save().then(()=>{
Â  Â  Â  Â  Â  Â  Â  Â  wrapper.classList.remove('rendering');
Â  Â  Â  Â  Â  Â  Â  Â  wrapper.style.visibility='hidden';
Â  Â  Â  Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  Â  Â  }).catch(err=>{
Â  Â  Â  Â  Â  Â  Â  Â  console.error('PDF error:',err);
Â  Â  Â  Â  Â  Â  Â  Â  wrapper.classList.remove('rendering');
Â  Â  Â  Â  Â  Â  Â  Â  wrapper.style.visibility='hidden';
Â  Â  Â  Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  },400);
Â  Â  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF â€” MEMBER STATEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateMemberPDF(mid){
Â  Â  showToast('â³ Generating PDFâ€¦',true);
Â  Â  const ms=await getCollection('members');const gs=await getCollection('groups');const ps=await getCollection('payments');
Â  Â  const m=ms.find(x=>x.id===mid);if(!m)return;
Â  Â  const mPays=ps.filter(p=>p.memberId===mid);
Â  Â  const totalPaid=mPays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
Â  Â  const totalBal=mPays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
Â  Â  const chitsPicked=mPays.filter(p=>p.chitPicked==='Yes').length;
Â  Â  const memberGroups=gs.filter(g=>m.groupIds&&m.groupIds.includes(g.id));
Â  Â  const today=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});

Â  Â  const grouped={};
Â  Â  mPays.forEach(p=>{const gid=p.groupId||'unk';if(!grouped[gid])grouped[gid]=[];grouped[gid].push(p);});

Â  Â  const groupSections=memberGroups.map(g=>{
Â  Â  Â  Â  const pays=(grouped[g.id]||[]).sort((a,b)=>(a.date||'').localeCompare(b.date||''));
Â  Â  Â  Â  const totalMonths=parseInt(g.duration||g.gDuration)||21;
Â  Â  Â  Â  let elapsed=0;
Â  Â  Â  Â  if(g.startDate||g.gStart){const _s=new Date(g.startDate||g.gStart),_n=new Date();elapsed=Math.max(0,Math.min(totalMonths,(_n.getFullYear()-_s.getFullYear())*12+(_n.getMonth()-_s.getMonth())+1));}
Â  Â  Â  Â  const left=Math.max(0,totalMonths-elapsed);
Â  Â  Â  Â  const pct=Math.min(100,Math.round(elapsed/totalMonths*100));
Â  Â  Â  Â  const gPaid=pays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
Â  Â  Â  Â  const gBal=pays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
Â  Â  Â  Â  const allDueDates=getGroupDueDates(g);
Â  Â  Â  Â  const gStartDisp=fmtDate(g.startDate||g.gStart||'');
Â  Â  Â  Â  const gDueDayDisp=g.dueDay?`${g.dueDay}${['st','nd','rd'][((g.dueDay%100-11)%10)-1]||'th'} of month`:'â€”';
Â  Â  Â  Â  const totalMonthsCovered=pays.reduce((s,p)=>s+(p.numMonths||1),0);

Â  Â  Â  Â  const rows=pays.map((p,idx)=>{
Â  Â  Â  Â  Â  Â  const cp=p.chitPicked==='Yes';
Â  Â  Â  Â  Â  Â  const isMulti=p.numMonths&&p.numMonths>1;
Â  Â  Â  Â  Â  Â  let monthLabel='â€”';
Â  Â  Â  Â  Â  Â  if(isMulti&&p.monthSlots&&p.monthSlots.length>0){
Â  Â  Â  Â  Â  Â  Â  Â  const f=allDueDates[p.monthSlots[0]]?fmtDate(allDueDates[p.monthSlots[0]]):'â€”';
Â  Â  Â  Â  Â  Â  Â  Â  const l=allDueDates[p.monthSlots[p.monthSlots.length-1]]?fmtDate(allDueDates[p.monthSlots[p.monthSlots.length-1]]):'â€”';
Â  Â  Â  Â  Â  Â  Â  Â  monthLabel=`${f} â†’ ${l}`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const slotIdx=p.monthSlot!==undefined?p.monthSlot:getMonthSlot(allDueDates,p.date);
Â  Â  Â  Â  Â  Â  Â  Â  monthLabel=slotIdx>=0&&allDueDates[slotIdx]?fmtDate(allDueDates[slotIdx]):'â€”';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return`<tr class="${cp?'pdf-chit-row':(isMulti?'pdf-multi-row':'')}">
Â  Â  Â  Â  Â  Â  Â  Â  <td>${idx+1}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:700;">${monthLabel}${isMulti?`<br><span class="pdf-multi-badge">ğŸ“… ${p.numMonths} months</span>`:''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${fmtDate(p.date)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>â‚¹${(parseFloat(p.chit)||0).toLocaleString('en-IN')}${isMulti?` Ã— ${p.numMonths}`:''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:#065f46;font-weight:700;">â‚¹${(parseFloat(p.paid)||0).toLocaleString('en-IN')}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:#92400e;font-weight:700;">â‚¹${(parseFloat(p.balance)||0).toLocaleString('en-IN')}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${p.paidBy||'â€”'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${cp?`<span class="pdf-chit-badge">âœ… PICKED</span>`:'â€”'}</td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  return`<div style="margin-bottom:22px;">
Â  Â  Â  Â  Â  Â  <div class="pdf-group-title">ğŸ“‚ ${g.name}</div>
Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:12px;font-size:10px;color:#888;margin-bottom:4px;flex-wrap:wrap;">
Â  Â  Â  Â  Â  Â  Â  Â  <span>ğŸ—“ Start: <strong>${gStartDisp}</strong></span>
Â  Â  Â  Â  Â  Â  Â  Â  <span>ğŸ“… Due: <strong>${gDueDayDisp}</strong></span>
Â  Â  Â  Â  Â  Â  Â  Â  <span>Month ${elapsed}/${totalMonths} Â· <strong>${left} pending</strong></span>
Â  Â  Â  Â  Â  Â  Â  Â  <span>Months covered: <strong>${totalMonthsCovered}/${totalMonths}</strong></span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="pdf-progress-outer"><div class="pdf-progress-inner" style="width:${pct}%"></div></div>
Â  Â  Â  Â  Â  Â  <div style="font-size:10px;color:#888;text-align:right;margin-bottom:10px;">Paid: â‚¹${gPaid.toLocaleString('en-IN')} Â· Balance: â‚¹${gBal.toLocaleString('en-IN')}</div>
Â  Â  Â  Â  Â  Â  ${pays.length?`<table class="pdf-table">
Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>#</th><th>Month(s) Covered</th><th>Pay Date</th><th>Chit/Mo</th><th>Total Paid</th><th>Balance</th><th>Mode</th><th>Chit?</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody>${rows}
Â  Â  Â  Â  Â  Â  Â  Â  <tr class="pdf-total-row"><td colspan="4"><strong>Total</strong></td><td><strong>â‚¹${gPaid.toLocaleString('en-IN')}</strong></td><td><strong>â‚¹${gBal.toLocaleString('en-IN')}</strong></td><td colspan="2"></td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  </tbody></table>`:'<p style="color:#888;font-size:11px;">No payments yet.</p>'}
Â  Â  Â  Â  </div>`;
Â  Â  }).join('');

Â  Â  document.getElementById('pdfContent').innerHTML=`
Â  Â  Â  Â  <div class="pdf-page">
Â  Â  Â  Â  <div class="pdf-header">
Â  Â  Â  Â  Â  Â  <div><div class="pdf-brand">ğŸ† AK CHIT FUNDS</div><div class="pdf-brand-sub">Chit Fund Management Â· Admin Report</div></div>
Â  Â  Â  Â  Â  Â  <div><div class="pdf-right-title">MEMBER STATEMENT</div><div class="pdf-right-sub">Generated: ${today}</div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="pdf-member-box">
Â  Â  Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-member-name">${m.name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-member-sub">ğŸ“ ${m.phone||'No phone'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-member-sub">ğŸ“‚ Groups: ${memberGroups.map(g=>g.name).join(', ')||'â€”'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stats-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-box"><div class="pdf-stat-val" style="color:#065f46;">â‚¹${totalPaid.toLocaleString('en-IN')}</div><div class="pdf-stat-lbl">Total Paid</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-box"><div class="pdf-stat-val" style="color:#92400e;">â‚¹${totalBal.toLocaleString('en-IN')}</div><div class="pdf-stat-lbl">Balance</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-box"><div class="pdf-stat-val">${mPays.length}</div><div class="pdf-stat-lbl">Payments</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-box"><div class="pdf-stat-val" style="color:#065f46;">${chitsPicked}</div><div class="pdf-stat-lbl">Chits Picked</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="pdf-section-title">Payment History â€” Group Wise</div>
Â  Â  Â  Â  ${groupSections||'<p style="color:#888;">No payments recorded.</p>'}
Â  Â  Â  Â  <div class="pdf-footer"><span>AK Chit Funds Â· Admin Portal</span><span>Member: ${m.name} Â· ${today}</span><span>CONFIDENTIAL</span></div>
Â  Â  Â  Â  </div>`;

Â  Â  await renderPDF(`AKChitFunds_${m.name.replace(/\s+/g,'_')}_Statement.pdf`);
Â  Â  showToast('âœ… PDF Downloaded!',true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF â€” GROUP REPORT (FIXED)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateGroupPDF(gid){
Â  Â  showToast('â³ Generating Group PDFâ€¦',true);
Â  Â  const gs=await getCollection('groups');const ms=await getCollection('members');const ps=await getCollection('payments');
Â  Â  const g=gs.find(x=>x.id===gid);if(!g){showToast('âŒ Group not found',false);return;}
Â  Â  const gMs=ms.filter(m=>m.groupIds&&m.groupIds.includes(g.id));
Â  Â  const gPays=ps.filter(p=>p.groupId===gid);
Â  Â  const today=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});
Â  Â  const totalPaid=gPays.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
Â  Â  const totalBal=gPays.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
Â  Â  const totalPicked=gPays.filter(p=>p.chitPicked==='Yes').length;
Â  Â  const totalMonths=parseInt(g.duration||g.gDuration)||21;
Â  Â  let elapsed=0;
Â  Â  if(g.startDate||g.gStart){const _s=new Date(g.startDate||g.gStart),_n=new Date();elapsed=Math.max(0,Math.min(totalMonths,(_n.getFullYear()-_s.getFullYear())*12+(_n.getMonth()-_s.getMonth())+1));}
Â  Â  const left=Math.max(0,totalMonths-elapsed);const pct=Math.min(100,Math.round(elapsed/totalMonths*100));
Â  Â  const allDueDates=getGroupDueDates(g);

Â  Â  // â”€â”€ Member Summary table
Â  Â  const summaryRows=gMs.map((m,i)=>{
Â  Â  Â  Â  const mp=gPays.filter(p=>p.memberId===m.id);
Â  Â  Â  Â  const mPaid=mp.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
Â  Â  Â  Â  const mBal=mp.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
Â  Â  Â  Â  const mPicked=mp.filter(p=>p.chitPicked==='Yes').length;
Â  Â  Â  Â  const monthsCovered=mp.reduce((s,p)=>s+(p.numMonths||1),0);
Â  Â  Â  Â  const lastPay=[...mp].sort((a,b)=>(b.date||'').localeCompare(a.date||''))[0];
Â  Â  Â  Â  return`<tr>
Â  Â  Â  Â  Â  Â  <td>${i+1}</td>
Â  Â  Â  Â  Â  Â  <td><strong>${m.name}</strong>${m.phone?`<br><span style="font-size:9px;color:#888;">${m.phone}</span>`:''}</td>
Â  Â  Â  Â  Â  Â  <td style="color:#065f46;font-weight:700;">â‚¹${mPaid.toLocaleString('en-IN')}</td>
Â  Â  Â  Â  Â  Â  <td style="color:${mBal>0?'#92400e':'#065f46'};font-weight:700;">â‚¹${mBal.toLocaleString('en-IN')}</td>
Â  Â  Â  Â  Â  Â  <td>${mp.length} (${monthsCovered}/${totalMonths} mo.)</td>
Â  Â  Â  Â  Â  Â  <td>${lastPay?fmtDate(lastPay.date):'â€”'}</td>
Â  Â  Â  Â  Â  Â  <td>${mPicked>0?`<span class="pdf-chit-badge">âœ… ${mPicked}x</span>`:'â€”'}</td>
Â  Â  Â  Â  </tr>`;
Â  Â  }).join('');

Â  Â  // â”€â”€ Per-member detailed payment history
Â  Â  const detailSections=gMs.map((m,mi)=>{
Â  Â  Â  Â  const mp=gPays.filter(p=>p.memberId===m.id).sort((a,b)=>(a.date||'').localeCompare(b.date||''));
Â  Â  Â  Â  const mPaid=mp.reduce((s,p)=>s+(parseFloat(p.paid)||0),0);
Â  Â  Â  Â  const mBal=mp.reduce((s,p)=>s+(parseFloat(p.balance)||0),0);
Â  Â  Â  Â  const monthsCovered=mp.reduce((s,p)=>s+(p.numMonths||1),0);

Â  Â  Â  Â  const rows=mp.map((p,idx)=>{
Â  Â  Â  Â  Â  Â  const cp=p.chitPicked==='Yes';
Â  Â  Â  Â  Â  Â  const isMulti=p.numMonths&&p.numMonths>1;
Â  Â  Â  Â  Â  Â  let monthLabel='â€”';
Â  Â  Â  Â  Â  Â  if(isMulti&&p.monthSlots&&p.monthSlots.length>0){
Â  Â  Â  Â  Â  Â  Â  Â  const f=allDueDates[p.monthSlots[0]]?fmtDate(allDueDates[p.monthSlots[0]]):'â€”';
Â  Â  Â  Â  Â  Â  Â  Â  const l=allDueDates[p.monthSlots[p.monthSlots.length-1]]?fmtDate(allDueDates[p.monthSlots[p.monthSlots.length-1]]):'â€”';
Â  Â  Â  Â  Â  Â  Â  Â  monthLabel=`${f} â†’ ${l}`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const slotIdx=p.monthSlot!==undefined?p.monthSlot:getMonthSlot(allDueDates,p.date);
Â  Â  Â  Â  Â  Â  Â  Â  monthLabel=slotIdx>=0&&allDueDates[slotIdx]?fmtDate(allDueDates[slotIdx]):'â€”';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return`<tr class="${cp?'pdf-chit-row':(isMulti?'pdf-multi-row':'')}">
Â  Â  Â  Â  Â  Â  Â  Â  <td>${idx+1}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${monthLabel}${isMulti?`<br><span class="pdf-multi-badge">ğŸ“… ${p.numMonths} months</span>`:''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${fmtDate(p.date)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>â‚¹${(parseFloat(p.chit)||0).toLocaleString('en-IN')}${isMulti?` Ã— ${p.numMonths}`:''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:#065f46;font-weight:700;">â‚¹${(parseFloat(p.paid)||0).toLocaleString('en-IN')}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:${(parseFloat(p.balance)||0)>0?'#92400e':'#065f46'};font-weight:700;">â‚¹${(parseFloat(p.balance)||0).toLocaleString('en-IN')}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${p.paidBy||'â€”'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${cp?`<span class="pdf-chit-badge">âœ… PICKED</span>`:'â€”'}</td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  return`<div style="margin-bottom:18px;page-break-inside:avoid;">
Â  Â  Â  Â  Â  Â  <table style="width:100%;border-collapse:collapse;margin-bottom:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px;font-weight:800;padding:6px 0;">${mi+1}. ${m.name}${m.phone?` <span style="font-size:10px;color:#888;font-weight:400;">Â· ${m.phone}</span>`:''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:right;font-size:10px;color:#555;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Paid: <strong style="color:#065f46;">â‚¹${mPaid.toLocaleString('en-IN')}</strong> &nbsp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Bal: <strong style="color:${mBal>0?'#92400e':'#065f46'};">â‚¹${mBal.toLocaleString('en-IN')}</strong> &nbsp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Months: <strong>${monthsCovered}/${totalMonths}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  ${mp.length===0?`<p style="font-size:10px;color:#999;padding:6px 0;">No payments recorded.</p>`:`
Â  Â  Â  Â  Â  Â  <table class="pdf-table">
Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>#</th><th>Month(s) Covered</th><th>Pay Date</th><th>Chit/Mo</th><th>Paid</th><th>Balance</th><th>Mode</th><th>Chit?</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${rows}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="pdf-total-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td colspan="4"><strong>Subtotal</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><strong>â‚¹${mPaid.toLocaleString('en-IN')}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><strong>â‚¹${mBal.toLocaleString('en-IN')}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td colspan="2"></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  </table>`}
Â  Â  Â  Â  </div>`;
Â  Â  }).join('');

Â  Â  document.getElementById('pdfContent').innerHTML=`
Â  Â  <div class="pdf-page">
Â  Â  Â  Â  <!-- HEADER -->
Â  Â  Â  Â  <div class="pdf-header">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-brand">ğŸ† AK CHIT FUNDS</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-brand-sub">Chit Fund Management Â· Group Report</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-right-title">GROUP STATEMENT</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-right-sub">Generated: ${today}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- GROUP INFO BOX -->
Â  Â  Â  Â  <div class="pdf-member-box">
Â  Â  Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:14px;align-items:flex-start;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex:1;min-width:200px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-member-name">ğŸ“‚ ${g.name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-member-sub">ğŸ“… Duration: <strong>${totalMonths} months</strong> &nbsp;|&nbsp; Start: <strong>${fmtDate(g.startDate||g.gStart||'')}</strong></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-member-sub">ğŸ—“ Monthly Due: <strong>${g.dueDay?`${g.dueDay}${['st','nd','rd'][((g.dueDay%100-11)%10)-1]||'th'} of every month`:'â€”'}</strong></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-member-sub">ğŸ“Š Progress: Month <strong>${elapsed}/${totalMonths}</strong> &nbsp;Â·&nbsp; <strong>${left} months pending</strong></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-progress-outer" style="height:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-progress-inner" style="width:${pct}%;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:9px;color:#888;text-align:right;margin-top:2px;">${pct}% complete</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stats-row" style="gap:8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-val" style="color:#065f46;">â‚¹${totalPaid.toLocaleString('en-IN')}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-lbl">Total Collected</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-val" style="color:#92400e;">â‚¹${totalBal.toLocaleString('en-IN')}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-lbl">Total Balance</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-val">${gMs.length}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-lbl">Members</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-val" style="color:#065f46;">${totalPicked}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pdf-stat-lbl">Chits Picked</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- MEMBER SUMMARY TABLE -->
Â  Â  Â  Â  <div class="pdf-section-title">ğŸ‘¥ Member Summary (${gMs.length} Members)</div>
Â  Â  Â  Â  <table class="pdf-table" style="margin-bottom:20px;">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>#</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Member Name</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Total Paid</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Balance</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Payments (Months)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Last Payment</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Chit Picked</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  ${summaryRows||`<tr><td colspan="7" style="text-align:center;color:#888;padding:12px;">No members in this group</td></tr>`}
Â  Â  Â  Â  Â  Â  Â  Â  <tr class="pdf-total-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td colspan="2"><strong>GRAND TOTAL (${gMs.length} members)</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><strong style="color:#065f46;">â‚¹${totalPaid.toLocaleString('en-IN')}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><strong style="color:${totalBal>0?'#92400e':'#065f46'};">â‚¹${totalBal.toLocaleString('en-IN')}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><strong>${gPays.length} entries</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td colspan="2"><strong>${totalPicked} chit${totalPicked!==1?'s':''} picked</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>

Â  Â  Â  Â  <!-- DETAILED PAYMENT HISTORY -->
Â  Â  Â  Â  <div class="pdf-section-title" style="page-break-before:auto;">ğŸ“‹ Detailed Payment History â€” Member Wise</div>
Â  Â  Â  Â  ${detailSections||'<p style="color:#888;font-size:11px;">No payment records found.</p>'}

Â  Â  Â  Â  <!-- FOOTER -->
Â  Â  Â  Â  <div class="pdf-footer">
Â  Â  Â  Â  Â  Â  <span>AK Chit Funds Â· Admin Portal</span>
Â  Â  Â  Â  Â  Â  <span>Group: <strong>${g.name}</strong> Â· ${today}</span>
Â  Â  Â  Â  Â  Â  <span>CONFIDENTIAL</span>
Â  Â  Â  Â  </div>
Â  Â  </div>`;

Â  Â  await renderPDF(`AKChitFunds_Group_${g.name.replace(/\s+/g,'_')}_Report.pdf`);
Â  Â  showToast('âœ… Group PDF Downloaded!',true);
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('pDate').value=new Date().toISOString().split('T')[0];
setTimeout(migrateData,800);
</script>
</body>
</html> 
